import{_ as n,c as a,f as l,o}from"./app-C-oqqdxG.js";const p={};function e(r,s){return o(),a("div",null,s[0]||(s[0]=[l(`<blockquote><p>ForkJoinPool 是JDK 7加入的一个线程池类。Fork/Join 技术是分治算法(Divide-and-Conquer)的并行实现，它是一项可以获得良好的并行性能的简单且高效的设计技术。目的是为了帮助我们更好地利用多处理器带来的好处，使用所有可用的运算能力来提升应用的性能。</p></blockquote><ul><li>JUC 线程池之 Fork-Join 框架详解 <ul><li><a href="#%E5%B8%A6%E7%9D%80bat%E5%A4%A7%E5%8E%82%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8E%BB%E7%90%86%E8%A7%A3forkjoin%E6%A1%86%E6%9E%B6">带着BAT大厂的面试问题去理解Fork/Join框架</a></li><li>Fork/Join框架简介 <ul><li><a href="#%E4%B8%89%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B3%E7%B3%BB">三个模块及关系</a></li><li><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-%E5%88%86%E6%B2%BB%E7%AE%97%E6%B3%95divide-and-conquer">核心思想: 分治算法(Divide-and-Conquer)</a></li><li><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-work-stealing%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%AE%97%E6%B3%95">核心思想: work-stealing(工作窃取)算法</a></li><li><a href="#forkjoin-%E6%A1%86%E6%9E%B6%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">Fork/Join 框架的执行流程</a></li></ul></li><li>Fork/Join类关系 <ul><li><a href="#forkjoinpool%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB">ForkJoinPool继承关系</a></li><li><a href="#forkjointask%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB">ForkJoinTask继承关系</a></li></ul></li><li>Fork/Join框架源码解析 <ul><li>ForkJoinPool <ul><li><a href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0">核心参数</a></li><li><a href="#forkjoinpoolworkqueue-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7">ForkJoinPool.WorkQueue 中的相关属性</a></li></ul></li><li>ForkJoinTask <ul><li><a href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0-1">核心参数</a></li></ul></li></ul></li><li>Fork/Join框架源码解析 <ul><li><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">构造函数</a></li><li>执行流程 - 外部任务(external/submissions task)提交 <ul><li><a href="#externalpushforkjointask-task">externalPush(ForkJoinTask task)</a></li><li><a href="#externalsubmitforkjointask-task">externalSubmit(ForkJoinTask task)</a></li><li><a href="https://pdai.tech/md/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#signalworkworkqueue-ws-workqueue-q" target="_blank" rel="noopener noreferrer">signalWork(WorkQueue[] ws, WorkQueue q)</a></li><li><a href="#tryaddworkerlong-c">tryAddWorker(long c)</a></li><li><a href="#createworker">createWorker()</a></li><li><a href="#registerworker">registerWorker()</a></li><li><a href="#%E5%B0%8F%E7%BB%93">小结</a></li></ul></li><li>执行流程: 子任务(Worker task)提交 <ul><li><a href="#forkjointaskfork">ForkJoinTask.fork()</a></li><li><a href="#forkjoinpoolworkqueuepush">ForkJoinPool.WorkQueue.push()</a></li><li><a href="#%E5%B0%8F%E7%BB%93-1">小结</a></li></ul></li><li>执行流程: 任务执行 <ul><li><a href="#forkjoinworkerthreadrun">ForkJoinWorkerThread.run()</a></li><li><a href="#forkjoinpoolrunworkerworkqueue-w">ForkJoinPool.runWorker(WorkQueue w)</a></li><li><a href="#forkjoinpoolscanworkqueue-w-int-r">ForkJoinPool.scan(WorkQueue w, int r)</a></li><li><a href="#forkjoinpoolawaitworkworkqueue-w-int-r">ForkJoinPool.awaitWork(WorkQueue w, int r)</a></li><li><a href="#workqueueruntask">WorkQueue.runTask()</a></li><li><a href="#forkjoinpoolderegisterworkerforkjoinworkerthread-wt-throwable-ex">ForkJoinPool.deregisterWorker(ForkJoinWorkerThread wt, Throwable ex)</a></li><li><a href="#%E5%B0%8F%E7%BB%93-2">小结</a></li></ul></li><li>获取任务结果 - ForkJoinTask.join() / ForkJoinTask.invoke() <ul><li><a href="#forkjointaskexternalawaitdone">ForkJoinTask.externalAwaitDone()</a></li><li><a href="#forkjoinpoolawaitjoin">ForkJoinPool.awaitJoin()</a></li><li><a href="#workqueuetryremoveandexecforkjointask-task">WorkQueue.tryRemoveAndExec(ForkJoinTask task)</a></li><li><a href="#forkjoinpoolhelpstealerworkqueue-w-forkjointask-task">ForkJoinPool.helpStealer(WorkQueue w, ForkJoinTask task)</a></li><li><a href="#forkjoinpooltrycompensateworkqueue-w">ForkJoinPool.tryCompensate(WorkQueue w)</a></li></ul></li></ul></li><li>Fork/Join的陷阱与注意事项 <ul><li><a href="#%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84fork">避免不必要的fork()</a></li><li><a href="#%E6%B3%A8%E6%84%8Fforkcomputejoin%E7%9A%84%E9%A1%BA%E5%BA%8F">注意fork()、compute()、join()的顺序</a></li><li><a href="#%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E5%AD%90%E4%BB%BB%E5%8A%A1%E7%B2%92%E5%BA%A6">选择合适的子任务粒度</a></li><li><a href="#%E9%81%BF%E5%85%8D%E9%87%8D%E9%87%8F%E7%BA%A7%E4%BB%BB%E5%8A%A1%E5%88%92%E5%88%86%E4%B8%8E%E7%BB%93%E6%9E%9C%E5%90%88%E5%B9%B6">避免重量级任务划分与结果合并</a></li></ul></li><li>再深入理解 <ul><li><a href="#%E6%9C%89%E5%93%AA%E4%BA%9Bjdk%E6%BA%90%E7%A0%81%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%86forkjoin%E6%80%9D%E6%83%B3">有哪些JDK源码中使用了Fork/Join思想?</a></li><li><a href="#%E4%BD%BF%E7%94%A8executors%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%88%9B%E5%BB%BAforkjoinpool">使用Executors工具类创建ForkJoinPool</a></li><li><a href="#%E5%85%B3%E4%BA%8Eforkjoin%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">关于Fork/Join异常处理</a></li></ul></li><li>一些Fork/Join例子 <ul><li><a href="#%E9%87%87%E7%94%A8forkjoin%E6%9D%A5%E5%BC%82%E6%AD%A5%E8%AE%A1%E7%AE%9712310000%E7%9A%84%E7%BB%93%E6%9E%9C">采用Fork/Join来异步计算1+2+3+…+10000的结果</a></li><li><a href="#%E5%AE%9E%E7%8E%B0%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97">实现斐波那契数列</a></li></ul></li><li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">参考文章</a></li></ul></li></ul><h2 id="带着bat大厂的面试问题去理解fork-join框架" tabindex="-1"><a class="header-anchor" href="#带着bat大厂的面试问题去理解fork-join框架"><span><a href="#%E5%B8%A6%E7%9D%80bat%E5%A4%A7%E5%8E%82%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8E%BB%E7%90%86%E8%A7%A3fork-join%E6%A1%86%E6%9E%B6">#</a> 带着BAT大厂的面试问题去理解Fork/Join框架</span></a></h2><p>提示</p><p>请带着这些问题继续后文，会很大程度上帮助你更好的理解Fork/Join框架。@pdai</p><ul><li>Fork/Join主要用来解决什么样的问题?</li><li>Fork/Join框架是在哪个JDK版本中引入的?</li><li>Fork/Join框架主要包含哪三个模块? 模块之间的关系是怎么样的?</li><li>ForkJoinPool类继承关系?</li><li>ForkJoinTask抽象类继承关系? 在实际运用中，我们一般都会继承 RecursiveTask 、RecursiveAction 或 CountedCompleter 来实现我们的业务需求，而不会直接继承 ForkJoinTask 类。</li><li>整个Fork/Join 框架的执行流程/运行机制是怎么样的?</li><li>具体阐述Fork/Join的分治思想和work-stealing 实现方式?</li><li>有哪些JDK源码中使用了Fork/Join思想?</li><li>如何使用Executors工具类创建ForkJoinPool?</li><li>写一个例子: 用ForkJoin方式实现1+2+3+...+100000?</li><li>Fork/Join在使用时有哪些注意事项? 结合JDK中的斐波那契数列实例具体说明。</li></ul><h2 id="fork-join框架简介" tabindex="-1"><a class="header-anchor" href="#fork-join框架简介"><span><a href="#fork-join%E6%A1%86%E6%9E%B6%E7%AE%80%E4%BB%8B">#</a> Fork/Join框架简介</span></a></h2><p>Fork/Join框架是Java并发工具包中的一种可以将一个大任务拆分为很多小任务来异步执行的工具，自JDK1.7引入。</p><h3 id="三个模块及关系" tabindex="-1"><a class="header-anchor" href="#三个模块及关系"><span><a href="#%E4%B8%89%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B3%E7%B3%BB">#</a> 三个模块及关系</span></a></h3><p>Fork/Join框架主要包含三个模块:</p><ul><li>任务对象: <code>ForkJoinTask</code> (包括<code>RecursiveTask</code>、<code>RecursiveAction</code> 和 <code>CountedCompleter</code>)</li><li>执行Fork/Join任务的线程: <code>ForkJoinWorkerThread</code></li><li>线程池: <code>ForkJoinPool</code></li></ul><p>这三者的关系是: ForkJoinPool可以通过池中的ForkJoinWorkerThread来处理ForkJoinTask任务。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// from 《A Java Fork/Join Framework》Dong Lea</span></span>
<span class="line"><span style="color:#E5C07B;">Result</span><span style="color:#61AFEF;"> solve</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Problem</span><span style="color:#E06C75;"> problem) {</span></span>
<span class="line"><span style="color:#C678DD;">	if</span><span style="color:#E06C75;"> (problem is small)</span></span>
<span class="line"><span style="color:#E06C75;"> 		directly solve problem</span></span>
<span class="line"><span style="color:#C678DD;"> 	else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E06C75;"> 		split problem into independent parts</span></span>
<span class="line"><span style="color:#E06C75;"> 		fork </span><span style="color:#C678DD;">new</span><span style="color:#E06C75;"> subtasks to solve each part</span></span>
<span class="line"><span style="color:#E06C75;"> 		join all subtasks</span></span>
<span class="line"><span style="color:#E06C75;"> 		compose result from subresults</span></span>
<span class="line"><span style="color:#E06C75;">	}</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ForkJoinPool 只接收 ForkJoinTask 任务(在实际使用中，也可以接收 Runnable/Callable 任务，但在真正运行时，也会把这些任务封装成 ForkJoinTask 类型的任务)，RecursiveTask 是 ForkJoinTask 的子类，是一个可以递归执行的 ForkJoinTask，RecursiveAction 是一个无返回值的 RecursiveTask，CountedCompleter 在任务完成执行后会触发执行一个自定义的钩子函数。</p><p>在实际运用中，我们一般都会继承 <code>RecursiveTask</code> 、<code>RecursiveAction</code> 或 <code>CountedCompleter</code> 来实现我们的业务需求，而不会直接继承 ForkJoinTask 类。</p><h3 id="核心思想-分治算法-divide-and-conquer" tabindex="-1"><a class="header-anchor" href="#核心思想-分治算法-divide-and-conquer"><span><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-%E5%88%86%E6%B2%BB%E7%AE%97%E6%B3%95-divide-and-conquer">#</a> 核心思想: 分治算法(Divide-and-Conquer)</span></a></h3><p>分治算法(Divide-and-Conquer)把任务递归的拆分为各个子任务，这样可以更好的利用系统资源，尽可能的使用所有可用的计算能力来提升应用性能。首先看一下 Fork/Join 框架的任务运行机制:</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-2.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li>这里也可以一并看下: <a href="">算法思想 - 分治算法</a></li></ul><h3 id="核心思想-work-stealing-工作窃取-算法" tabindex="-1"><a class="header-anchor" href="#核心思想-work-stealing-工作窃取-算法"><span><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-work-stealing-%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96-%E7%AE%97%E6%B3%95">#</a> 核心思想: work-stealing(工作窃取)算法</span></a></h3><p>work-stealing(工作窃取)算法: 线程池内的所有工作线程都尝试找到并执行已经提交的任务，或者是被其他活动任务创建的子任务(如果不存在就阻塞等待)。这种特性使得 ForkJoinPool 在运行多个可以产生子任务的任务，或者是提交的许多小任务时效率更高。尤其是构建异步模型的 ForkJoinPool 时，对不需要合并(join)的事件类型任务也非常适用。</p><p>在 ForkJoinPool 中，线程池中每个工作线程(ForkJoinWorkerThread)都对应一个任务队列(WorkQueue)，工作线程优先处理来自自身队列的任务(LIFO或FIFO顺序，参数 mode 决定)，然后以FIFO的顺序随机窃取其他队列中的任务。</p><p>具体思路如下:</p><ul><li>每个线程都有自己的一个WorkQueue，该工作队列是一个双端队列。</li><li>队列支持三个功能push、pop、poll</li><li>push/pop只能被队列的所有者线程调用，而poll可以被其他线程调用。</li><li>划分的子任务调用fork时，都会被push到自己的队列中。</li><li>默认情况下，工作线程从自己的双端队列获出任务并执行。</li><li>当自己的队列为空时，线程随机从另一个线程的队列末尾调用poll方法窃取任务。</li></ul><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-3.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="fork-join-框架的执行流程" tabindex="-1"><a class="header-anchor" href="#fork-join-框架的执行流程"><span><a href="#fork-join-%E6%A1%86%E6%9E%B6%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">#</a> Fork/Join 框架的执行流程</span></a></h3><p>上图可以看出ForkJoinPool 中的任务执行分两种:</p><ul><li>直接通过 FJP 提交的外部任务(external/submissions task)，存放在 workQueues 的偶数槽位；</li><li>通过内部 fork 分割的子任务(Worker task)，存放在 workQueues 的奇数槽位。</li></ul><p>那Fork/Join 框架的执行流程是什么样的?</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-5.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><blockquote><p>后续的源码解析将围绕上图进行。</p></blockquote><h2 id="fork-join类关系" tabindex="-1"><a class="header-anchor" href="#fork-join类关系"><span><a href="#fork-join%E7%B1%BB%E5%85%B3%E7%B3%BB">#</a> Fork/Join类关系</span></a></h2><h3 id="forkjoinpool继承关系" tabindex="-1"><a class="header-anchor" href="#forkjoinpool继承关系"><span><a href="#forkjoinpool%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB">#</a> ForkJoinPool继承关系</span></a></h3><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-1.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>内部类介绍:</p><ul><li>ForkJoinWorkerThreadFactory: 内部线程工厂接口，用于创建工作线程ForkJoinWorkerThread</li><li>DefaultForkJoinWorkerThreadFactory: ForkJoinWorkerThreadFactory 的默认实现类</li><li>InnocuousForkJoinWorkerThreadFactory: 实现了 ForkJoinWorkerThreadFactory，无许可线程工厂，当系统变量中有系统安全管理相关属性时，默认使用这个工厂创建工作线程。</li><li>EmptyTask: 内部占位类，用于替换队列中 join 的任务。</li><li>ManagedBlocker: 为 ForkJoinPool 中的任务提供扩展管理并行数的接口，一般用在可能会阻塞的任务(如在 Phaser 中用于等待 phase 到下一个generation)。</li><li>WorkQueue: ForkJoinPool 的核心数据结构，本质上是work-stealing 模式的双端任务队列，内部存放 ForkJoinTask 对象任务，使用 @Contented 注解修饰防止伪共享。 <ul><li>工作线程在运行中产生新的任务(通常是因为调用了 fork())时，此时可以把 WorkQueue 的数据结构视为一个栈，新的任务会放入栈顶(top 位)；工作线程在处理自己工作队列的任务时，按照 LIFO 的顺序。</li><li>工作线程在处理自己的工作队列同时，会尝试窃取一个任务(可能是来自于刚刚提交到 pool 的任务，或是来自于其他工作线程的队列任务)，此时可以把 WorkQueue 的数据结构视为一个 FIFO 的队列，窃取的任务位于其他线程的工作队列的队首(base位)。</li></ul></li><li>伪共享状态: 缓存系统中是以缓存行(cache line)为单位存储的。缓存行是2的整数幂个连续字节，一般为32-256个字节。最常见的缓存行大小是64个字节。当多线程修改互相独立的变量时，如果这些变量共享同一个缓存行，就会无意中影响彼此的性能，这就是伪共享。</li></ul><h3 id="forkjointask继承关系" tabindex="-1"><a class="header-anchor" href="#forkjointask继承关系"><span><a href="#forkjointask%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB">#</a> ForkJoinTask继承关系</span></a></h3><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-4.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ForkJoinTask 实现了 Future 接口，说明它也是一个可取消的异步运算任务，实际上ForkJoinTask 是 Future 的轻量级实现，主要用在纯粹是计算的函数式任务或者操作完全独立的对象计算任务。fork 是主运行方法，用于异步执行；而 join 方法在任务结果计算完毕之后才会运行，用来合并或返回计算结果。 其内部类都比较简单，ExceptionNode 是用于存储任务执行期间的异常信息的单向链表；其余四个类是为 Runnable/Callable 任务提供的适配器类，用于把 Runnable/Callable 转化为 ForkJoinTask 类型的任务(因为 ForkJoinPool 只可以运行 ForkJoinTask 类型的任务)。</p><h2 id="fork-join框架源码解析" tabindex="-1"><a class="header-anchor" href="#fork-join框架源码解析"><span><a href="#fork-join%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">#</a> Fork/Join框架源码解析</span></a></h2><blockquote><p>分析思路: 在对类层次结构有了解以后，我们先看下内部核心参数，然后分析上述流程图。会分4个部分:</p></blockquote><ul><li>首先介绍任务的提交流程 - 外部任务(external/submissions task)提交</li><li>然后介绍任务的提交流程 - 子任务(Worker task)提交</li><li>再分析任务的执行过程(ForkJoinWorkerThread.run()到ForkJoinTask.doExec()这一部分)；</li><li>最后介绍任务的结果获取(ForkJoinTask.join()和ForkJoinTask.invoke())</li></ul><h3 id="forkjoinpool" tabindex="-1"><a class="header-anchor" href="#forkjoinpool"><span><a href="#forkjoinpool">#</a> ForkJoinPool</span></a></h3><h4 id="核心参数" tabindex="-1"><a class="header-anchor" href="#核心参数"><span><a href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0">#</a> 核心参数</span></a></h4><p>在后面的源码解析中，我们会看到大量的位运算，这些位运算都是通过我们接下来介绍的一些常量参数来计算的。</p><p>例如，如果要更新活跃线程数，使用公式(UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; c)；c 代表当前 ctl，UC_MASK 和 SP_MASK 分别是高位和低位掩码，AC_UNIT 为活跃线程的增量数，使用(UC_MASK &amp; (c + AC_UNIT))就可以计算出高32位，然后再加上低32位(SP_MASK &amp; c)，就拼接成了一个新的ctl。</p><p>这些运算的可读性很差，看起来有些复杂。在后面源码解析中有位运算的地方我都会加上注释，大家只需要了解它们的作用即可。</p><p>ForkJoinPool 与 内部类 WorkQueue 共享的一些常量:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// Constants shared across ForkJoinPool and WorkQueue</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 限定参数</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SMASK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xffff</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">        //  低位掩码，也是最大索引位</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> MAX_CAP </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x7fff</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">        //  工作线程最大容量</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> EVENMASK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xfffe</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">        //  偶数低位掩码</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SQMASK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x007e</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">        //  workQueues 数组最多64个槽位</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// ctl 子域和 WorkQueue.scanState 的掩码和标志位</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SCANNING </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">             // 标记是否正在运行任务</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> INACTIVE </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 31</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">       // 失活状态  负数</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SS_SEQ </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 16</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">       // 版本戳，防止ABA问题</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// ForkJoinPool.config 和 WorkQueue.config 的配置信息标记</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> MODE_MASK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xffff</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 16</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // 模式掩码</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> LIFO_QUEUE </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //LIFO队列</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> FIFO_QUEUE </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 16</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//FIFO队列</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SHARED_QUEUE </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 31</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">       // 共享模式队列，负数</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ForkJoinPool 中的相关常量和实例字段:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//  低位和高位掩码</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> SP_MASK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xffffffffL</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> UC_MASK </span><span style="color:#56B6C2;">=</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">SP_MASK</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 活跃线程数</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> AC_SHIFT </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 48</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> AC_UNIT </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x0001L</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#E06C75;"> AC_SHIFT</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //活跃线程数增量</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> AC_MASK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xffffL</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#E06C75;"> AC_SHIFT</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //活跃线程数掩码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 工作线程数</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> TC_SHIFT </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 32</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> TC_UNIT </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x0001L</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#E06C75;"> TC_SHIFT</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //工作线程数增量</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> TC_MASK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xffffL</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#E06C75;"> TC_SHIFT</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //掩码</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> ADD_WORKER </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x0001L</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#E06C75;"> (TC_SHIFT </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 15</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // 创建工作线程标志</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 池状态</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> RSLOCK </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> RSIGNAL </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> STARTED </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> STOP </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 29</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> TERMINATED </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 30</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SHUTDOWN </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 31</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 实例字段</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> ctl</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                   // 主控制参数</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> runState</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">               // 运行状态锁</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> config</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                    // 并行度|模式</span></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> indexSeed</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                       // 用于生成工作线程索引</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#E5C07B;"> WorkQueue</span><span style="color:#E06C75;">[] workQueues</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">     // 主对象注册信息，workQueue</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> ForkJoinWorkerThreadFactory</span><span style="color:#E06C75;"> factory</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">// 线程工厂</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> UncaughtExceptionHandler</span><span style="color:#E06C75;"> ueh</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // 每个工作线程的异常信息</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> workerNamePrefix</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">       // 用于创建工作线程的名称</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#E5C07B;"> AtomicLong</span><span style="color:#E06C75;"> stealCounter</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">    // 偷取任务总数，也可作为同步监视器</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">/** 静态初始化字段 */</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//线程工厂</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> ForkJoinWorkerThreadFactory</span><span style="color:#E06C75;"> defaultForkJoinWorkerThreadFactory</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//启动或杀死线程的方法调用者的权限</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> RuntimePermission</span><span style="color:#E06C75;"> modifyThreadPermission</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 公共静态pool</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> ForkJoinPool</span><span style="color:#E06C75;"> common</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//并行度，对应内部common池</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> commonParallelism</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//备用线程数，在tryCompensate中使用</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> commonMaxSpares</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//创建workerNamePrefix(工作线程名称前缀)时的序号</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> poolNumberSequence</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//线程阻塞等待新的任务的超时值(以纳秒为单位)，默认2秒</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> IDLE_TIMEOUT </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 2000L</span><span style="color:#56B6C2;"> *</span><span style="color:#D19A66;"> 1000L</span><span style="color:#56B6C2;"> *</span><span style="color:#D19A66;"> 1000L</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 2sec</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//空闲超时时间，防止timer未命中</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> TIMEOUT_SLOP </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 20L</span><span style="color:#56B6C2;"> *</span><span style="color:#D19A66;"> 1000L</span><span style="color:#56B6C2;"> *</span><span style="color:#D19A66;"> 1000L</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // 20ms</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//默认备用线程数</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> DEFAULT_COMMON_MAX_SPARES </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 256</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//阻塞前自旋的次数，用在在awaitRunStateLock和awaitWork中</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SPINS  </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//indexSeed的增量</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SEED_INCREMENT </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x9e3779b9</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: ForkJoinPool 的内部状态都是通过一个64位的 long 型 变量ctl来存储，它由四个16位的子域组成:</p><ul><li>AC: 正在运行工作线程数减去目标并行度，高16位</li><li>TC: 总工作线程数减去目标并行度，中高16位</li><li>SS: 栈顶等待线程的版本计数和状态，中低16位</li><li>ID: 栈顶 WorkQueue 在池中的索引(poolIndex)，低16位</li></ul><p>在后面的源码解析中，某些地方也提取了ctl的低32位(sp=(int)ctl)来检查工作线程状态，例如，当sp不为0时说明当前还有空闲工作线程。</p><h4 id="forkjoinpool-workqueue-中的相关属性" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-workqueue-中的相关属性"><span><a href="#forkjoinpool-workqueue-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7">#</a> ForkJoinPool.WorkQueue 中的相关属性:</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//初始队列容量，2的幂</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> INITIAL_QUEUE_CAPACITY </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 13</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//最大队列容量</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> MAXIMUM_QUEUE_CAPACITY </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 26</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 64M</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 实例字段</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> scanState</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">    // Woker状态, &lt;0: inactive; odd:scanning</span></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> stackPred</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">             // 记录前一个栈顶的ctl</span></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> nsteals</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">               // 偷取任务数</span></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> hint</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                  // 记录偷取者索引，初始为随机索引</span></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> config</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                // 池索引和模式</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> qlock</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">        // 1: locked, &lt; 0: terminate; else 0</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> base</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">         //下一个poll操作的索引(栈底/队列头)</span></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> top</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                   //  下一个push操作的索引(栈顶/队列尾)</span></span>
<span class="line"><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] array</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">   // 任务数组</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> ForkJoinPool</span><span style="color:#E06C75;"> pool</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">   // the containing pool (may be null)</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> ForkJoinWorkerThread</span><span style="color:#E06C75;"> owner</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 当前工作队列的工作线程，共享模式下为null</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#E5C07B;"> Thread</span><span style="color:#E06C75;"> parker</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">    // 调用park阻塞期间为owner，其他情况为null</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> currentJoin</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // 记录被join过来的任务</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> currentSteal</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 记录从其他工作队列偷取过来的任务</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="forkjointask" tabindex="-1"><a class="header-anchor" href="#forkjointask"><span><a href="#forkjointask">#</a> ForkJoinTask</span></a></h3><h4 id="核心参数-1" tabindex="-1"><a class="header-anchor" href="#核心参数-1"><span><a href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0-1">#</a> 核心参数</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">/** 任务运行状态 */</span></span>
<span class="line"><span style="color:#C678DD;">volatile</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> status</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 任务运行状态</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> DONE_MASK   </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xf0000000</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // 任务完成状态标志位</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> NORMAL      </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xf0000000</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // must be negative</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> CANCELLED   </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0xc0000000</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // must be &lt; NORMAL</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> EXCEPTIONAL </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x80000000</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // must be &lt; CANCELLED</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SIGNAL      </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x00010000</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // must be &gt;= 1 &lt;&lt; 16 等待信号</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> SMASK       </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0x0000ffff</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  //  低位掩码</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="fork-join框架源码解析-1" tabindex="-1"><a class="header-anchor" href="#fork-join框架源码解析-1"><span><a href="#fork-join%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-1">#</a> Fork/Join框架源码解析</span></a></h2><h3 id="构造函数" tabindex="-1"><a class="header-anchor" href="#构造函数"><span><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">#</a> 构造函数</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#61AFEF;"> ForkJoinPool</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> parallelism</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                    ForkJoinWorkerThreadFactory</span><span style="color:#E06C75;"> factory</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                    UncaughtExceptionHandler</span><span style="color:#E06C75;"> handler</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#C678DD;">                    boolean</span><span style="color:#E06C75;"> asyncMode) {</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#E06C75;">(</span><span style="color:#61AFEF;">checkParallelism</span><span style="color:#E06C75;">(parallelism)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#61AFEF;">            checkFactory</span><span style="color:#E06C75;">(factory)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">            handler</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">            asyncMode </span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> FIFO_QUEUE </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> LIFO_QUEUE</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;">            &quot;ForkJoinPool-&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#61AFEF;"> nextPoolId</span><span style="color:#E06C75;">() </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot;-worker-&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    checkPermission</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 在 ForkJoinPool 中我们可以自定义四个参数:</p><ul><li>parallelism: 并行度，默认为CPU数，最小为1</li><li>factory: 工作线程工厂；</li><li>handler: 处理工作线程运行任务时的异常情况类，默认为null；</li><li>asyncMode: 是否为异步模式，默认为 false。如果为true，表示子任务的执行遵循 FIFO 顺序并且任务不能被合并(join)，这种模式适用于工作线程只运行事件类型的异步任务。</li></ul><p>在多数场景使用时，如果没有太强的业务需求，我们一般直接使用 ForkJoinPool 中的common池，在JDK1.8之后提供了ForkJoinPool.commonPool()方法可以直接使用common池，来看一下它的构造:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> ForkJoinPool</span><span style="color:#61AFEF;"> makeCommonPool</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> parallelism </span><span style="color:#56B6C2;">=</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinWorkerThreadFactory</span><span style="color:#E06C75;"> factory </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    UncaughtExceptionHandler</span><span style="color:#E06C75;"> handler </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {  </span><span style="color:#7F848E;font-style:italic;">// ignore exceptions in accessing/parsing</span></span>
<span class="line"><span style="color:#E5C07B;">        String</span><span style="color:#E06C75;"> pp </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">getProperty</span></span>
<span class="line"><span style="color:#E06C75;">                (</span><span style="color:#98C379;">&quot;java.util.concurrent.ForkJoinPool.common.parallelism&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//并行度</span></span>
<span class="line"><span style="color:#E5C07B;">        String</span><span style="color:#E06C75;"> fp </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">getProperty</span></span>
<span class="line"><span style="color:#E06C75;">                (</span><span style="color:#98C379;">&quot;java.util.concurrent.ForkJoinPool.common.threadFactory&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//线程工厂</span></span>
<span class="line"><span style="color:#E5C07B;">        String</span><span style="color:#E06C75;"> hp </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">getProperty</span></span>
<span class="line"><span style="color:#E06C75;">                (</span><span style="color:#98C379;">&quot;java.util.concurrent.ForkJoinPool.common.exceptionHandler&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//异常处理类</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (pp </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">            parallelism </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Integer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">parseInt</span><span style="color:#ABB2BF;">(pp);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (fp </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">            factory </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((ForkJoinWorkerThreadFactory) ClassLoader</span><span style="color:#ABB2BF;">.</span></span>
<span class="line"><span style="color:#61AFEF;">                    getSystemClassLoader</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">loadClass</span><span style="color:#ABB2BF;">(fp).</span><span style="color:#61AFEF;">newInstance</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (hp </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">            handler </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((UncaughtExceptionHandler) ClassLoader</span><span style="color:#ABB2BF;">.</span></span>
<span class="line"><span style="color:#61AFEF;">                    getSystemClassLoader</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">loadClass</span><span style="color:#ABB2BF;">(hp).</span><span style="color:#61AFEF;">newInstance</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Exception</span><span style="color:#E06C75;font-style:italic;"> ignore</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (factory </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getSecurityManager</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">            factory </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> defaultForkJoinWorkerThreadFactory</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#7F848E;font-style:italic;"> // use security-managed default</span></span>
<span class="line"><span style="color:#E06C75;">            factory </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> InnocuousForkJoinWorkerThreadFactory</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (parallelism </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#7F848E;font-style:italic;"> // default 1 less than #cores</span></span>
<span class="line"><span style="color:#E06C75;">            (parallelism </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Runtime</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getRuntime</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">availableProcessors</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">        parallelism </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//默认并行度为1</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (parallelism </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> MAX_CAP)</span></span>
<span class="line"><span style="color:#E06C75;">        parallelism </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> MAX_CAP</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ForkJoinPool</span><span style="color:#E06C75;">(parallelism</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> factory</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> handler</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> LIFO_QUEUE</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;">            &quot;ForkJoinPool.commonPool-worker-&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用common pool的优点就是我们可以通过指定系统参数的方式定义“并行度、线程工厂和异常处理类”；并且它使用的是同步模式，也就是说可以支持任务合并(join)。</p><h3 id="执行流程-外部任务-external-submissions-task-提交" tabindex="-1"><a class="header-anchor" href="#执行流程-外部任务-external-submissions-task-提交"><span><a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E5%A4%96%E9%83%A8%E4%BB%BB%E5%8A%A1-external-submissions-task-%E6%8F%90%E4%BA%A4">#</a> 执行流程 - 外部任务(external/submissions task)提交</span></a></h3><p>向 ForkJoinPool 提交任务有三种方式:</p><ul><li>invoke()会等待任务计算完毕并返回计算结果；</li><li>execute()是直接向池提交一个任务来异步执行，无返回结果；</li><li>submit()也是异步执行，但是会返回提交的任务，在适当的时候可通过task.get()获取执行结果。</li></ul><p>这三种提交方式都都是调用externalPush()方法来完成，所以接下来我们将从externalPush()方法开始逐步分析外部任务的执行过程。</p><h4 id="externalpush-forkjointask-task" tabindex="-1"><a class="header-anchor" href="#externalpush-forkjointask-task"><span><a href="#externalpush-forkjointask-task">#</a> externalPush(ForkJoinTask&lt;?&gt; task)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//添加给定任务到submission队列中</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> externalPush</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task) {</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;"> q</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ThreadLocalRandom</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getProbe</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;">//探针值，用于计算WorkQueue槽位索引</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> runState</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (m </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">            (q </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[m </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SQMASK]) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#7F848E;font-style:italic;"> //获取随机偶数槽位的workQueue</span></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(q, QLOCK, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//锁定workQueue</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> am</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((a </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                (am </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">-</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#E06C75;">)) {</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((am </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> s) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//计算任务索引位置</span></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(a, j, task);</span><span style="color:#7F848E;font-style:italic;">//任务入列</span></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(q, QTOP, s </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">//更新push slot</span></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putIntVolatile</span><span style="color:#ABB2BF;">(q, QLOCK, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">//解除锁定</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#61AFEF;">                signalWork</span><span style="color:#E06C75;">(ws</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> q)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//任务数小于1时尝试创建或激活一个工作线程</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E5C07B;">        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(q, QLOCK, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">//解除锁定</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#61AFEF;">    externalSubmit</span><span style="color:#E06C75;">(task)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//初始化workQueues及相关属性</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先说明一下externalPush和externalSubmit两个方法的联系: 它们的作用都是把任务放到队列中等待执行。不同的是，externalSubmit可以说是完整版的externalPush，在任务首次提交时，需要初始化workQueues及其他相关属性，这个初始化操作就是externalSubmit来完成的；而后再向池中提交的任务都是通过简化版的externalSubmit-externalPush来完成。</p><p>externalPush的执行流程很简单: 首先找到一个随机偶数槽位的 workQueue，然后把任务放入这个 workQueue 的任务数组中，并更新top位。如果队列的剩余任务数小于1，则尝试创建或激活一个工作线程来运行任务(防止在externalSubmit初始化时发生异常导致工作线程创建失败)。</p><h4 id="externalsubmit-forkjointask-task" tabindex="-1"><a class="header-anchor" href="#externalsubmit-forkjointask-task"><span><a href="#externalsubmit-forkjointask-task">#</a> externalSubmit(ForkJoinTask&lt;?&gt; task)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//任务提交</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> externalSubmit</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //初始化调用线程的探针值，用于计算WorkQueue索引</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> r</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                                    // initialize caller&#39;s probe</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((r </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ThreadLocalRandom</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getProbe</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        ThreadLocalRandom</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">localInit</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">        r </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ThreadLocalRandom</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getProbe</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {</span></span>
<span class="line"><span style="color:#E5C07B;">        WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">        WorkQueue</span><span style="color:#E06C75;"> q</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> k</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        boolean</span><span style="color:#E06C75;"> move </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((rs </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> runState) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">// 池已关闭</span></span>
<span class="line"><span style="color:#61AFEF;">            tryTerminate</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">     // help terminate</span></span>
<span class="line"><span style="color:#C678DD;">            throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> RejectedExecutionException</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //初始化workQueues</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> STARTED) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#7F848E;font-style:italic;">     // initialize</span></span>
<span class="line"><span style="color:#E06C75;">                ((ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)) {</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> ns </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            rs </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> lockRunState</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//锁定runState</span></span>
<span class="line"><span style="color:#C678DD;">            try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //初始化</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> STARTED) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    //初始化stealCounter</span></span>
<span class="line"><span style="color:#E5C07B;">                    U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, STEALCOUNTER, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#C678DD;">                            new</span><span style="color:#61AFEF;"> AtomicLong</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    //创建workQueues，容量为2的幂次方</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // create workQueues array with size a power of two</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> config </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SMASK</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // ensure at least 2 slots</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (p </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#C678DD;"> :</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    n </span><span style="color:#56B6C2;">|=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    n </span><span style="color:#56B6C2;">|=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    n </span><span style="color:#56B6C2;">|=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 4</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    n </span><span style="color:#56B6C2;">|=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 8</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    n </span><span style="color:#56B6C2;">|=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 16</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    workQueues </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> WorkQueue</span><span style="color:#E06C75;">[n]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    ns </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> STARTED</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">                unlockRunState</span><span style="color:#E06C75;">(rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> (rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">RSLOCK) </span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> ns)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//解锁并更新runState</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((q </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[k </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SQMASK]) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//获取随机偶数槽位的workQueue</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">qlock</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(q, QLOCK, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//锁定 workQueue</span></span>
<span class="line"><span style="color:#E5C07B;">                ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//当前workQueue的全部任务</span></span>
<span class="line"><span style="color:#C678DD;">                int</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                boolean</span><span style="color:#E06C75;"> submitted </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // initial submission or resizing</span></span>
<span class="line"><span style="color:#C678DD;">                try</span><span style="color:#E06C75;"> {                      </span><span style="color:#7F848E;font-style:italic;">// locked version of push</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> ((a </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> -</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#E06C75;">                            (a </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">growArray</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//扩容</span></span>
<span class="line"><span style="color:#C678DD;">                        int</span><span style="color:#E06C75;"> j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (((</span><span style="color:#E5C07B;">a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> s) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(a, j, task);</span><span style="color:#7F848E;font-style:italic;">//放入给定任务</span></span>
<span class="line"><span style="color:#E5C07B;">                        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(q, QTOP, s </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">//修改push slot</span></span>
<span class="line"><span style="color:#E06C75;">                        submitted </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">                    U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(q, QLOCK, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">//解除锁定</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (submitted) {</span><span style="color:#7F848E;font-style:italic;">//任务提交成功，创建或激活工作线程</span></span>
<span class="line"><span style="color:#61AFEF;">                    signalWork</span><span style="color:#E06C75;">(ws</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> q)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//创建或激活一个工作线程来运行任务</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">            move </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                   // move on failure 操作失败，重新获取探针值</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (((rs </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> runState) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> RSLOCK) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) { </span><span style="color:#7F848E;font-style:italic;">// create new queue</span></span>
<span class="line"><span style="color:#E06C75;">            q </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> WorkQueue</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hint</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> r</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">config</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> SHARED_QUEUE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> INACTIVE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            rs </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> lockRunState</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">           // publish index</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (rs </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                    k </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> ws[k] </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                ws[k] </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> q</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                 // 更新索引k位值的workQueue</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //else terminated</span></span>
<span class="line"><span style="color:#61AFEF;">            unlockRunState</span><span style="color:#E06C75;">(rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">RSLOCK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span></span>
<span class="line"><span style="color:#E06C75;">            move </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                   // move if busy</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (move)</span></span>
<span class="line"><span style="color:#E06C75;">            r </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ThreadLocalRandom</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">advanceProbe</span><span style="color:#ABB2BF;">(r);</span><span style="color:#7F848E;font-style:italic;">//重新获取线程探针值</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: externalSubmit是externalPush的完整版本，主要用于第一次提交任务时初始化workQueues及相关属性，并且提交给定任务到队列中。具体执行步骤如下:</p><ul><li>如果池为终止状态(runState&lt;0)，调用tryTerminate来终止线程池，并抛出任务拒绝异常；</li><li>如果尚未初始化，就为 FJP 执行初始化操作: 初始化stealCounter、创建workerQueues，然后继续自旋；</li><li>初始化完成后，执行在externalPush中相同的操作: 获取 workQueue，放入指定任务。任务提交成功后调用signalWork方法创建或激活线程；</li><li>如果在步骤3中获取到的 workQueue 为null，会在这一步中创建一个 workQueue，创建成功继续自旋执行第三步操作；</li><li>如果非上述情况，或者有线程争用资源导致获取锁失败，就重新获取线程探针值继续自旋。</li></ul><h4 id="signalwork-workqueue-ws-workqueue-q" tabindex="-1"><a class="header-anchor" href="#signalwork-workqueue-ws-workqueue-q"><span><a href="#signalwork-workqueue-ws-workqueue-q">#</a> signalWork(WorkQueue[] ws, WorkQueue q)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> signalWork</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> WorkQueue</span><span style="color:#E06C75;"> q) {</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> sp</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Thread</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    while</span><span style="color:#E06C75;"> ((c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">) {                       </span><span style="color:#7F848E;font-style:italic;">// too few active</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((sp </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) c) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {                  </span><span style="color:#7F848E;font-style:italic;">// no idle workers</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((c </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> ADD_WORKER) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">)            </span><span style="color:#7F848E;font-style:italic;">// too few workers</span></span>
<span class="line"><span style="color:#61AFEF;">                tryAddWorker</span><span style="color:#E06C75;">(c)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//工作线程太少，添加新的工作线程</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (ws </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)                            </span><span style="color:#7F848E;font-style:italic;">// unstarted/terminated</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &lt;=</span><span style="color:#E06C75;"> (i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> sp </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SMASK))         </span><span style="color:#7F848E;font-style:italic;">// terminated</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((v </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[i]) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)                   </span><span style="color:#7F848E;font-style:italic;">// terminating</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //计算ctl，加上版本戳SS_SEQ避免ABA问题</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> vs </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (sp </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> SS_SEQ) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">INACTIVE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">        // next scanState</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> d </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> sp </span><span style="color:#56B6C2;">-</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                  // screen CAS</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)</span></span>
<span class="line"><span style="color:#C678DD;">        long</span><span style="color:#E06C75;"> nc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (UC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> AC_UNIT)) </span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> (SP_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">stackPred</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (d </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, nc)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> vs</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                      // activate v</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((p </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">parker</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unpark</span><span style="color:#ABB2BF;">(p);</span><span style="color:#7F848E;font-style:italic;">//唤醒阻塞线程</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (q </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#56B6C2;"> ==</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#E06C75;">)          </span><span style="color:#7F848E;font-style:italic;">// no more work</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 新建或唤醒一个工作线程，在externalPush、externalSubmit、workQueue.push、scan中调用。如果还有空闲线程，则尝试唤醒索引到的 WorkQueue 的parker线程；如果工作线程过少((ctl &amp; ADD_WORKER) != 0L)，则调用tryAddWorker添加一个新的工作线程。</p><h4 id="tryaddworker-long-c" tabindex="-1"><a class="header-anchor" href="#tryaddworker-long-c"><span><a href="#tryaddworker-long-c">#</a> tryAddWorker(long c)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> tryAddWorker</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> c) {</span></span>
<span class="line"><span style="color:#C678DD;">    boolean</span><span style="color:#E06C75;"> add </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    do</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        long</span><span style="color:#E06C75;"> nc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((AC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> AC_UNIT)) </span><span style="color:#56B6C2;">|</span></span>
<span class="line"><span style="color:#E06C75;">                   (TC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> TC_UNIT)))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (ctl </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> c) {</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> stop</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                 // check if terminating</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((stop </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (rs </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> lockRunState</span><span style="color:#E06C75;">()) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> STOP) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                add </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, nc);</span></span>
<span class="line"><span style="color:#61AFEF;">            unlockRunState</span><span style="color:#E06C75;">(rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">RSLOCK)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//释放锁</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (stop </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (add) {</span></span>
<span class="line"><span style="color:#61AFEF;">                createWorker</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//创建工作线程</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">while</span><span style="color:#E06C75;"> (((c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> ADD_WORKER) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0L</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">)c </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 尝试添加一个新的工作线程，首先更新ctl中的工作线程数，然后调用createWorker()创建工作线程。</p><h4 id="createworker" tabindex="-1"><a class="header-anchor" href="#createworker"><span><a href="#createworker">#</a> createWorker()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> boolean</span><span style="color:#61AFEF;"> createWorker</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinWorkerThreadFactory</span><span style="color:#E06C75;"> fac </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> factory</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Throwable</span><span style="color:#E06C75;"> ex </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinWorkerThread</span><span style="color:#E06C75;"> wt </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (fac </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (wt </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> fac</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">newThread</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            wt</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">start</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> rex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">        ex </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> rex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#61AFEF;">    deregisterWorker</span><span style="color:#E06C75;">(wt</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ex)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//线程创建失败处理</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: createWorker首先通过线程工厂创一个新的ForkJoinWorkerThread，然后启动这个工作线程(wt.start())。如果期间发生异常，调用deregisterWorker处理线程创建失败的逻辑(deregisterWorker在后面再详细说明)。</p><p>ForkJoinWorkerThread 的构造函数如下:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">protected</span><span style="color:#61AFEF;"> ForkJoinWorkerThread</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinPool</span><span style="color:#E06C75;"> pool) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Use a placeholder until a useful name can be set in registerWorker</span></span>
<span class="line"><span style="color:#E5C07B;">    super</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;aForkJoinWorkerThread&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">pool</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> pool</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workQueue</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> pool</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerWorker</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到 ForkJoinWorkerThread 在构造时首先调用父类 Thread 的方法，然后为工作线程注册pool和workQueue，而workQueue的注册任务由ForkJoinPool.registerWorker来完成。</p><h4 id="registerworker" tabindex="-1"><a class="header-anchor" href="#registerworker"><span><a href="#registerworker">#</a> registerWorker()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> WorkQueue</span><span style="color:#61AFEF;"> registerWorker</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinWorkerThread</span><span style="color:#E06C75;"> wt) {</span></span>
<span class="line"><span style="color:#E5C07B;">    UncaughtExceptionHandler</span><span style="color:#E06C75;"> handler</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //设置为守护线程</span></span>
<span class="line"><span style="color:#E5C07B;">    wt</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setDaemon</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">                           // configure thread</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((handler </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ueh) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">        wt</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setUncaughtExceptionHandler</span><span style="color:#ABB2BF;">(handler);</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;"> w </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> WorkQueue</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> wt)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//构造新的WorkQueue</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                                    // assign a pool index</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> mode </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> config </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> MODE_MASK</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> lockRunState</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                    // skip if no array</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //生成新建WorkQueue的索引</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> indexSeed </span><span style="color:#56B6C2;">+=</span><span style="color:#E06C75;"> SEED_INCREMENT</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // unlikely to collide</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> m </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">|</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">               // Worker任务放在奇数索引位 odd-numbered indices</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (ws[i] </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {                  </span><span style="color:#7F848E;font-style:italic;">// collision 已存在，重新计算索引位</span></span>
<span class="line"><span style="color:#C678DD;">                int</span><span style="color:#E06C75;"> probes </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                   // step by approx half n</span></span>
<span class="line"><span style="color:#C678DD;">                int</span><span style="color:#E06C75;"> step </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 4</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#D19A66;"> 2</span><span style="color:#C678DD;"> :</span><span style="color:#E06C75;"> ((n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> EVENMASK) </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //查找可用的索引位</span></span>
<span class="line"><span style="color:#C678DD;">                while</span><span style="color:#E06C75;"> (ws[i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (i </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> step) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m] </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">++</span><span style="color:#E06C75;">probes </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> n) {</span><span style="color:#7F848E;font-style:italic;">//所有索引位都被占用，对workQueues进行扩容</span></span>
<span class="line"><span style="color:#E06C75;">                        workQueues </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Arrays</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">copyOf</span><span style="color:#ABB2BF;">(ws, n </span><span style="color:#56B6C2;">&lt;&lt;=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">//workQueues 扩容</span></span>
<span class="line"><span style="color:#E06C75;">                        m </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        probes </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E5C07B;">            w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hint</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                           // use as random seed</span></span>
<span class="line"><span style="color:#E5C07B;">            w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">config</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> mode</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                      // publication fence</span></span>
<span class="line"><span style="color:#E06C75;">            ws[i] </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">        unlockRunState</span><span style="color:#E06C75;">(rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">RSLOCK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    wt</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setName</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">workerNamePrefix</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">concat</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Integer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toString</span><span style="color:#ABB2BF;">(i </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">)));</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: registerWorker是 ForkJoinWorkerThread 构造器的回调函数，用于创建和记录工作线程的 WorkQueue。比较简单，就不多赘述了。注意在此为工作线程创建的 WorkQueue 是放在奇数索引的(代码行: i = ((s &lt;&lt; 1) | 1) &amp; m;)</p><h4 id="小结" tabindex="-1"><a class="header-anchor" href="#小结"><span><a href="#%E5%B0%8F%E7%BB%93">#</a> 小结</span></a></h4><p>OK，外部任务的提交流程就先讲到这里。在createWorker()中启动工作线程后(wt.start())，当为线程分配到CPU执行时间片之后会运行 ForkJoinWorkerThread 的run方法开启线程来执行任务。工作线程执行任务的流程我们在讲完内部任务提交之后会统一讲解。</p><h3 id="执行流程-子任务-worker-task-提交" tabindex="-1"><a class="header-anchor" href="#执行流程-子任务-worker-task-提交"><span><a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E5%AD%90%E4%BB%BB%E5%8A%A1-worker-task-%E6%8F%90%E4%BA%A4">#</a> 执行流程: 子任务(Worker task)提交</span></a></h3><p>子任务的提交相对比较简单，由任务的fork()方法完成。通过上面的流程图可以看到任务被分割(fork)之后调用了ForkJoinPool.WorkQueue.push()方法直接把任务放到队列中等待被执行。</p><h4 id="forkjointask-fork" tabindex="-1"><a class="header-anchor" href="#forkjointask-fork"><span><a href="#forkjointask-fork">#</a> ForkJoinTask.fork()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> fork</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">    Thread</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((t </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> ForkJoinWorkerThread)</span></span>
<span class="line"><span style="color:#E06C75;">        ((ForkJoinWorkerThread)t)</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workQueue</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    else</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinPool</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">common</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">externalPush</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 如果当前线程是 Worker 线程，说明当前任务是fork分割的子任务，通过ForkJoinPool.workQueue.push()方法直接把任务放到自己的等待队列中；否则调用ForkJoinPool.externalPush()提交到一个随机的等待队列中(外部任务)。</p><h4 id="forkjoinpool-workqueue-push" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-workqueue-push"><span><a href="#forkjoinpool-workqueue-push">#</a> ForkJoinPool.WorkQueue.push()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> push</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task) {</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinPool</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> b </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> base</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> top</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((a </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> array) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {    </span><span style="color:#7F848E;font-style:italic;">// ignore if queue removed</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">     // fenced write for task visibility</span></span>
<span class="line"><span style="color:#E5C07B;">        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(a, ((m </span><span style="color:#56B6C2;">&amp;</span><span style="color:#ABB2BF;"> s) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#ABB2BF;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#ABB2BF;"> ABASE, task);</span></span>
<span class="line"><span style="color:#E5C07B;">        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, QTOP, s </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> b) </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//首次提交，创建或唤醒一个工作线程</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((p </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> pool) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                p</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">signalWork</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workQueues</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> m)</span></span>
<span class="line"><span style="color:#61AFEF;">            growArray</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 首先把任务放入等待队列并更新top位；如果当前 WorkQueue 为新建的等待队列(top-base&lt;=1)，则调用signalWork方法为当前 WorkQueue 新建或唤醒一个工作线程；如果 WorkQueue 中的任务数组容量过小，则调用growArray()方法对其进行两倍扩容，growArray()方法源码如下:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[] </span><span style="color:#61AFEF;">growArray</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] oldA </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> array</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//获取内部任务列表</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> size </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> oldA </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#C678DD;"> ?</span><span style="color:#E5C07B;"> oldA</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#C678DD;"> :</span><span style="color:#E06C75;"> INITIAL_QUEUE_CAPACITY</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (size </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> MAXIMUM_QUEUE_CAPACITY)</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> RejectedExecutionException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;Queue capacity exceeded&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> oldMask</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //新建一个两倍容量的任务数组</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> array </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[size]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (oldA </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (oldMask </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> oldA</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">            (t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> top) </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> (b </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> base) </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> mask </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> size </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //从老数组中拿出数据，放到新的数组中</span></span>
<span class="line"><span style="color:#C678DD;">        do</span><span style="color:#E06C75;"> { </span><span style="color:#7F848E;font-style:italic;">// emulate poll from old array, push to new array</span></span>
<span class="line"><span style="color:#E5C07B;">            ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> oldj </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((b </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> oldMask) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((b </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> mask) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            x </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">) </span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObjectVolatile</span><span style="color:#ABB2BF;">(oldA, oldj);</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (x </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E5C07B;">                    U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(oldA, oldj, x, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putObjectVolatile</span><span style="color:#ABB2BF;">(a, j, x);</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">while</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">++</span><span style="color:#E06C75;">b </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> t)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="小结-1" tabindex="-1"><a class="header-anchor" href="#小结-1"><span><a href="#%E5%B0%8F%E7%BB%93-1">#</a> 小结</span></a></h4><p>到此，两种任务的提交流程都已经解析完毕，下一节我们来一起看看任务提交之后是如何被运行的。</p><h3 id="执行流程-任务执行" tabindex="-1"><a class="header-anchor" href="#执行流程-任务执行"><span><a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C">#</a> 执行流程: 任务执行</span></a></h3><p>回到我们开始时的流程图，在ForkJoinPool .createWorker()方法中创建工作线程后，会启动工作线程，系统为工作线程分配到CPU执行时间片之后会执行 ForkJoinWorkerThread 的run()方法正式开始执行任务。</p><h4 id="forkjoinworkerthread-run" tabindex="-1"><a class="header-anchor" href="#forkjoinworkerthread-run"><span><a href="#forkjoinworkerthread-run">#</a> ForkJoinWorkerThread.run()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> run</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">workQueue</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) { </span><span style="color:#7F848E;font-style:italic;">// only run once</span></span>
<span class="line"><span style="color:#E5C07B;">        Throwable</span><span style="color:#E06C75;"> exception </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">            onStart</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//钩子方法，可自定义扩展</span></span>
<span class="line"><span style="color:#E5C07B;">            pool</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">runWorker</span><span style="color:#ABB2BF;">(workQueue);</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">            exception </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">            try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">                onTermination</span><span style="color:#E06C75;">(exception)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//钩子方法，可自定义扩展</span></span>
<span class="line"><span style="color:#E06C75;">            } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (exception </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                    exception </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">                pool</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">deregisterWorker</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, exception);</span><span style="color:#7F848E;font-style:italic;">//处理异常</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 方法很简单，在工作线程运行前后会调用自定义钩子函数(onStart和onTermination)，任务的运行则是调用了ForkJoinPool.runWorker()。如果全部任务执行完毕或者期间遭遇异常，则通过ForkJoinPool.deregisterWorker关闭工作线程并处理异常信息(deregisterWorker方法我们后面会详细讲解)。</p><h4 id="forkjoinpool-runworker-workqueue-w" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-runworker-workqueue-w"><span><a href="#forkjoinpool-runworker-workqueue-w">#</a> ForkJoinPool.runWorker(WorkQueue w)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> runWorker</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;"> w) {</span></span>
<span class="line"><span style="color:#E5C07B;">    w</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">growArray</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;">                   // allocate queue</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> seed </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hint</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">               // initially holds randomization hint</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (seed </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#D19A66;"> 1</span><span style="color:#C678DD;"> :</span><span style="color:#E06C75;"> seed</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // avoid 0 for xorShift</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((t </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> scan</span><span style="color:#E06C75;">(w</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> r)) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//扫描任务执行</span></span>
<span class="line"><span style="color:#E5C07B;">            w</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">runTask</span><span style="color:#ABB2BF;">(t);</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">awaitWork</span><span style="color:#E06C75;">(w</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> r))</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 13</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 17</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 5</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // xorshift</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: runWorker是 ForkJoinWorkerThread 的主运行方法，用来依次执行当前工作线程中的任务。函数流程很简单: 调用scan方法依次获取任务，然后调用WorkQueue .runTask运行任务；如果未扫描到任务，则调用awaitWork等待，直到工作线程/线程池终止或等待超时。</p><h4 id="forkjoinpool-scan-workqueue-w-int-r" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-scan-workqueue-w-int-r"><span><a href="#forkjoinpool-scan-workqueue-w-int-r">#</a> ForkJoinPool.scan(WorkQueue w, int r)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> scan</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> r) {</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> w </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> ss </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                     // initially non-negative</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //初始扫描起点，自旋扫描</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> origin </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> origin</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> oldSum </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> checkSum </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {</span></span>
<span class="line"><span style="color:#E5C07B;">            WorkQueue</span><span style="color:#E06C75;"> q</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            long</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((q </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[k]) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//获取workQueue</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (b </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">-</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                        (a </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {      </span><span style="color:#7F848E;font-style:italic;">// non-empty</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    //计算偏移量</span></span>
<span class="line"><span style="color:#C678DD;">                    long</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (((</span><span style="color:#E5C07B;">a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> b) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> ((t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObjectVolatile</span><span style="color:#ABB2BF;">(a, i)</span><span style="color:#E06C75;">)) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#7F848E;font-style:italic;"> //取base位置任务</span></span>
<span class="line"><span style="color:#E5C07B;">                            q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> b) {</span><span style="color:#7F848E;font-style:italic;">//stable</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> (ss </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {  </span><span style="color:#7F848E;font-style:italic;">//scanning</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(a, i, t, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//</span></span>
<span class="line"><span style="color:#E5C07B;">                                q</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> b </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//更新base位</span></span>
<span class="line"><span style="color:#C678DD;">                                if</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&lt;</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">)       </span><span style="color:#7F848E;font-style:italic;">// signal others</span></span>
<span class="line"><span style="color:#61AFEF;">                                    signalWork</span><span style="color:#E06C75;">(ws</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> q)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//创建或唤醒工作线程来运行任务</span></span>
<span class="line"><span style="color:#C678DD;">                                return</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            }</span></span>
<span class="line"><span style="color:#E06C75;">                        } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (oldSum </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#7F848E;font-style:italic;">   // try to activate 尝试激活工作线程</span></span>
<span class="line"><span style="color:#E5C07B;">                                w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#61AFEF;">                            tryRelease</span><span style="color:#E06C75;">(c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ws[m </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) c]</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> AC_UNIT)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//唤醒栈顶工作线程</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    //base位置任务为空或base位置偏移，随机移位重新扫描</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (ss </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)                   </span><span style="color:#7F848E;font-style:italic;">// refresh</span></span>
<span class="line"><span style="color:#E06C75;">                        ss </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 3</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 10</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    origin </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">           // move and rescan</span></span>
<span class="line"><span style="color:#E06C75;">                    oldSum </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> checkSum </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    continue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">                checkSum </span><span style="color:#56B6C2;">+=</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//队列任务为空，记录base位</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //更新索引k 继续向后查找</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((k </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (k </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> origin) {    </span><span style="color:#7F848E;font-style:italic;">// continue until stable</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //运行到这里说明已经扫描了全部的 workQueues，但并未扫描到任务</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((ss </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> (ss </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> (ss </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#E06C75;">))) </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                        oldSum </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> (oldSum </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> checkSum)) {</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (ss </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">qlock</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)    </span><span style="color:#7F848E;font-style:italic;">// already inactive</span></span>
<span class="line"><span style="color:#C678DD;">                        break</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">// 已经被灭活或终止,跳出循环</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    //对当前WorkQueue进行灭活操作</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> ns </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ss </span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> INACTIVE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">       // try to inactivate</span></span>
<span class="line"><span style="color:#C678DD;">                    long</span><span style="color:#E06C75;"> nc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((SP_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> ns) </span><span style="color:#56B6C2;">|</span></span>
<span class="line"><span style="color:#E06C75;">                            (UC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> ((c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl) </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> AC_UNIT)))</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//计算ctl为INACTIVE状态并减少活跃线程数</span></span>
<span class="line"><span style="color:#E5C07B;">                    w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">stackPred</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) c</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">         // hold prev stack top</span></span>
<span class="line"><span style="color:#E5C07B;">                    U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putInt</span><span style="color:#ABB2BF;">(w, QSCANSTATE, ns);</span><span style="color:#7F848E;font-style:italic;">//修改scanState为inactive状态</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, nc)</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//更新scanState为灭活状态</span></span>
<span class="line"><span style="color:#E06C75;">                        ss </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ns</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    else</span></span>
<span class="line"><span style="color:#E5C07B;">                        w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ss</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">         // back out</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">                checkSum </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//重置checkSum，继续循环</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 扫描并尝试偷取一个任务。使用w.hint进行随机索引 WorkQueue，也就是说并不一定会执行当前 WorkQueue 中的任务，而是偷取别的Worker的任务来执行。</p><p>函数的大概执行流程如下:</p><ul><li><p>取随机位置的一个 WorkQueue；</p></li><li><p>获取base位的 ForkJoinTask，成功取到后更新base位并返回任务；如果取到的 WorkQueue 中任务数大于1，则调用signalWork创建或唤醒其他工作线程；</p></li><li><p>如果当前工作线程处于不活跃状态(INACTIVE)，则调用tryRelease尝试唤醒栈顶工作线程来执行。</p><p>tryRelease源码如下:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> boolean</span><span style="color:#61AFEF;"> tryRelease</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> WorkQueue</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> inc) {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> sp </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) c</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> vs </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (sp </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> SS_SEQ) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">INACTIVE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Thread</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //ctl低32位等于scanState，说明可以唤醒parker线程</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (v </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> sp) {          </span><span style="color:#7F848E;font-style:italic;">// v is at top of stack</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)</span></span>
<span class="line"><span style="color:#C678DD;">        long</span><span style="color:#E06C75;"> nc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (UC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> inc)) </span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> (SP_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">stackPred</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, nc)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> vs</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((p </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">parker</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unpark</span><span style="color:#ABB2BF;">(p);</span><span style="color:#7F848E;font-style:italic;">//唤醒线程</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>如果base位任务为空或发生偏移，则对索引位进行随机移位，然后重新扫描；</p></li><li><p>如果扫描整个workQueues之后没有获取到任务，则设置当前工作线程为INACTIVE状态；然后重置checkSum，再次扫描一圈之后如果还没有任务则跳出循环返回null。</p></li></ul><h4 id="forkjoinpool-awaitwork-workqueue-w-int-r" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-awaitwork-workqueue-w-int-r"><span><a href="#forkjoinpool-awaitwork-workqueue-w-int-r">#</a> ForkJoinPool.awaitWork(WorkQueue w, int r)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> boolean</span><span style="color:#61AFEF;"> awaitWork</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> r) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (w </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">qlock</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)                 </span><span style="color:#7F848E;font-style:italic;">// w is terminating</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> pred </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">stackPred</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> spins </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> SPINS</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ss</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((ss </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//正在扫描，跳出循环</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (spins </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">            r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 6</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 21</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            r </span><span style="color:#56B6C2;">^=</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 7</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (r </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">spins </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {         </span><span style="color:#7F848E;font-style:italic;">// randomize spins</span></span>
<span class="line"><span style="color:#E5C07B;">                WorkQueue</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                int</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> j</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                AtomicLong</span><span style="color:#E06C75;"> sc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (pred </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                        (j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> pred </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SMASK) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                        (v </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[j]) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#7F848E;font-style:italic;">        // see if pred parking</span></span>
<span class="line"><span style="color:#E06C75;">                        (</span><span style="color:#E5C07B;">v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">parker</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> &gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">))</span></span>
<span class="line"><span style="color:#E06C75;">                    spins </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> SPINS</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                // continue spinning</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">qlock</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)                     </span><span style="color:#7F848E;font-style:italic;">// 当前workQueue已经终止，返回false recheck after spins</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">interrupted</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//判断线程是否被中断，并清除中断状态</span></span>
<span class="line"><span style="color:#C678DD;">            long</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> prevctl</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> parkTime</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> deadline</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> ac </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) ((c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl) </span><span style="color:#56B6C2;">&gt;&gt;</span><span style="color:#E06C75;"> AC_SHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> (config </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SMASK)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//活跃线程数</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((ac </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#61AFEF;"> tryTerminate</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)) </span><span style="color:#56B6C2;">||</span><span style="color:#7F848E;font-style:italic;"> //无active线程，尝试终止</span></span>
<span class="line"><span style="color:#E06C75;">                    (runState </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> STOP) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)           </span><span style="color:#7F848E;font-style:italic;">// pool terminating</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (ac </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> ss </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) c) {        </span><span style="color:#7F848E;font-style:italic;">// is last waiter</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)</span></span>
<span class="line"><span style="color:#E06C75;">                prevctl </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (UC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> AC_UNIT)) </span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> (SP_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> pred)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                int</span><span style="color:#E06C75;"> t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">short</span><span style="color:#E06C75;">) (c </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#E06C75;"> TC_SHIFT)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // shrink excess spares</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (t </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 2</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, prevctl)</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//总线程过量</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                 // else use timed wait</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //计算空闲超时时间</span></span>
<span class="line"><span style="color:#E06C75;">                parkTime </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> IDLE_TIMEOUT </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> ((t </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#D19A66;"> 1</span><span style="color:#C678DD;"> :</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> -</span><span style="color:#E06C75;"> t)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                deadline </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nanoTime</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> +</span><span style="color:#E06C75;"> parkTime </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> TIMEOUT_SLOP</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            } </span><span style="color:#C678DD;">else</span></span>
<span class="line"><span style="color:#E06C75;">                prevctl </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> parkTime </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> deadline </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0L</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            Thread</span><span style="color:#E06C75;"> wt </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putObject</span><span style="color:#ABB2BF;">(wt, PARKBLOCKER, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">   // emulate LockSupport</span></span>
<span class="line"><span style="color:#E5C07B;">            w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">parker</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> wt</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//设置parker，准备阻塞</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> ctl </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> c)      </span><span style="color:#7F848E;font-style:italic;">// recheck before park</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">park</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">, parkTime);</span><span style="color:#7F848E;font-style:italic;">//阻塞指定的时间</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(w, QPARKER, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putObject</span><span style="color:#ABB2BF;">(wt, PARKBLOCKER, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> &gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//正在扫描，说明等到任务，跳出循环</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (parkTime </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0L</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> ctl </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> c </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                    deadline </span><span style="color:#56B6C2;">-</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nanoTime</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> &lt;=</span><span style="color:#D19A66;"> 0L</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E5C07B;">                    U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, prevctl)</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//未等到任务，更新ctl，返回false</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                     // shrink pool</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 回到runWorker方法，如果scan方法未扫描到任务，会调用awaitWork等待获取任务。函数的具体执行流程大家看源码，这里简单说一下:</p><ul><li>在等待获取任务期间，如果工作线程或线程池已经终止则直接返回false。如果当前无 active 线程，尝试终止线程池并返回false，如果终止失败并且当前是最后一个等待的 Worker，就阻塞指定的时间(IDLE_TIMEOUT)；等到届期或被唤醒后如果发现自己是scanning(scanState &gt;= 0)状态，说明已经等到任务，跳出等待返回true继续 scan，否则的更新ctl并返回false。</li></ul><h4 id="workqueue-runtask" tabindex="-1"><a class="header-anchor" href="#workqueue-runtask"><span><a href="#workqueue-runtask">#</a> WorkQueue.runTask()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> runTask</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (task </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">        scanState </span><span style="color:#56B6C2;">&amp;=</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">SCANNING</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // mark as busy</span></span>
<span class="line"><span style="color:#E06C75;">        (currentSteal </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> task)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">doExec</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;">//更新currentSteal并执行任务</span></span>
<span class="line"><span style="color:#E5C07B;">        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, QCURRENTSTEAL, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;"> // release for GC</span></span>
<span class="line"><span style="color:#61AFEF;">        execLocalTasks</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//依次执行本地任务</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinWorkerThread</span><span style="color:#E06C75;"> thread </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> owner</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">++</span><span style="color:#E06C75;">nsteals </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)      </span><span style="color:#7F848E;font-style:italic;">// collect on overflow</span></span>
<span class="line"><span style="color:#61AFEF;">            transferStealCount</span><span style="color:#E06C75;">(pool)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//增加偷取任务数</span></span>
<span class="line"><span style="color:#E06C75;">        scanState </span><span style="color:#56B6C2;">|=</span><span style="color:#E06C75;"> SCANNING</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (thread </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">            thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">afterTopLevelExec</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;">//执行钩子函数</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 在scan方法扫描到任务之后，调用WorkQueue.runTask()来执行获取到的任务，大概流程如下:</p><ul><li><p>标记scanState为正在执行状态；</p></li><li><p>更新currentSteal为当前获取到的任务并执行它，任务的执行调用了ForkJoinTask.doExec()方法，源码如下:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//ForkJoinTask.doExec()</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> int</span><span style="color:#61AFEF;"> doExec</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> boolean</span><span style="color:#E06C75;"> completed</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> status) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E06C75;">            completed </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> exec</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//执行我们定义的任务</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> rex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#61AFEF;"> setExceptionalCompletion</span><span style="color:#E06C75;">(rex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (completed)</span></span>
<span class="line"><span style="color:#E06C75;">            s </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> setCompletion</span><span style="color:#E06C75;">(NORMAL)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>调用execLocalTasks依次执行当前WorkerQueue中的任务，源码如下:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//执行并移除所有本地任务</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> execLocalTasks</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> b </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> base</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> array</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (b </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> top </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> a </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">            (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((config </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> FIFO_QUEUE) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//FIFO模式</span></span>
<span class="line"><span style="color:#C678DD;">            for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">) </span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">getAndSetObject</span></span>
<span class="line"><span style="color:#E06C75;">                        (a</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ((m </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> s) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//FIFO执行，取top任务</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, QTOP, s);</span></span>
<span class="line"><span style="color:#E5C07B;">                t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">doExec</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;">//执行</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (base </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> top </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span></span>
<span class="line"><span style="color:#61AFEF;">            pollAndExecAll</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//LIFO模式执行，取base任务</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>更新偷取任务数；</p></li><li><p>还原scanState并执行钩子函数。</p></li></ul><h4 id="forkjoinpool-deregisterworker-forkjoinworkerthread-wt-throwable-ex" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-deregisterworker-forkjoinworkerthread-wt-throwable-ex"><span><a href="#forkjoinpool-deregisterworker-forkjoinworkerthread-wt-throwable-ex">#</a> ForkJoinPool.deregisterWorker(ForkJoinWorkerThread wt, Throwable ex)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> deregisterWorker</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinWorkerThread</span><span style="color:#E06C75;"> wt</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Throwable</span><span style="color:#E06C75;"> ex) {</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;"> w </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //1.移除workQueue</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (wt </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (w </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> wt</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workQueue</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//获取ForkJoinWorkerThread的等待队列</span></span>
<span class="line"><span style="color:#E5C07B;">        WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                           // remove index from array</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> idx </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">config</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;"> SMASK</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//计算workQueue索引</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> lockRunState</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//获取runState锁和当前池运行状态</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#E06C75;"> idx </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E06C75;"> ws[idx] </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> w)</span></span>
<span class="line"><span style="color:#E06C75;">            ws[idx] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//移除workQueue</span></span>
<span class="line"><span style="color:#61AFEF;">        unlockRunState</span><span style="color:#E06C75;">(rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">RSLOCK)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//解除runState锁</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //2.减少CTL数</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                                       // decrement counts</span></span>
<span class="line"><span style="color:#C678DD;">    do</span><span style="color:#E06C75;"> {} </span><span style="color:#C678DD;">while</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">compareAndSwapLong</span></span>
<span class="line"><span style="color:#E06C75;">                 (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> CTL</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ((AC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> AC_UNIT)) </span><span style="color:#56B6C2;">|</span></span>
<span class="line"><span style="color:#E06C75;">                                       (TC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> TC_UNIT)) </span><span style="color:#56B6C2;">|</span></span>
<span class="line"><span style="color:#E06C75;">                                       (SP_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> c))))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //3.处理被移除workQueue内部相关参数</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (w </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">qlock</span><span style="color:#56B6C2;"> =</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                             // ensure set</span></span>
<span class="line"><span style="color:#E5C07B;">        w</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">transferStealCount</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        w</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cancelAll</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;">                            // cancel remaining tasks</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //4.如果线程未终止，替换被移除的workQueue并唤醒内部线程</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">;;</span><span style="color:#E06C75;">) {                                    </span><span style="color:#7F848E;font-style:italic;">// possibly replace</span></span>
<span class="line"><span style="color:#E5C07B;">        WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sp</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //尝试终止线程池</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">tryTerminate</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> w </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span></span>
<span class="line"><span style="color:#E06C75;">            (runState </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> STOP) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> (ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span></span>
<span class="line"><span style="color:#E06C75;">            (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)              </span><span style="color:#7F848E;font-style:italic;">// already terminating</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //唤醒被替换的线程，依赖于下一步</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((sp </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">)(c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl)) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {         </span><span style="color:#7F848E;font-style:italic;">// wake up replacement</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">tryRelease</span><span style="color:#E06C75;">(c</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ws[sp </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m]</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> AC_UNIT))</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //创建工作线程替换</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (ex </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> ADD_WORKER) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">            tryAddWorker</span><span style="color:#E06C75;">(c)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                      // create replacement</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#7F848E;font-style:italic;">                                      // don&#39;t need replacement</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //5.处理异常</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (ex </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)                               </span><span style="color:#7F848E;font-style:italic;">// help clean on way out</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinTask</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">helpExpungeStaleExceptions</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    else</span><span style="color:#7F848E;font-style:italic;">                                          // rethrow</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinTask</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">rethrow</span><span style="color:#ABB2BF;">(ex);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: deregisterWorker方法用于工作线程运行完毕之后终止线程或处理工作线程异常，主要就是清除已关闭的工作线程或回滚创建线程之前的操作，并把传入的异常抛给 ForkJoinTask 来处理。具体步骤见源码注释。</p><h4 id="小结-2" tabindex="-1"><a class="header-anchor" href="#小结-2"><span><a href="#%E5%B0%8F%E7%BB%93-2">#</a> 小结</span></a></h4><p>本节我们对任务的执行流程进行了说明，后面我们将继续介绍任务的结果获取(join/invoke)。</p><h3 id="获取任务结果-forkjointask-join-forkjointask-invoke" tabindex="-1"><a class="header-anchor" href="#获取任务结果-forkjointask-join-forkjointask-invoke"><span><a href="#%E8%8E%B7%E5%8F%96%E4%BB%BB%E5%8A%A1%E7%BB%93%E6%9E%9C-forkjointask-join-forkjointask-invoke">#</a> 获取任务结果 - ForkJoinTask.join() / ForkJoinTask.invoke()</span></a></h3><ul><li>join() :</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//合并任务结果</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> join</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> doJoin</span><span style="color:#E06C75;">() </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> DONE_MASK) </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> NORMAL)</span></span>
<span class="line"><span style="color:#61AFEF;">        reportException</span><span style="color:#E06C75;">(s)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#61AFEF;"> getRawResult</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//join, get, quietlyJoin的主实现方法</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> int</span><span style="color:#61AFEF;"> doJoin</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> Thread</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> ForkJoinWorkerThread</span><span style="color:#E06C75;"> wt</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> ForkJoinPool</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> status) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#C678DD;"> ?</span><span style="color:#E06C75;"> s </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#E06C75;">        ((t </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> ForkJoinWorkerThread) </span><span style="color:#C678DD;">?</span></span>
<span class="line"><span style="color:#E06C75;">        (w </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (wt </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (ForkJoinWorkerThread)t)</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workQueue</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">.</span></span>
<span class="line"><span style="color:#61AFEF;">        tryUnpush</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> doExec</span><span style="color:#E06C75;">()) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#C678DD;"> ?</span><span style="color:#E06C75;"> s </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#E5C07B;">        wt</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">pool</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">awaitJoin</span><span style="color:#ABB2BF;">(w, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">0L</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> :</span></span>
<span class="line"><span style="color:#61AFEF;">        externalAwaitDone</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>invoke() :</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//执行任务，并等待任务完成并返回结果</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> invoke</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> doInvoke</span><span style="color:#E06C75;">() </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> DONE_MASK) </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> NORMAL)</span></span>
<span class="line"><span style="color:#61AFEF;">        reportException</span><span style="color:#E06C75;">(s)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#61AFEF;"> getRawResult</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//invoke, quietlyInvoke的主实现方法</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> int</span><span style="color:#61AFEF;"> doInvoke</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> Thread</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> ForkJoinWorkerThread</span><span style="color:#E06C75;"> wt</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> doExec</span><span style="color:#E06C75;">()) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#C678DD;"> ?</span><span style="color:#E06C75;"> s </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#E06C75;">        ((t </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> ForkJoinWorkerThread) </span><span style="color:#C678DD;">?</span></span>
<span class="line"><span style="color:#E06C75;">        (wt </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (ForkJoinWorkerThread)t)</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">pool</span><span style="color:#ABB2BF;">.</span></span>
<span class="line"><span style="color:#61AFEF;">        awaitJoin</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">wt</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workQueue</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#61AFEF;">        externalAwaitDone</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: join()方法一把是在任务fork()之后调用，用来获取(或者叫“合并”)任务的执行结果。</p><p>ForkJoinTask的join()和invoke()方法都可以用来获取任务的执行结果(另外还有get方法也是调用了doJoin来获取任务结果，但是会响应运行时异常)，它们对外部提交任务的执行方式一致，都是通过externalAwaitDone方法等待执行结果。不同的是invoke()方法会直接执行当前任务；而join()方法则是在当前任务在队列 top 位时(通过tryUnpush方法判断)才能执行，如果当前任务不在 top 位或者任务执行失败调用ForkJoinPool.awaitJoin方法帮助执行或阻塞当前 join 任务。(所以在官方文档中建议了我们对ForkJoinTask任务的调用顺序，一对 fork-join操作一般按照如下顺序调用: a.fork(); b.fork(); b.join(); a.join();。因为任务 b 是后面进入队列，也就是说它是在栈顶的(top 位)，在它fork()之后直接调用join()就可以直接执行而不会调用ForkJoinPool.awaitJoin方法去等待。)</p><p>在这些方法中，join()相对比较全面，所以之后的讲解我们将从join()开始逐步向下分析，首先看一下join()的执行流程:</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-6.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>后面的源码分析中，我们首先讲解比较简单的外部 join 任务(externalAwaitDone)，然后再讲解内部 join 任务(从ForkJoinPool.awaitJoin()开始)。</p><h4 id="forkjointask-externalawaitdone" tabindex="-1"><a class="header-anchor" href="#forkjointask-externalawaitdone"><span><a href="#forkjointask-externalawaitdone">#</a> ForkJoinTask.externalAwaitDone()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> int</span><span style="color:#61AFEF;"> externalAwaitDone</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //执行任务</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">this</span><span style="color:#C678DD;"> instanceof</span><span style="color:#E06C75;"> CountedCompleter) </span><span style="color:#C678DD;">?</span><span style="color:#7F848E;font-style:italic;"> // try helping</span></span>
<span class="line"><span style="color:#E5C07B;">             ForkJoinPool</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">common</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">externalHelpComplete</span><span style="color:#ABB2BF;">(  </span><span style="color:#7F848E;font-style:italic;">// CountedCompleter任务</span></span>
<span class="line"><span style="color:#ABB2BF;">                 (</span><span style="color:#E5C07B;">CountedCompleter</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;">)</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> :</span></span>
<span class="line"><span style="color:#E5C07B;">             ForkJoinPool</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">common</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">tryExternalUnpush</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> ?</span><span style="color:#61AFEF;"> doExec</span><span style="color:#E06C75;">() </span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  // ForkJoinTask任务</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> status) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//执行失败，进入等待</span></span>
<span class="line"><span style="color:#C678DD;">        boolean</span><span style="color:#E06C75;"> interrupted </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        do</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, STATUS, s, s </span><span style="color:#56B6C2;">|</span><span style="color:#ABB2BF;"> SIGNAL)</span><span style="color:#E06C75;">) {  </span><span style="color:#7F848E;font-style:italic;">//更新state</span></span>
<span class="line"><span style="color:#C678DD;">                synchronized</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (status </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//SIGNAL 等待信号</span></span>
<span class="line"><span style="color:#C678DD;">                        try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">                            wait</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">0L</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">InterruptedException</span><span style="color:#E06C75;font-style:italic;"> ie</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">                            interrupted </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#C678DD;">                    else</span></span>
<span class="line"><span style="color:#61AFEF;">                        notifyAll</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">while</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> status) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (interrupted)</span></span>
<span class="line"><span style="color:#E5C07B;">            Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">interrupt</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 如果当前join为外部调用，则调用此方法执行任务，如果任务执行失败就进入等待。方法本身是很简单的，需要注意的是对不同的任务类型分两种情况:</p><ul><li><p>如果我们的任务为 CountedCompleter 类型的任务，则调用externalHelpComplete方法来执行任务。</p></li><li><p>其他类型的 ForkJoinTask 任务调用tryExternalUnpush来执行，源码如下:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//为外部提交者提供 tryUnpush 功能(给定任务在top位时弹出任务)</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> boolean</span><span style="color:#61AFEF;"> tryExternalUnpush</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task) {</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ThreadLocalRandom</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getProbe</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">            (w </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[m </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> r </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SQMASK]) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">            (a </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        long</span><span style="color:#E06C75;"> j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (((</span><span style="color:#E5C07B;">a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  //取top位任务</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(w, QLOCK, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {  </span><span style="color:#7F848E;font-style:italic;">//加锁</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> a </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E5C07B;">                    U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObject</span><span style="color:#ABB2BF;">(a, j)</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> task </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E5C07B;">                    U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(a, j, task, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {  </span><span style="color:#7F848E;font-style:italic;">//符合条件，弹出</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(w, QTOP, s </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">  //更新top</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(w, QLOCK, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;"> //解锁，返回true</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E5C07B;">            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(w, QLOCK, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;">  //当前任务不在top位，解锁返回false</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>tryExternalUnpush的作用就是判断当前任务是否在top位，如果是则弹出任务，然后在externalAwaitDone中调用doExec()执行任务。</p></li></ul><h4 id="forkjoinpool-awaitjoin" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-awaitjoin"><span><a href="#forkjoinpool-awaitjoin">#</a> ForkJoinPool.awaitJoin()</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> int</span><span style="color:#61AFEF;"> awaitJoin</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> deadline) {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (task </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> w </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> prevJoin </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">currentJoin</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  //获取给定Worker的join任务</span></span>
<span class="line"><span style="color:#E5C07B;">        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(w, QCURRENTJOIN, task);</span><span style="color:#7F848E;font-style:italic;">  //把currentJoin替换为给定任务</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //判断是否为CountedCompleter类型的任务</span></span>
<span class="line"><span style="color:#E5C07B;">        CountedCompleter</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> cc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (task </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> CountedCompleter) </span><span style="color:#C678DD;">?</span></span>
<span class="line"><span style="color:#E06C75;">                (</span><span style="color:#E5C07B;">CountedCompleter</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">) task </span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> task</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)  </span><span style="color:#7F848E;font-style:italic;">//已经完成|取消|异常 跳出循环</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (cc </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//CountedCompleter任务由helpComplete来完成join</span></span>
<span class="line"><span style="color:#61AFEF;">                helpComplete</span><span style="color:#E06C75;">(w</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> cc</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#56B6C2;"> ==</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">tryRemoveAndExec</span><span style="color:#ABB2BF;">(task)</span><span style="color:#E06C75;">)  </span><span style="color:#7F848E;font-style:italic;">//尝试执行</span></span>
<span class="line"><span style="color:#61AFEF;">                helpStealer</span><span style="color:#E06C75;">(w</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> task)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">  //队列为空或执行失败，任务可能被偷，帮助偷取者执行该任务</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> task</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#7F848E;font-style:italic;">//已经完成|取消|异常，跳出循环</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //计算任务等待时间</span></span>
<span class="line"><span style="color:#C678DD;">            long</span><span style="color:#E06C75;"> ms</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ns</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (deadline </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                ms </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0L</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((ns </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> deadline </span><span style="color:#56B6C2;">-</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nanoTime</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((ms </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> TimeUnit</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">NANOSECONDS</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toMillis</span><span style="color:#ABB2BF;">(ns)</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                ms </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1L</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">tryCompensate</span><span style="color:#E06C75;">(w)) {</span><span style="color:#7F848E;font-style:italic;">//执行补偿操作</span></span>
<span class="line"><span style="color:#E5C07B;">                task</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">internalWait</span><span style="color:#ABB2BF;">(ms);</span><span style="color:#7F848E;font-style:italic;">//补偿执行成功，任务等待指定时间</span></span>
<span class="line"><span style="color:#E5C07B;">                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getAndAddLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, AC_UNIT);</span><span style="color:#7F848E;font-style:italic;">//更新活跃线程数</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E5C07B;">        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(w, QCURRENTJOIN, prevJoin);</span><span style="color:#7F848E;font-style:italic;">//循环结束，替换为原来的join任务</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 如果当前 join 任务不在Worker等待队列的top位，或者任务执行失败，调用此方法来帮助执行或阻塞当前 join 的任务。函数执行流程如下:</p><ul><li><p>由于每次调用awaitJoin都会优先执行当前join的任务，所以首先会更新currentJoin为当前join任务；</p></li><li><p>进入自旋:</p><ul><li>首先检查任务是否已经完成(通过task.status &lt; 0判断)，如果给定任务执行完毕|取消|异常 则跳出循环返回执行状态s；</li><li>如果是 CountedCompleter 任务类型，调用helpComplete方法来完成join操作(后面笔者会开新篇来专门讲解CountedCompleter，本篇暂时不做详细解析)；</li><li>非 CountedCompleter 任务类型调用WorkQueue.tryRemoveAndExec尝试执行任务；</li><li>如果给定 WorkQueue 的等待队列为空或任务执行失败，说明任务可能被偷，调用helpStealer帮助偷取者执行任务(也就是说，偷取者帮我执行任务，我去帮偷取者执行它的任务)；</li><li>再次判断任务是否执行完毕(task.status &lt; 0)，如果任务执行失败，计算一个等待时间准备进行补偿操作；</li><li>调用tryCompensate方法为给定 WorkQueue 尝试执行补偿操作。在执行补偿期间，如果发现 资源争用|池处于unstable状态|当前Worker已终止，则调用ForkJoinTask.internalWait()方法等待指定的时间，任务唤醒之后继续自旋，ForkJoinTask.internalWait()源码如下:</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> internalWait</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> timeout) {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> status) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#7F848E;font-style:italic;"> // force completer to issue notify</span></span>
<span class="line"><span style="color:#E5C07B;">        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, STATUS, s, s </span><span style="color:#56B6C2;">|</span><span style="color:#ABB2BF;"> SIGNAL)</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//更新任务状态为SIGNAL(等待唤醒)</span></span>
<span class="line"><span style="color:#C678DD;">        synchronized</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (status </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">                try</span><span style="color:#E06C75;"> { </span><span style="color:#61AFEF;">wait</span><span style="color:#E06C75;">(timeout)</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">InterruptedException</span><span style="color:#E06C75;font-style:italic;"> ie</span><span style="color:#E06C75;">) { }</span></span>
<span class="line"><span style="color:#C678DD;">            else</span></span>
<span class="line"><span style="color:#61AFEF;">                notifyAll</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>在awaitJoin中，我们总共调用了三个比较复杂的方法: tryRemoveAndExec、helpStealer和tryCompensate，下面我们依次讲解。</p><h4 id="workqueue-tryremoveandexec-forkjointask-task" tabindex="-1"><a class="header-anchor" href="#workqueue-tryremoveandexec-forkjointask-task"><span><a href="#workqueue-tryremoveandexec-forkjointask-task">#</a> WorkQueue.tryRemoveAndExec(ForkJoinTask&lt;?&gt; task)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#C678DD;"> boolean</span><span style="color:#61AFEF;"> tryRemoveAndExec</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task) {</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((a </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> array) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">            task </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        while</span><span style="color:#E06C75;"> ((n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> top) </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> (b </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> base)) </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //从top往下自旋查找</span></span>
<span class="line"><span style="color:#C678DD;">            for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {      </span><span style="color:#7F848E;font-style:italic;">// traverse from s to b</span></span>
<span class="line"><span style="color:#C678DD;">                long</span><span style="color:#E06C75;"> j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((</span><span style="color:#ABB2BF;">--</span><span style="color:#E06C75;">s </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//计算任务索引</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">) </span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObject</span><span style="color:#ABB2BF;">(a, j)</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) </span><span style="color:#7F848E;font-style:italic;">//获取索引到的任务</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> top</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">     // shorter than expected</span></span>
<span class="line"><span style="color:#C678DD;">                else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (t </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> task) { </span><span style="color:#7F848E;font-style:italic;">//给定任务为索引任务</span></span>
<span class="line"><span style="color:#C678DD;">                    boolean</span><span style="color:#E06C75;"> removed </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (s </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> top) {      </span><span style="color:#7F848E;font-style:italic;">// pop</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(a, j, task, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) { </span><span style="color:#7F848E;font-style:italic;">//弹出任务</span></span>
<span class="line"><span style="color:#E5C07B;">                            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, QTOP, s);</span><span style="color:#7F848E;font-style:italic;"> //更新top</span></span>
<span class="line"><span style="color:#E06C75;">                            removed </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#E06C75;">                    } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (base </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> b)      </span><span style="color:#7F848E;font-style:italic;">// replace with proxy</span></span>
<span class="line"><span style="color:#E06C75;">                        removed </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">                                a, j, task, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> EmptyTask</span><span style="color:#ABB2BF;">());</span><span style="color:#7F848E;font-style:italic;"> //join任务已经被移除，替换为一个占位任务</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (removed)</span></span>
<span class="line"><span style="color:#E5C07B;">                        task</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">doExec</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> //执行</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">t</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> top) { </span><span style="color:#7F848E;font-style:italic;">//给定任务不是top任务</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(a, j, t, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) </span><span style="color:#7F848E;font-style:italic;">//弹出任务</span></span>
<span class="line"><span style="color:#E5C07B;">                        U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, QTOP, s);</span><span style="color:#7F848E;font-style:italic;">//更新top</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                  // was cancelled</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">--</span><span style="color:#E06C75;">n </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#7F848E;font-style:italic;">//遍历结束</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#7F848E;font-style:italic;">//任务执行完毕</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 从top位开始自旋向下找到给定任务，如果找到把它从当前 Worker 的任务队列中移除并执行它。注意返回的参数: 如果任务队列为空或者任务未执行完毕返回true；任务执行完毕返回false。</p><h4 id="forkjoinpool-helpstealer-workqueue-w-forkjointask-task" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-helpstealer-workqueue-w-forkjointask-task"><span><a href="#forkjoinpool-helpstealer-workqueue-w-forkjointask-task">#</a> ForkJoinPool.helpStealer(WorkQueue w, ForkJoinTask&lt;?&gt; task)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> helpStealer</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> task) {</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;">[] ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> oldSum </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> checkSum</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (ws </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> w </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">            task </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        do</span><span style="color:#E06C75;"> {                                       </span><span style="color:#7F848E;font-style:italic;">// restart point</span></span>
<span class="line"><span style="color:#E06C75;">            checkSum </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                          // for stability check</span></span>
<span class="line"><span style="color:#E5C07B;">            ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> subtask</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            WorkQueue</span><span style="color:#E06C75;"> j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> w</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                    // v is subtask stealer</span></span>
<span class="line"><span style="color:#E06C75;">            descent</span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#C678DD;">            for</span><span style="color:#E06C75;"> (subtask </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> task</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> subtask</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#56B6C2;"> &gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> ) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //1. 找到给定WorkQueue的偷取者v</span></span>
<span class="line"><span style="color:#C678DD;">                for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> j</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hint</span><span style="color:#56B6C2;"> |</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">+=</span><span style="color:#D19A66;"> 2</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//跳两个索引，因为Worker在奇数索引位</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (k </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> m)                     </span><span style="color:#7F848E;font-style:italic;">// can&#39;t find stealer</span></span>
<span class="line"><span style="color:#C678DD;">                        break</span><span style="color:#E06C75;"> descent</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> ((v </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (h </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> k) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m]) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">currentSteal</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> subtask) {</span><span style="color:#7F848E;font-style:italic;">//定位到偷取者</span></span>
<span class="line"><span style="color:#E5C07B;">                            j</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hint</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//更新stealer索引</span></span>
<span class="line"><span style="color:#C678DD;">                            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#E06C75;">                        checkSum </span><span style="color:#56B6C2;">+=</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //2. 帮助偷取者v执行任务</span></span>
<span class="line"><span style="color:#C678DD;">                for</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ;</span><span style="color:#E06C75;"> ) {                         </span><span style="color:#7F848E;font-style:italic;">// help v or descend</span></span>
<span class="line"><span style="color:#E5C07B;">                    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] a</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">            //偷取者内部的任务</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    checkSum </span><span style="color:#56B6C2;">+=</span><span style="color:#E06C75;"> (b </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> next </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">currentJoin</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//获取偷取者的join任务</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">subtask</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> j</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">currentJoin</span><span style="color:#56B6C2;"> !=</span><span style="color:#E06C75;"> subtask </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#E5C07B;">                            v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">currentSteal</span><span style="color:#56B6C2;"> !=</span><span style="color:#E06C75;"> subtask) </span><span style="color:#7F848E;font-style:italic;">// stale</span></span>
<span class="line"><span style="color:#C678DD;">                        break</span><span style="color:#E06C75;"> descent</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // stale，跳出descent循环重来</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (b </span><span style="color:#56B6C2;">-</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#56B6C2;"> &gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> (a </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">array</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> ((subtask </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> next) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)   </span><span style="color:#7F848E;font-style:italic;">//偷取者的join任务为null，跳出descent循环</span></span>
<span class="line"><span style="color:#C678DD;">                            break</span><span style="color:#E06C75;"> descent</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                        break</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //偷取者内部任务为空，可能任务也被偷走了；跳出本次循环，查找偷取者的偷取者</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (((</span><span style="color:#E5C07B;">a</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> b) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> ASHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> ABASE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//获取base偏移地址</span></span>
<span class="line"><span style="color:#E5C07B;">                    ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObjectVolatile</span><span style="color:#ABB2BF;">(a, i)</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//获取偷取者的base任务</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> b) {</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> (t </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)             </span><span style="color:#7F848E;font-style:italic;">// stale</span></span>
<span class="line"><span style="color:#C678DD;">                            break</span><span style="color:#E06C75;"> descent</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // stale，跳出descent循环重来</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(a, i, t, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//弹出任务</span></span>
<span class="line"><span style="color:#E5C07B;">                            v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> b </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">         //更新偷取者的base位</span></span>
<span class="line"><span style="color:#E5C07B;">                            ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> ps </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">currentSteal</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//获取调用者偷来的任务</span></span>
<span class="line"><span style="color:#C678DD;">                            int</span><span style="color:#E06C75;"> top </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                            //首先更新给定workQueue的currentSteal为偷取者的base任务，然后执行该任务</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                            //然后通过检查top来判断给定workQueue是否有自己的任务，如果有，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                            // 则依次弹出任务(LIFO)-&gt;更新currentSteal-&gt;执行该任务(注意这里是自己偷自己的任务执行)</span></span>
<span class="line"><span style="color:#C678DD;">                            do</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">                                U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(w, QCURRENTSTEAL, t);</span></span>
<span class="line"><span style="color:#E5C07B;">                                t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">doExec</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;">        // clear local tasks too</span></span>
<span class="line"><span style="color:#E06C75;">                            } </span><span style="color:#C678DD;">while</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#56B6C2;"> &gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E5C07B;">                                    w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#56B6C2;"> !=</span><span style="color:#E06C75;"> top </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#7F848E;font-style:italic;"> //内部有自己的任务，依次弹出执行</span></span>
<span class="line"><span style="color:#E06C75;">                                    (t </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">pop</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                            U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(w, QCURRENTSTEAL, ps);</span><span style="color:#7F848E;font-style:italic;">//还原给定workQueue的currentSteal</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">base</span><span style="color:#56B6C2;"> !=</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">top</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//给定workQueue有自己的任务了，帮助结束，返回</span></span>
<span class="line"><span style="color:#C678DD;">                                return</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">            // can&#39;t further help</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">while</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">status</span><span style="color:#56B6C2;"> &gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> oldSum </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> (oldSum </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> checkSum))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 如果队列为空或任务执行失败，说明任务可能被偷，调用此方法来帮助偷取者执行任务。基本思想是: 偷取者帮助我执行任务，我去帮助偷取者执行它的任务。 函数执行流程如下:</p><p>循环定位偷取者，由于Worker是在奇数索引位，所以每次会跳两个索引位。定位到偷取者之后，更新调用者 WorkQueue 的hint为偷取者的索引，方便下次定位； 定位到偷取者后，开始帮助偷取者执行任务。从偷取者的base索引开始，每次偷取一个任务执行。在帮助偷取者执行任务后，如果调用者发现本身已经有任务(w.top != top)，则依次弹出自己的任务(LIFO顺序)并执行(也就是说自己偷自己的任务执行)。</p><h4 id="forkjoinpool-trycompensate-workqueue-w" tabindex="-1"><a class="header-anchor" href="#forkjoinpool-trycompensate-workqueue-w"><span><a href="#forkjoinpool-trycompensate-workqueue-w">#</a> ForkJoinPool.tryCompensate(WorkQueue w)</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">//执行补偿操作: 尝试缩减活动线程量，可能释放或创建一个补偿线程来准备阻塞</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> boolean</span><span style="color:#61AFEF;"> tryCompensate</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WorkQueue</span><span style="color:#E06C75;"> w) {</span></span>
<span class="line"><span style="color:#C678DD;">    boolean</span><span style="color:#E06C75;"> canBlock</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    WorkQueue</span><span style="color:#E06C75;">[] ws</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> pc</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sp</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (w </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">qlock</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#7F848E;font-style:italic;">           // caller terminating</span></span>
<span class="line"><span style="color:#E06C75;">            (ws </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> workQueues) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> (m </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ws</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span></span>
<span class="line"><span style="color:#E06C75;">            (pc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> config </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> SMASK) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)           </span><span style="color:#7F848E;font-style:italic;">// parallelism disabled</span></span>
<span class="line"><span style="color:#E06C75;">        canBlock </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //调用者已终止</span></span>
<span class="line"><span style="color:#C678DD;">    else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((sp </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) (c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ctl)) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)      </span><span style="color:#7F848E;font-style:italic;">// release idle worker</span></span>
<span class="line"><span style="color:#E06C75;">        canBlock </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> tryRelease</span><span style="color:#E06C75;">(c</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ws[sp </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m]</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> 0L</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//唤醒等待的工作线程</span></span>
<span class="line"><span style="color:#C678DD;">    else</span><span style="color:#E06C75;"> {</span><span style="color:#7F848E;font-style:italic;">//没有空闲线程</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> ac </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">) (c </span><span style="color:#56B6C2;">&gt;&gt;</span><span style="color:#E06C75;"> AC_SHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> pc</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //活跃线程数</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> tc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">short</span><span style="color:#E06C75;">) (c </span><span style="color:#56B6C2;">&gt;&gt;</span><span style="color:#E06C75;"> TC_SHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> pc</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//总线程数</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> nbusy </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                        // validate saturation</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#E06C75;"> m</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ++</span><span style="color:#E06C75;">i) {        </span><span style="color:#7F848E;font-style:italic;">// two passes of odd indices</span></span>
<span class="line"><span style="color:#E5C07B;">            WorkQueue</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((v </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ws[((i </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">|</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> m]) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//取奇数索引位</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">v</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanState</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;"> SCANNING) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span><span style="color:#7F848E;font-style:italic;">//没有正在运行任务，跳出</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                ++</span><span style="color:#E06C75;">nbusy</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//正在运行任务，添加标记</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (nbusy </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> (tc </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> ctl </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> c)</span></span>
<span class="line"><span style="color:#E06C75;">            canBlock </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                 // unstable or stale</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (tc </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> pc </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E06C75;"> ac </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> w</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isEmpty</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span><span style="color:#7F848E;font-style:italic;">//总线程数大于并行度 &amp;&amp; 活动线程数大于1 &amp;&amp; 调用者任务队列为空，不需要补偿</span></span>
<span class="line"><span style="color:#C678DD;">            long</span><span style="color:#E06C75;"> nc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((AC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> AC_UNIT)) </span><span style="color:#56B6C2;">|</span></span>
<span class="line"><span style="color:#E06C75;">                    (</span><span style="color:#56B6C2;">~</span><span style="color:#E06C75;">AC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> c))</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">       // uncompensated</span></span>
<span class="line"><span style="color:#E06C75;">            canBlock </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, nc);</span><span style="color:#7F848E;font-style:italic;">//更新活跃线程数</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (tc </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> MAX_CAP </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#E06C75;">                (</span><span style="color:#E5C07B;">this</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> common </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E06C75;"> tc </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> pc </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> commonMaxSpares))</span><span style="color:#7F848E;font-style:italic;">//超出最大线程数</span></span>
<span class="line"><span style="color:#C678DD;">            throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> RejectedExecutionException</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span style="color:#98C379;">                    &quot;Thread limit exceeded replacing blocked worker&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#E06C75;"> {                                </span><span style="color:#7F848E;font-style:italic;">// similar to tryAddWorker</span></span>
<span class="line"><span style="color:#C678DD;">            boolean</span><span style="color:#E06C75;"> add </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> rs</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">      // CAS within lock</span></span>
<span class="line"><span style="color:#C678DD;">            long</span><span style="color:#E06C75;"> nc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((AC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> c) </span><span style="color:#56B6C2;">|</span></span>
<span class="line"><span style="color:#E06C75;">                    (TC_MASK </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> TC_UNIT)))</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">//计算总线程数</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (((rs </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> lockRunState</span><span style="color:#E06C75;">()) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> STOP) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                add </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapLong</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, CTL, c, nc);</span><span style="color:#7F848E;font-style:italic;">//更新总线程数</span></span>
<span class="line"><span style="color:#61AFEF;">            unlockRunState</span><span style="color:#E06C75;">(rs</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">&amp;</span><span style="color:#56B6C2;"> ~</span><span style="color:#E06C75;">RSLOCK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //运行到这里说明活跃工作线程数不足，需要创建一个新的工作线程来补偿</span></span>
<span class="line"><span style="color:#E06C75;">            canBlock </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> add </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#61AFEF;"> createWorker</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // throws on exception</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> canBlock</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明: 具体的执行看源码及注释，这里我们简单总结一下需要和不需要补偿的几种情况:</p><p><strong>需要补偿</strong> :</p><ul><li>调用者队列不为空，并且有空闲工作线程，这种情况会唤醒空闲线程(调用tryRelease方法)</li><li>池尚未停止，活跃线程数不足，这时会新建一个工作线程(调用createWorker方法)</li></ul><p><strong>不需要补偿</strong> :</p><ul><li>调用者已终止或池处于不稳定状态</li><li>总线程数大于并行度 &amp;&amp; 活动线程数大于1 &amp;&amp; 调用者任务队列为空</li></ul><h2 id="fork-join的陷阱与注意事项" tabindex="-1"><a class="header-anchor" href="#fork-join的陷阱与注意事项"><span><a href="#fork-join%E7%9A%84%E9%99%B7%E9%98%B1%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">#</a> Fork/Join的陷阱与注意事项</span></a></h2><p>使用Fork/Join框架时，需要注意一些陷阱, 在下面 <code>斐波那契数列</code>例子中你将看到示例:</p><h3 id="避免不必要的fork" tabindex="-1"><a class="header-anchor" href="#避免不必要的fork"><span><a href="#%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84fork">#</a> 避免不必要的fork()</span></a></h3><p>划分成两个子任务后，不要同时调用两个子任务的fork()方法。</p><p>表面上看上去两个子任务都fork()，然后join()两次似乎更自然。但事实证明，直接调用compute()效率更高。因为直接调用子任务的compute()方法实际上就是在当前的工作线程进行了计算(线程重用)，这比“将子任务提交到工作队列，线程又从工作队列中拿任务”快得多。</p><blockquote><p>当一个大任务被划分成两个以上的子任务时，尽可能使用前面说到的三个衍生的invokeAll方法，因为使用它们能避免不必要的fork()。</p></blockquote><h3 id="注意fork-、compute-、join-的顺序" tabindex="-1"><a class="header-anchor" href="#注意fork-、compute-、join-的顺序"><span><a href="#%E6%B3%A8%E6%84%8Ffork-%E3%80%81compute-%E3%80%81join-%E7%9A%84%E9%A1%BA%E5%BA%8F">#</a> 注意fork()、compute()、join()的顺序</span></a></h3><p>为了两个任务并行，三个方法的调用顺序需要万分注意。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E5C07B;">right</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 计算右边的任务</span></span>
<span class="line"><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> leftAns </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> left</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compute</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 计算左边的任务(同时右边任务也在计算)</span></span>
<span class="line"><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> rightAns </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> right</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 等待右边的结果</span></span>
<span class="line"><span style="color:#C678DD;">return</span><span style="color:#E06C75;"> leftAns </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> rightAns</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果我们写成:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E5C07B;">left</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 计算完左边的任务</span></span>
<span class="line"><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> leftAns </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> left</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 等待左边的计算结果</span></span>
<span class="line"><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> rightAns </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> right</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compute</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 再计算右边的任务</span></span>
<span class="line"><span style="color:#C678DD;">return</span><span style="color:#E06C75;"> leftAns </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> rightAns</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> rightAns </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> right</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compute</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 计算完右边的任务</span></span>
<span class="line"><span style="color:#E5C07B;">left</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 再计算左边的任务</span></span>
<span class="line"><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> leftAns </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> left</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // 等待左边的计算结果</span></span>
<span class="line"><span style="color:#C678DD;">return</span><span style="color:#E06C75;"> leftAns </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> rightAns</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这两种实际上都没有并行。</p><h3 id="选择合适的子任务粒度" tabindex="-1"><a class="header-anchor" href="#选择合适的子任务粒度"><span><a href="#%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E5%AD%90%E4%BB%BB%E5%8A%A1%E7%B2%92%E5%BA%A6">#</a> 选择合适的子任务粒度</span></a></h3><p>选择划分子任务的粒度(顺序执行的阈值)很重要，因为使用Fork/Join框架并不一定比顺序执行任务的效率高: 如果任务太大，则无法提高并行的吞吐量；如果任务太小，子任务的调度开销可能会大于并行计算的性能提升，我们还要考虑创建子任务、fork()子任务、线程调度以及合并子任务处理结果的耗时以及相应的内存消耗。</p><p>官方文档给出的粗略经验是: 任务应该执行<code>100~10000</code>个基本的计算步骤。决定子任务的粒度的最好办法是实践，通过实际测试结果来确定这个阈值才是“上上策”。</p><blockquote><p>和其他Java代码一样，Fork/Join框架测试时需要“预热”或者说执行几遍才会被JIT(Just-in-time)编译器优化，所以测试性能之前跑几遍程序很重要。</p></blockquote><h3 id="避免重量级任务划分与结果合并" tabindex="-1"><a class="header-anchor" href="#避免重量级任务划分与结果合并"><span><a href="#%E9%81%BF%E5%85%8D%E9%87%8D%E9%87%8F%E7%BA%A7%E4%BB%BB%E5%8A%A1%E5%88%92%E5%88%86%E4%B8%8E%E7%BB%93%E6%9E%9C%E5%90%88%E5%B9%B6">#</a> 避免重量级任务划分与结果合并</span></a></h3><p>Fork/Join的很多使用场景都用到数组或者List等数据结构，子任务在某个分区中运行，最典型的例子如并行排序和并行查找。拆分子任务以及合并处理结果的时候，应该尽量避免System.arraycopy这样耗时耗空间的操作，从而最小化任务的处理开销。</p><h2 id="再深入理解" tabindex="-1"><a class="header-anchor" href="#再深入理解"><span><a href="#%E5%86%8D%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3">#</a> 再深入理解</span></a></h2><h3 id="有哪些jdk源码中使用了fork-join思想" tabindex="-1"><a class="header-anchor" href="#有哪些jdk源码中使用了fork-join思想"><span><a href="#%E6%9C%89%E5%93%AA%E4%BA%9Bjdk%E6%BA%90%E7%A0%81%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%86fork-join%E6%80%9D%E6%83%B3">#</a> 有哪些JDK源码中使用了Fork/Join思想?</span></a></h3><p>我们常用的数组工具类 Arrays 在JDK 8之后新增的并行排序方法(parallelSort)就运用了 ForkJoinPool 的特性，还有 ConcurrentHashMap 在JDK 8之后添加的函数式方法(如forEach等)也有运用。</p><h3 id="使用executors工具类创建forkjoinpool" tabindex="-1"><a class="header-anchor" href="#使用executors工具类创建forkjoinpool"><span><a href="#%E4%BD%BF%E7%94%A8executors%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%88%9B%E5%BB%BAforkjoinpool">#</a> 使用Executors工具类创建ForkJoinPool</span></a></h3><p>Java8在Executors工具类中新增了两个工厂方法:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// parallelism定义并行级别</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> ExecutorService</span><span style="color:#61AFEF;"> newWorkStealingPool</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> parallelism)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 默认并行级别为JVM可用的处理器个数</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Runtime.getRuntime().availableProcessors()</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> ExecutorService</span><span style="color:#61AFEF;"> newWorkStealingPool</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关于fork-join异常处理" tabindex="-1"><a class="header-anchor" href="#关于fork-join异常处理"><span><a href="#%E5%85%B3%E4%BA%8Efork-join%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">#</a> 关于Fork/Join异常处理</span></a></h3><p>Java的受检异常机制一直饱受诟病，所以在ForkJoinTask的invoke()、join()方法及其衍生方法中都没有像get()方法那样抛出个ExecutionException的受检异常。</p><p>所以你可以在ForkJoinTask中看到内部把受检异常转换成了运行时异常。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> rethrow</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;"> ex) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (ex </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">        ForkJoinTask</span><span style="color:#ABB2BF;">.</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">RuntimeException</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;">uncheckedThrow</span><span style="color:#E06C75;">(ex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">SuppressWarnings</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;unchecked&quot;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E5C07B;">T</span><span style="color:#E06C75;"> extends Throwable</span><span style="color:#56B6C2;">&gt;</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> uncheckedThrow</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;"> t) throws T {</span></span>
<span class="line"><span style="color:#C678DD;">    throw</span><span style="color:#E06C75;"> (T)t</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // rely on vacuous cast</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于Java你不知道的10件事中已经指出，JVM实际并不关心这个异常是受检异常还是运行时异常，受检异常这东西完全是给Java编译器用的: 用于警告程序员这里有个异常没有处理。</p><p>但不可否认的是invoke、join()仍可能会抛出运行时异常，所以ForkJoinTask还提供了两个不提取结果和异常的方法quietlyInvoke()、quietlyJoin()，这两个方法允许你在所有任务完成后对结果和异常进行处理。</p><p>使用quitelyInvoke()和quietlyJoin()时可以配合isCompletedAbnormally()和isCompletedNormally()方法使用。</p><h2 id="一些fork-join例子" tabindex="-1"><a class="header-anchor" href="#一些fork-join例子"><span><a href="#%E4%B8%80%E4%BA%9Bfork-join%E4%BE%8B%E5%AD%90">#</a> 一些Fork/Join例子</span></a></h2><h3 id="采用fork-join来异步计算1-2-3-10000的结果" tabindex="-1"><a class="header-anchor" href="#采用fork-join来异步计算1-2-3-10000的结果"><span><a href="#%E9%87%87%E7%94%A8fork-join%E6%9D%A5%E5%BC%82%E6%AD%A5%E8%AE%A1%E7%AE%971-2-3-10000%E7%9A%84%E7%BB%93%E6%9E%9C">#</a> 采用Fork/Join来异步计算1+2+3+…+10000的结果</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> Test</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">	static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> SumTask</span><span style="color:#C678DD;"> extends</span><span style="color:#E5C07B;"> RecursiveTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Integer</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> long</span><span style="color:#E06C75;"> serialVersionUID </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1L</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">		</span></span>
<span class="line"><span style="color:#C678DD;">		final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> start</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //开始计算的数</span></span>
<span class="line"><span style="color:#C678DD;">		final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> end</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> //最后计算的数</span></span>
<span class="line"><span style="color:#E06C75;">		</span></span>
<span class="line"><span style="color:#61AFEF;">		SumTask</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;font-style:italic;"> start</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">int</span><span style="color:#E06C75;font-style:italic;"> end</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">			this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">start</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> start;</span></span>
<span class="line"><span style="color:#E5C07B;">			this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">end</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> end;</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">		@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">		protected</span><span style="color:#E5C07B;"> Integer</span><span style="color:#61AFEF;"> compute</span><span style="color:#ABB2BF;">()</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">			//如果计算量小于1000，那么分配一个线程执行if中的代码块，并返回执行结果</span></span>
<span class="line"><span style="color:#C678DD;">			if</span><span style="color:#ABB2BF;">(end </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> start </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 1000</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">				System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">out</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">println</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot; 开始执行: &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#ABB2BF;"> start </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot;-&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#ABB2BF;"> end);</span></span>
<span class="line"><span style="color:#C678DD;">				int</span><span style="color:#E06C75;"> sum</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">				for</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> i</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> start; i </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#ABB2BF;"> end; i++)</span></span>
<span class="line"><span style="color:#ABB2BF;">					sum </span><span style="color:#56B6C2;">+=</span><span style="color:#ABB2BF;"> i;</span></span>
<span class="line"><span style="color:#C678DD;">				return</span><span style="color:#ABB2BF;"> sum;</span></span>
<span class="line"><span style="color:#ABB2BF;">			}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">			//如果计算量大于1000，那么拆分为两个任务</span></span>
<span class="line"><span style="color:#E5C07B;">			SumTask</span><span style="color:#E06C75;"> task1</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> SumTask</span><span style="color:#ABB2BF;">(start, (start </span><span style="color:#56B6C2;">+</span><span style="color:#ABB2BF;"> end) </span><span style="color:#56B6C2;">/</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">			SumTask</span><span style="color:#E06C75;"> task2</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> SumTask</span><span style="color:#ABB2BF;">((start </span><span style="color:#56B6C2;">+</span><span style="color:#ABB2BF;"> end) </span><span style="color:#56B6C2;">/</span><span style="color:#D19A66;"> 2</span><span style="color:#56B6C2;"> +</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">, end);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">			//执行任务</span></span>
<span class="line"><span style="color:#E5C07B;">			task1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">			task2</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">			//获取任务执行的结果</span></span>
<span class="line"><span style="color:#C678DD;">			return</span><span style="color:#E5C07B;"> task1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">+</span><span style="color:#E5C07B;"> task2</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#E06C75;">	</span></span>
<span class="line"><span style="color:#C678DD;">	public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">[] </span><span style="color:#E06C75;font-style:italic;">args</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> throws</span><span style="color:#E5C07B;"> InterruptedException</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> ExecutionException</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">		ForkJoinPool</span><span style="color:#E06C75;"> pool</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ForkJoinPool</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">		ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Integer</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">task</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> SumTask</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">10000</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">		pool</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">submit</span><span style="color:#ABB2BF;">(task);</span></span>
<span class="line"><span style="color:#E5C07B;">		System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">out</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">println</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>执行结果</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">625</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">7</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 6251</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">6875</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">6</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 5626</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">6250</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">10</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 3751</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">4375</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">13</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 2501</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">3125</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">8</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 626</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1250</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">11</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 5001</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">5625</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">3</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 7501</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">8125</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">14</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 1251</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1875</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">4</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 9376</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">10000</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">8</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 8126</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">8750</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">0</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 1876</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">2500</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">12</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 4376</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">5000</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">5</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 8751</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">9375</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">7</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 6876</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">7500</span></span>
<span class="line"><span style="color:#E06C75;">ForkJoinPool</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">worker</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;"> 开始执行</span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 3126</span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">3750</span></span>
<span class="line"><span style="color:#D19A66;">50005000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="实现斐波那契数列" tabindex="-1"><a class="header-anchor" href="#实现斐波那契数列"><span><a href="#%E5%AE%9E%E7%8E%B0%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97">#</a> 实现斐波那契数列</span></a></h3><blockquote><p>斐波那契数列: 1、1、2、3、5、8、13、21、34、…… 公式 : F(1)=1，F(2)=1, F(n)=F(n-1)+F(n-2)(n&gt;=3，n∈N*)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> main</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;">[] args) {</span></span>
<span class="line"><span style="color:#E5C07B;">    ForkJoinPool</span><span style="color:#E06C75;"> forkJoinPool </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ForkJoinPool</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">4</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 最大并发数4</span></span>
<span class="line"><span style="color:#E5C07B;">    Fibonacci</span><span style="color:#E06C75;"> fibonacci </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Fibonacci</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">20</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> startTime </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentTimeMillis</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">    Integer</span><span style="color:#E06C75;"> result </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> forkJoinPool</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">invoke</span><span style="color:#ABB2BF;">(fibonacci);</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> endTime </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentTimeMillis</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">    System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">out</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">println</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Fork/join sum: &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#ABB2BF;"> result </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot; in &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#ABB2BF;"> (endTime </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> startTime) </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot; ms.&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//以下为官方API文档示例</span></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;">  class</span><span style="color:#E5C07B;"> Fibonacci</span><span style="color:#C678DD;"> extends</span><span style="color:#E5C07B;"> RecursiveTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Integer</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    final</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    Fibonacci</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;font-style:italic;"> n</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">n</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> n;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">    protected</span><span style="color:#E5C07B;"> Integer</span><span style="color:#61AFEF;"> compute</span><span style="color:#ABB2BF;">()</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#ABB2BF;"> (n </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#ABB2BF;"> n;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#E5C07B;">        Fibonacci</span><span style="color:#E06C75;"> f1</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Fibonacci</span><span style="color:#ABB2BF;">(n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        f1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">(); </span></span>
<span class="line"><span style="color:#E5C07B;">        Fibonacci</span><span style="color:#E06C75;"> f2</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Fibonacci</span><span style="color:#ABB2BF;">(n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E5C07B;"> f2</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compute</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">+</span><span style="color:#E5C07B;"> f1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">(); </span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然你也可以两个任务都fork，要注意的是两个任务都fork的情况，必须按照f1.fork()，f2.fork()， f2.join()，f1.join()这样的顺序，不然有性能问题，详见上面注意事项中的说明。</p><p>官方API文档是这样写到的，所以平日用invokeAll就好了。invokeAll会把传入的任务的第一个交给当前线程来执行，其他的任务都fork加入工作队列，这样等于利用当前线程也执行任务了。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#282c34;color:#abb2bf;"><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#E06C75;">{</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ...</span></span>
<span class="line"><span style="color:#E5C07B;">    Fibonacci</span><span style="color:#E06C75;"> f1 </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Fibonacci</span><span style="color:#E06C75;">(n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Fibonacci</span><span style="color:#E06C75;"> f2 </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Fibonacci</span><span style="color:#E06C75;">(n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 2</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    invokeAll</span><span style="color:#E06C75;">(f1</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">f2)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> f2</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> f1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">join</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> invokeAll</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForkJoinTask</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> tasks</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">    Throwable</span><span style="color:#E06C75;"> ex </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> last </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> tasks</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> last</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">i) {</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> tasks[i]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (t </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (ex </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                ex </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> NullPointerException</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (i </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)   </span><span style="color:#7F848E;font-style:italic;">//除了第一个都fork</span></span>
<span class="line"><span style="color:#E5C07B;">            t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">doInvoke</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E06C75;"> NORMAL </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E06C75;"> ex </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)  </span><span style="color:#7F848E;font-style:italic;">//留一个自己执行</span></span>
<span class="line"><span style="color:#E06C75;">            ex </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getException</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#E06C75;"> last</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ++</span><span style="color:#E06C75;">i) {</span></span>
<span class="line"><span style="color:#E5C07B;">        ForkJoinTask</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> tasks[i]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (t </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (ex </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cancel</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">doJoin</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E06C75;"> NORMAL)</span></span>
<span class="line"><span style="color:#E06C75;">                ex </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> t</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getException</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (ex </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#61AFEF;">        rethrow</span><span style="color:#E06C75;">(ex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,210)]))}const c=n(p,[["render",e],["__file","JUC 线程池之 Fork-Join 框架详解.html.vue"]]),i=JSON.parse(`{"path":"/posts/Java/ThreadConcurrency/JUC%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8B%20Fork-Join%20%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3.html","title":"JUC 线程池之 Fork-Join 框架详解","lang":"zh-CN","frontmatter":{"title":"JUC 线程池之 Fork-Join 框架详解","subtitle":"Java，Java开发，Java 体系","date":"2024-03-07T10:15:26.000Z","category":["Java"],"tag":["Java","Thread","concurrency"],"order":21,"description":"ForkJoinPool 是JDK 7加入的一个线程池类。Fork/Join 技术是分治算法(Divide-and-Conquer)的并行实现，它是一项可以获得良好的并行性能的简单且高效的设计技术。目的是为了帮助我们更好地利用多处理器带来的好处，使用所有可用的运算能力来提升应用的性能。 JUC 线程池之 Fork-Join 框架详解 带着BAT大厂的面...","head":[["meta",{"property":"og:url","content":"https://cactusli.net/posts/Java/ThreadConcurrency/JUC%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8B%20Fork-Join%20%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3.html"}],["meta",{"property":"og:site_name","content":"Cactus's Blog"}],["meta",{"property":"og:title","content":"JUC 线程池之 Fork-Join 框架详解"}],["meta",{"property":"og:description","content":"ForkJoinPool 是JDK 7加入的一个线程池类。Fork/Join 技术是分治算法(Divide-and-Conquer)的并行实现，它是一项可以获得良好的并行性能的简单且高效的设计技术。目的是为了帮助我们更好地利用多处理器带来的好处，使用所有可用的运算能力来提升应用的性能。 JUC 线程池之 Fork-Join 框架详解 带着BAT大厂的面..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-2.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-03-08T06:05:48.000Z"}],["meta",{"property":"article:tag","content":"Java"}],["meta",{"property":"article:tag","content":"Thread"}],["meta",{"property":"article:tag","content":"concurrency"}],["meta",{"property":"article:published_time","content":"2024-03-07T10:15:26.000Z"}],["meta",{"property":"article:modified_time","content":"2024-03-08T06:05:48.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"JUC 线程池之 Fork-Join 框架详解\\",\\"image\\":[\\"https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-2.png\\",\\"https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-3.png\\",\\"https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-5.png\\",\\"https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-1.png\\",\\"https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-4.png\\",\\"https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-forkjoin-6.png\\"],\\"datePublished\\":\\"2024-03-07T10:15:26.000Z\\",\\"dateModified\\":\\"2024-03-08T06:05:48.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Cactus li\\",\\"url\\":\\"https://cactusli.net\\"}]}"]]},"headers":[{"level":2,"title":"# 带着BAT大厂的面试问题去理解Fork/Join框架","slug":"带着bat大厂的面试问题去理解fork-join框架","link":"#带着bat大厂的面试问题去理解fork-join框架","children":[]},{"level":2,"title":"# Fork/Join框架简介","slug":"fork-join框架简介","link":"#fork-join框架简介","children":[{"level":3,"title":"# 三个模块及关系","slug":"三个模块及关系","link":"#三个模块及关系","children":[]},{"level":3,"title":"# 核心思想: 分治算法(Divide-and-Conquer)","slug":"核心思想-分治算法-divide-and-conquer","link":"#核心思想-分治算法-divide-and-conquer","children":[]},{"level":3,"title":"# 核心思想: work-stealing(工作窃取)算法","slug":"核心思想-work-stealing-工作窃取-算法","link":"#核心思想-work-stealing-工作窃取-算法","children":[]},{"level":3,"title":"# Fork/Join 框架的执行流程","slug":"fork-join-框架的执行流程","link":"#fork-join-框架的执行流程","children":[]}]},{"level":2,"title":"# Fork/Join类关系","slug":"fork-join类关系","link":"#fork-join类关系","children":[{"level":3,"title":"# ForkJoinPool继承关系","slug":"forkjoinpool继承关系","link":"#forkjoinpool继承关系","children":[]},{"level":3,"title":"# ForkJoinTask继承关系","slug":"forkjointask继承关系","link":"#forkjointask继承关系","children":[]}]},{"level":2,"title":"# Fork/Join框架源码解析","slug":"fork-join框架源码解析","link":"#fork-join框架源码解析","children":[{"level":3,"title":"# ForkJoinPool","slug":"forkjoinpool","link":"#forkjoinpool","children":[]},{"level":3,"title":"# ForkJoinTask","slug":"forkjointask","link":"#forkjointask","children":[]}]},{"level":2,"title":"# Fork/Join框架源码解析","slug":"fork-join框架源码解析-1","link":"#fork-join框架源码解析-1","children":[{"level":3,"title":"# 构造函数","slug":"构造函数","link":"#构造函数","children":[]},{"level":3,"title":"# 执行流程 - 外部任务(external/submissions task)提交","slug":"执行流程-外部任务-external-submissions-task-提交","link":"#执行流程-外部任务-external-submissions-task-提交","children":[]},{"level":3,"title":"# 执行流程: 子任务(Worker task)提交","slug":"执行流程-子任务-worker-task-提交","link":"#执行流程-子任务-worker-task-提交","children":[]},{"level":3,"title":"# 执行流程: 任务执行","slug":"执行流程-任务执行","link":"#执行流程-任务执行","children":[]},{"level":3,"title":"# 获取任务结果 - ForkJoinTask.join() / ForkJoinTask.invoke()","slug":"获取任务结果-forkjointask-join-forkjointask-invoke","link":"#获取任务结果-forkjointask-join-forkjointask-invoke","children":[]}]},{"level":2,"title":"# Fork/Join的陷阱与注意事项","slug":"fork-join的陷阱与注意事项","link":"#fork-join的陷阱与注意事项","children":[{"level":3,"title":"# 避免不必要的fork()","slug":"避免不必要的fork","link":"#避免不必要的fork","children":[]},{"level":3,"title":"# 注意fork()、compute()、join()的顺序","slug":"注意fork-、compute-、join-的顺序","link":"#注意fork-、compute-、join-的顺序","children":[]},{"level":3,"title":"# 选择合适的子任务粒度","slug":"选择合适的子任务粒度","link":"#选择合适的子任务粒度","children":[]},{"level":3,"title":"# 避免重量级任务划分与结果合并","slug":"避免重量级任务划分与结果合并","link":"#避免重量级任务划分与结果合并","children":[]}]},{"level":2,"title":"# 再深入理解","slug":"再深入理解","link":"#再深入理解","children":[{"level":3,"title":"# 有哪些JDK源码中使用了Fork/Join思想?","slug":"有哪些jdk源码中使用了fork-join思想","link":"#有哪些jdk源码中使用了fork-join思想","children":[]},{"level":3,"title":"# 使用Executors工具类创建ForkJoinPool","slug":"使用executors工具类创建forkjoinpool","link":"#使用executors工具类创建forkjoinpool","children":[]},{"level":3,"title":"# 关于Fork/Join异常处理","slug":"关于fork-join异常处理","link":"#关于fork-join异常处理","children":[]}]},{"level":2,"title":"# 一些Fork/Join例子","slug":"一些fork-join例子","link":"#一些fork-join例子","children":[{"level":3,"title":"# 采用Fork/Join来异步计算1+2+3+…+10000的结果","slug":"采用fork-join来异步计算1-2-3-10000的结果","link":"#采用fork-join来异步计算1-2-3-10000的结果","children":[]},{"level":3,"title":"# 实现斐波那契数列","slug":"实现斐波那契数列","link":"#实现斐波那契数列","children":[]}]}],"git":{"createdTime":1709869916000,"updatedTime":1709877948000,"contributors":[{"name":"lixuanfengs","email":"1183895890@qq.com","commits":2}]},"readingTime":{"minutes":49.79,"words":14936},"filePathRelative":"posts/Java/ThreadConcurrency/JUC 线程池之 Fork-Join 框架详解.md","localizedDate":"2024年3月7日","excerpt":"<blockquote>\\n<p>ForkJoinPool 是JDK 7加入的一个线程池类。Fork/Join 技术是分治算法(Divide-and-Conquer)的并行实现，它是一项可以获得良好的并行性能的简单且高效的设计技术。目的是为了帮助我们更好地利用多处理器带来的好处，使用所有可用的运算能力来提升应用的性能。</p>\\n</blockquote>\\n<ul>\\n<li>JUC 线程池之 Fork-Join 框架详解\\n<ul>\\n<li><a href=\\"#%E5%B8%A6%E7%9D%80bat%E5%A4%A7%E5%8E%82%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8E%BB%E7%90%86%E8%A7%A3forkjoin%E6%A1%86%E6%9E%B6\\">带着BAT大厂的面试问题去理解Fork/Join框架</a></li>\\n<li>Fork/Join框架简介\\n<ul>\\n<li><a href=\\"#%E4%B8%89%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B3%E7%B3%BB\\">三个模块及关系</a></li>\\n<li><a href=\\"#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-%E5%88%86%E6%B2%BB%E7%AE%97%E6%B3%95divide-and-conquer\\">核心思想: 分治算法(Divide-and-Conquer)</a></li>\\n<li><a href=\\"#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-work-stealing%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%AE%97%E6%B3%95\\">核心思想: work-stealing(工作窃取)算法</a></li>\\n<li><a href=\\"#forkjoin-%E6%A1%86%E6%9E%B6%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B\\">Fork/Join 框架的执行流程</a></li>\\n</ul>\\n</li>\\n<li>Fork/Join类关系\\n<ul>\\n<li><a href=\\"#forkjoinpool%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB\\">ForkJoinPool继承关系</a></li>\\n<li><a href=\\"#forkjointask%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB\\">ForkJoinTask继承关系</a></li>\\n</ul>\\n</li>\\n<li>Fork/Join框架源码解析\\n<ul>\\n<li>ForkJoinPool\\n<ul>\\n<li><a href=\\"#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0\\">核心参数</a></li>\\n<li><a href=\\"#forkjoinpoolworkqueue-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7\\">ForkJoinPool.WorkQueue 中的相关属性</a></li>\\n</ul>\\n</li>\\n<li>ForkJoinTask\\n<ul>\\n<li><a href=\\"#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0-1\\">核心参数</a></li>\\n</ul>\\n</li>\\n</ul>\\n</li>\\n<li>Fork/Join框架源码解析\\n<ul>\\n<li><a href=\\"#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0\\">构造函数</a></li>\\n<li>执行流程 - 外部任务(external/submissions task)提交\\n<ul>\\n<li><a href=\\"#externalpushforkjointask-task\\">externalPush(ForkJoinTask task)</a></li>\\n<li><a href=\\"#externalsubmitforkjointask-task\\">externalSubmit(ForkJoinTask task)</a></li>\\n<li><a href=\\"https://pdai.tech/md/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#signalworkworkqueue-ws-workqueue-q\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">signalWork(WorkQueue[] ws, WorkQueue q)</a></li>\\n<li><a href=\\"#tryaddworkerlong-c\\">tryAddWorker(long c)</a></li>\\n<li><a href=\\"#createworker\\">createWorker()</a></li>\\n<li><a href=\\"#registerworker\\">registerWorker()</a></li>\\n<li><a href=\\"#%E5%B0%8F%E7%BB%93\\">小结</a></li>\\n</ul>\\n</li>\\n<li>执行流程: 子任务(Worker task)提交\\n<ul>\\n<li><a href=\\"#forkjointaskfork\\">ForkJoinTask.fork()</a></li>\\n<li><a href=\\"#forkjoinpoolworkqueuepush\\">ForkJoinPool.WorkQueue.push()</a></li>\\n<li><a href=\\"#%E5%B0%8F%E7%BB%93-1\\">小结</a></li>\\n</ul>\\n</li>\\n<li>执行流程: 任务执行\\n<ul>\\n<li><a href=\\"#forkjoinworkerthreadrun\\">ForkJoinWorkerThread.run()</a></li>\\n<li><a href=\\"#forkjoinpoolrunworkerworkqueue-w\\">ForkJoinPool.runWorker(WorkQueue w)</a></li>\\n<li><a href=\\"#forkjoinpoolscanworkqueue-w-int-r\\">ForkJoinPool.scan(WorkQueue w, int r)</a></li>\\n<li><a href=\\"#forkjoinpoolawaitworkworkqueue-w-int-r\\">ForkJoinPool.awaitWork(WorkQueue w, int r)</a></li>\\n<li><a href=\\"#workqueueruntask\\">WorkQueue.runTask()</a></li>\\n<li><a href=\\"#forkjoinpoolderegisterworkerforkjoinworkerthread-wt-throwable-ex\\">ForkJoinPool.deregisterWorker(ForkJoinWorkerThread wt, Throwable ex)</a></li>\\n<li><a href=\\"#%E5%B0%8F%E7%BB%93-2\\">小结</a></li>\\n</ul>\\n</li>\\n<li>获取任务结果 - ForkJoinTask.join() / ForkJoinTask.invoke()\\n<ul>\\n<li><a href=\\"#forkjointaskexternalawaitdone\\">ForkJoinTask.externalAwaitDone()</a></li>\\n<li><a href=\\"#forkjoinpoolawaitjoin\\">ForkJoinPool.awaitJoin()</a></li>\\n<li><a href=\\"#workqueuetryremoveandexecforkjointask-task\\">WorkQueue.tryRemoveAndExec(ForkJoinTask task)</a></li>\\n<li><a href=\\"#forkjoinpoolhelpstealerworkqueue-w-forkjointask-task\\">ForkJoinPool.helpStealer(WorkQueue w, ForkJoinTask task)</a></li>\\n<li><a href=\\"#forkjoinpooltrycompensateworkqueue-w\\">ForkJoinPool.tryCompensate(WorkQueue w)</a></li>\\n</ul>\\n</li>\\n</ul>\\n</li>\\n<li>Fork/Join的陷阱与注意事项\\n<ul>\\n<li><a href=\\"#%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84fork\\">避免不必要的fork()</a></li>\\n<li><a href=\\"#%E6%B3%A8%E6%84%8Fforkcomputejoin%E7%9A%84%E9%A1%BA%E5%BA%8F\\">注意fork()、compute()、join()的顺序</a></li>\\n<li><a href=\\"#%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E5%AD%90%E4%BB%BB%E5%8A%A1%E7%B2%92%E5%BA%A6\\">选择合适的子任务粒度</a></li>\\n<li><a href=\\"#%E9%81%BF%E5%85%8D%E9%87%8D%E9%87%8F%E7%BA%A7%E4%BB%BB%E5%8A%A1%E5%88%92%E5%88%86%E4%B8%8E%E7%BB%93%E6%9E%9C%E5%90%88%E5%B9%B6\\">避免重量级任务划分与结果合并</a></li>\\n</ul>\\n</li>\\n<li>再深入理解\\n<ul>\\n<li><a href=\\"#%E6%9C%89%E5%93%AA%E4%BA%9Bjdk%E6%BA%90%E7%A0%81%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%86forkjoin%E6%80%9D%E6%83%B3\\">有哪些JDK源码中使用了Fork/Join思想?</a></li>\\n<li><a href=\\"#%E4%BD%BF%E7%94%A8executors%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%88%9B%E5%BB%BAforkjoinpool\\">使用Executors工具类创建ForkJoinPool</a></li>\\n<li><a href=\\"#%E5%85%B3%E4%BA%8Eforkjoin%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86\\">关于Fork/Join异常处理</a></li>\\n</ul>\\n</li>\\n<li>一些Fork/Join例子\\n<ul>\\n<li><a href=\\"#%E9%87%87%E7%94%A8forkjoin%E6%9D%A5%E5%BC%82%E6%AD%A5%E8%AE%A1%E7%AE%9712310000%E7%9A%84%E7%BB%93%E6%9E%9C\\">采用Fork/Join来异步计算1+2+3+…+10000的结果</a></li>\\n<li><a href=\\"#%E5%AE%9E%E7%8E%B0%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97\\">实现斐波那契数列</a></li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0\\">参考文章</a></li>\\n</ul>\\n</li>\\n</ul>","autoDesc":true}`);export{c as comp,i as data};
