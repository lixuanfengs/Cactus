<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.32" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://cactusli.net/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86.html"><meta property="og:site_name" content="Cactus's Blog"><meta property="og:title" content="è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†"><meta property="og:description" content="æœ¬æ–‡è½¬è½½è‡ª ç¾å›¢æŠ€æœ¯å›¢é˜Ÿèƒ¡å¥çš„Java åŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µåœ¨æ–°çª—å£æ‰“å¼€, é€šè¿‡å­¦ä¹ java agentæ–¹å¼è¿›è¡ŒåŠ¨æ€è°ƒè¯•äº†è§£ç›®å‰å¾ˆå¤šå¤§å‚å¼€æºçš„ä¸€äº›åŸºäºæ­¤çš„è°ƒè¯•å·¥å…·ã€‚ è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç† ç®€ä»‹ Agentçš„å®ç°æ¨¡å¼ é€šè¿‡Java Instrumentation API å¯åŠ¨æ—¶åŠ è½½Agent å‚æ•°è§£æ æ‰§è¡ŒåŠ è½½æ“ä½œ instrumentåŠ¨..."><meta property="og:type" content="article"><meta property="og:image" content="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-1.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-22T10:01:39.000Z"><meta property="article:author" content="Cactus li"><meta property="article:tag" content="Java"><meta property="article:tag" content="JVM"><meta property="article:published_time" content="2024-03-17T17:08:41.000Z"><meta property="article:modified_time" content="2024-03-22T10:01:39.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†","image":["https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-1.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-2.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-3.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-4.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-5.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-6.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-7.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-8.jpg"],"datePublished":"2024-03-17T17:08:41.000Z","dateModified":"2024-03-22T10:01:39.000Z","author":[{"@type":"Person","name":"Cactus li","url":"https://cactusli.net"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><link rel="alternate" type="application/rss+xml" href="https://cactusli.net/rss.xml" title="Cactus's Blog RSS Feed"><title>è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç† | Cactus's Blog</title><meta name="description" content="æœ¬æ–‡è½¬è½½è‡ª ç¾å›¢æŠ€æœ¯å›¢é˜Ÿèƒ¡å¥çš„Java åŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µåœ¨æ–°çª—å£æ‰“å¼€, é€šè¿‡å­¦ä¹ java agentæ–¹å¼è¿›è¡ŒåŠ¨æ€è°ƒè¯•äº†è§£ç›®å‰å¾ˆå¤šå¤§å‚å¼€æºçš„ä¸€äº›åŸºäºæ­¤çš„è°ƒè¯•å·¥å…·ã€‚ è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç† ç®€ä»‹ Agentçš„å®ç°æ¨¡å¼ é€šè¿‡Java Instrumentation API å¯åŠ¨æ—¶åŠ è½½Agent å‚æ•°è§£æ æ‰§è¡ŒåŠ è½½æ“ä½œ instrumentåŠ¨...">
    <link rel="preload" href="/assets/style-RJ_wpqWV.css" as="style"><link rel="stylesheet" href="/assets/style-RJ_wpqWV.css">
    <link rel="modulepreload" href="/assets/app-Ntmq5oN3.js"><link rel="modulepreload" href="/assets/è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†.html-XPq9i-g2.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><!--[--><!-- å®šä¹‰ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºå±•ç¤ºå¤©æ°”æ’ä»¶ --><div id="he-plugin-simple"></div><!--]--><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="ä¸»é¡µ"><span class="font-icon icon iconfont icon-zhuye" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/demo/" aria-label="å¯¼èˆª"><span class="font-icon icon iconfont icon-daohang" style=""></span>å¯¼èˆª<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="çŸ¥è¯†ä½“ç³»"><span class="title"><span class="font-icon icon iconfont icon-biji" style=""></span>çŸ¥è¯†ä½“ç³»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>åç«¯</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link active" href="/posts/Java/" aria-label="Java"><span class="font-icon icon iconfont icon-java" style=""></span>Java<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/posts/Python/" aria-label="Python"><span class="font-icon icon iconfont icon-python" style=""></span>Python<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>å‰ç«¯</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/webs/ES6/" aria-label="ES6"><span class="font-icon icon iconfont icon-code" style=""></span>ES6<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/webs/TypeScript/" aria-label="TypeScript"><span class="font-icon icon iconfont icon-code" style=""></span>TypeScript<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æœåŠ¡å™¨</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/linuxs/Linux/" aria-label="Linux"><span class="font-icon icon iconfont icon-linux" style=""></span>Linux<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>åšå®¢ç›¸å…³</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/blog/" aria-label="åšå®¢ç›¸å…³"><span class="font-icon icon iconfont icon-blog" style=""></span>åšå®¢ç›¸å…³<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/tutorial/" aria-label="å·¥å…·|è½¯ä»¶"><span class="font-icon icon iconfont icon-ruanjian" style=""></span>å·¥å…·|è½¯ä»¶<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/collect.html" aria-label="æ”¶è—"><span class="font-icon icon iconfont icon-shoucang1" style=""></span>æ”¶è—<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/visitorsbook.html" aria-label="ç•™è¨€æ¿"><span class="font-icon icon iconfont icon-liuyanpinglun" style=""></span>ç•™è¨€æ¿<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/friend.html" aria-label="å‹é“¾"><span class="font-icon icon iconfont icon-duankailianjie" style=""></span>å‹é“¾<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="å…³äº"><span class="title"><span class="font-icon icon iconfont icon-guanyu" style=""></span>å…³äº</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/intro.html" aria-label="å…³äºæˆ‘"><span class="font-icon icon iconfont icon-people" style=""></span>å…³äºæˆ‘<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/about.html" aria-label="å…³äºæœ¬ç«™"><span class="font-icon icon iconfont icon-info" style=""></span>å…³äºæœ¬ç«™<!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/lixuanfengs/Cactus" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!----><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/" aria-label="Java çŸ¥è¯†ä½“ç³»"><span class="font-icon icon iconfont icon-java" style=""></span>Java çŸ¥è¯†ä½“ç³»<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="vp-sidebar-title">Java åŸºç¡€</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-list" style=""></span><span class="vp-sidebar-title">Java é›†åˆæ¡†æ¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-proxy" style=""></span><span class="vp-sidebar-title">Java å¤šçº¿ç¨‹å’Œå¹¶å‘</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-IO" style=""></span><span class="vp-sidebar-title">Java IO/NIO/AIO</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="vp-sidebar-title">Java8 æ–°ç‰¹æ€§</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="vp-sidebar-title">JVM æ ¸å¿ƒçŸ¥è¯†ç‚¹</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/JVM%20%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3.html" aria-label="JVM ç›¸å…³çŸ¥è¯†ä½“ç³»è¯¦è§£"><!---->JVM ç›¸å…³çŸ¥è¯†ä½“ç³»è¯¦è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%E4%B9%8B%E7%B1%BB%E5%AD%97%E8%8A%82%E7%A0%81%E8%AF%A6%E8%A7%A3.html" aria-label="JVM åŸºç¡€ä¹‹ç±»å­—èŠ‚ç è¯¦è§£"><!---->JVM åŸºç¡€ä¹‹ç±»å­—èŠ‚ç è¯¦è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E5%A2%9E%E5%BC%BA%E6%8A%80%E6%9C%AF.html" aria-label="JVM åŸºç¡€ä¹‹å­—èŠ‚ç çš„å¢å¼ºæŠ€æœ¯"><!---->JVM åŸºç¡€ä¹‹å­—èŠ‚ç çš„å¢å¼ºæŠ€æœ¯<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%E4%B9%8BJava%20%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6.html" aria-label="JVM åŸºç¡€ä¹‹Java ç±»åŠ è½½æœºåˆ¶"><!---->JVM åŸºç¡€ä¹‹Java ç±»åŠ è½½æœºåˆ¶<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%E4%B9%8BJVM%20%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84.html" aria-label="JVM åŸºç¡€ä¹‹JVM å†…å­˜ç»“æ„"><!---->JVM åŸºç¡€ä¹‹JVM å†…å­˜ç»“æ„<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%E4%B9%8B%20Java%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%BC%95%E5%85%A5.html" aria-label="JVM åŸºç¡€ä¹‹ Java å†…å­˜æ¨¡å‹å¼•å…¥"><!---->JVM åŸºç¡€ä¹‹ Java å†…å­˜æ¨¡å‹å¼•å…¥<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%E4%B9%8B%20Java%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E8%AF%A6%E8%A7%A3.html" aria-label="JVM åŸºç¡€ä¹‹ Java å†…å­˜æ¨¡å‹è¯¦è§£"><!---->JVM åŸºç¡€ä¹‹ Java å†…å­˜æ¨¡å‹è¯¦è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/GC%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html" aria-label="GC åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†"><!---->GC åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/GC%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B9%8BG1%E8%AF%A6%E8%A7%A3.html" aria-label="GC åƒåœ¾å›æ”¶å™¨ä¹‹G1è¯¦è§£"><!---->GC åƒåœ¾å›æ”¶å™¨ä¹‹G1è¯¦è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/GC%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B9%8BZGC%E8%AF%A6%E8%A7%A3.html" aria-label="GC åƒåœ¾å›æ”¶å™¨ä¹‹ZGCè¯¦è§£"><!---->GC åƒåœ¾å›æ”¶å™¨ä¹‹ZGCè¯¦è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/GC%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B9%8BCMS%20GC%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3.html" aria-label="GC åƒåœ¾å›æ”¶å™¨ä¹‹CMS GCé—®é¢˜åˆ†æä¸è§£å†³"><!---->GC åƒåœ¾å›æ”¶å™¨ä¹‹CMS GCé—®é¢˜åˆ†æä¸è§£å†³<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20JVM%20%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0.html" aria-label="è°ƒè¯•æ’é”™ä¹‹ JVM è°ƒä¼˜å‚æ•°"><!---->è°ƒè¯•æ’é”™ä¹‹ JVM è°ƒä¼˜å‚æ•°<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E4%B9%8B%E5%A0%86%E5%86%85%E5%AD%98%E5%92%8CMetaSpace%E5%86%85%E5%AD%98.html" aria-label="è°ƒè¯•æ’é”™ Java å†…å­˜åˆ†æä¹‹å †å†…å­˜å’ŒMetaSpaceå†…å­˜"><!---->è°ƒè¯•æ’é”™ Java å†…å­˜åˆ†æä¹‹å †å†…å­˜å’ŒMetaSpaceå†…å­˜<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E4%B9%8B%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98.html" aria-label="è°ƒè¯•æ’é”™ Java å†…å­˜åˆ†æä¹‹å †å¤–å†…å­˜"><!---->è°ƒè¯•æ’é”™ Java å†…å­˜åˆ†æä¹‹å †å¤–å†…å­˜<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E7%BA%BF%E7%A8%8B%E5%88%86%E6%9E%90%E4%B9%8B%E7%BA%BF%E7%A8%8BDump%E5%88%86%E6%9E%90.html" aria-label="è°ƒè¯•æ’é”™ Java çº¿ç¨‹åˆ†æä¹‹çº¿ç¨‹Dumpåˆ†æ"><!---->è°ƒè¯•æ’é”™ Java çº¿ç¨‹åˆ†æä¹‹çº¿ç¨‹Dumpåˆ†æ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8BLinux%E5%91%BD%E4%BB%A4.html" aria-label="è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹Linuxå‘½ä»¤"><!---->è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹Linuxå‘½ä»¤<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8B%E5%B7%A5%E5%85%B7%E5%8D%95.html" aria-label="è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹å·¥å…·å•"><!---->è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹å·¥å…·å•<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8BJVM%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7.html" aria-label="è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹JVMå¯è§†åŒ–å·¥å…·"><!---->è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹JVMå¯è§†åŒ–å·¥å…·<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8B%E5%BA%94%E7%94%A8%E5%9C%A8%E7%BA%BF%E8%B0%83%E8%AF%95Arthas.html" aria-label="è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹åº”ç”¨åœ¨çº¿è°ƒè¯•Arthas"><!---->è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹åº”ç”¨åœ¨çº¿è°ƒè¯•Arthas<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8B%E4%BD%BF%E7%94%A8IDEA%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E5%92%8C%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95.html" aria-label="è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•"><!---->è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86.html" aria-label="è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†"><!---->è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://cactusli.net" target="_blank" rel="noopener noreferrer">Cactus li</a></span><span property="author" content="Cactus li"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-17T17:08:41.000Z"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86.html">...</span></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 32 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT32M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category4 clickable" role="navigation">Java</span><!--]--><meta property="articleSection" content="Java"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag4 clickable" role="navigation">Java</span><span class="page-tag-item tag1 clickable" role="navigation">JVM</span><!--]--><meta property="keywords" content="Java,JVM"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç®€ä»‹"># ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#agentçš„å®ç°æ¨¡å¼"># Agentçš„å®ç°æ¨¡å¼</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é€šè¿‡java-instrumentation-api"># é€šè¿‡Java Instrumentation API</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å¯åŠ¨æ—¶åŠ è½½agent"># å¯åŠ¨æ—¶åŠ è½½Agent</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°è§£æ"># å‚æ•°è§£æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ‰§è¡ŒåŠ è½½æ“ä½œ"># æ‰§è¡ŒåŠ è½½æ“ä½œ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#instrumentåŠ¨æ€é“¾æ¥åº“"># instrumentåŠ¨æ€é“¾æ¥åº“</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#è¿è¡Œæ—¶åŠ è½½agent"># è¿è¡Œæ—¶åŠ è½½Agent</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#attachlistener"># AttachListener</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿è¡Œæ—¶åŠ è½½agentçš„å®ç°"># è¿è¡Œæ—¶åŠ è½½Agentçš„å®ç°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#loadå‘½ä»¤çš„å®ç°"># loadå‘½ä»¤çš„å®ç°</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶"># åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚"># é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#java-debug-tool"># Java-debug-tool</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#java-debug-toolæ•´ä½“æ¶æ„"># Java-debug-toolæ•´ä½“æ¶æ„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ"># Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°"># Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ"># Java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å‚è€ƒæ–‡çŒ®"># å‚è€ƒæ–‡çŒ®</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><blockquote><p>æœ¬æ–‡è½¬è½½è‡ª ç¾å›¢æŠ€æœ¯å›¢é˜Ÿèƒ¡å¥çš„<a href="https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html" target="_blank" rel="noopener noreferrer">Java åŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µåœ¨æ–°çª—å£æ‰“å¼€<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, é€šè¿‡å­¦ä¹ java agentæ–¹å¼è¿›è¡ŒåŠ¨æ€è°ƒè¯•äº†è§£ç›®å‰å¾ˆå¤šå¤§å‚å¼€æºçš„ä¸€äº›åŸºäºæ­¤çš„è°ƒè¯•å·¥å…·ã€‚</p></blockquote><ul><li>è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç† <ul><li><a href="#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a></li><li>Agentçš„å®ç°æ¨¡å¼ <ul><li><a href="#%E9%80%9A%E8%BF%87java-instrumentation-api">é€šè¿‡Java Instrumentation API</a></li></ul></li><li>å¯åŠ¨æ—¶åŠ è½½Agent <ul><li><a href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90">å‚æ•°è§£æ</a></li><li><a href="#%E6%89%A7%E8%A1%8C%E5%8A%A0%E8%BD%BD%E6%93%8D%E4%BD%9C">æ‰§è¡ŒåŠ è½½æ“ä½œ</a></li><li><a href="#instrument%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93">instrumentåŠ¨æ€é“¾æ¥åº“</a></li></ul></li><li>è¿è¡Œæ—¶åŠ è½½Agent <ul><li><a href="#attachlistener">AttachListener</a></li><li><a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A0%E8%BD%BDagent%E7%9A%84%E5%AE%9E%E7%8E%B0">è¿è¡Œæ—¶åŠ è½½Agentçš„å®ç°</a></li><li><a href="#load%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0">loadå‘½ä»¤çš„å®ç°</a></li></ul></li><li><a href="#%E5%8A%A8%E6%80%81%E5%AD%97%E8%8A%82%E7%A0%81%E4%BF%AE%E6%94%B9%E7%9A%84%E9%99%90%E5%88%B6">åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶</a></li><li><a href="#%E9%87%8D%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82">é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚</a></li><li>Java-debug-tool <ul><li><a href="#java-debug-tool%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84">Java-debug-toolæ•´ä½“æ¶æ„</a></li><li>Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ <ul><li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA">å­—èŠ‚ç å¢å¼º</a></li><li><a href="#advice%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F">Adviceçš„å·¥ä½œæ–¹å¼</a></li></ul></li><li>Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç° <ul><li><a href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C">å‘½ä»¤æ‰§è¡Œ</a></li><li><a href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E8%A7%86%E5%9B%BE">è·å–æ–¹æ³•æ‰§è¡Œè§†å›¾</a></li></ul></li><li><a href="#java-debug-tool%E4%B8%8E%E5%90%8C%E7%B1%BB%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90">Java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ</a></li></ul></li><li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">å‚è€ƒæ–‡çŒ®</a></li></ul></li></ul><h2 id="ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#ç®€ä»‹"><span><a href="#%E7%AE%80%E4%BB%8B">#</a> ç®€ä»‹</span></a></h2><p>æ–­ç‚¹è°ƒè¯•æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„è°ƒè¯•æ‰‹æ®µï¼Œå®ƒå¯ä»¥è·å–åˆ°æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å˜é‡ä¿¡æ¯ï¼Œå¹¶å¯ä»¥è§‚å¯Ÿåˆ°æ–¹æ³•çš„æ‰§è¡Œè·¯å¾„ã€‚ä½†æ–­ç‚¹è°ƒè¯•ä¼šåœ¨æ–­ç‚¹ä½ç½®åœé¡¿ï¼Œä½¿å¾—æ•´ä¸ªåº”ç”¨åœæ­¢å“åº”ã€‚åœ¨çº¿ä¸Šåœé¡¿åº”ç”¨æ˜¯è‡´å‘½çš„ï¼ŒåŠ¨æ€è°ƒè¯•æŠ€æœ¯ç»™äº†æˆ‘ä»¬åˆ›é€ æ–°çš„è°ƒè¯•æ¨¡å¼çš„æƒ³è±¡ç©ºé—´ã€‚æœ¬æ–‡å°†ç ”ç©¶Javaè¯­è¨€ä¸­çš„åŠ¨æ€è°ƒè¯•æŠ€æœ¯ï¼Œé¦–å…ˆæ¦‚æ‹¬JavaåŠ¨æ€è°ƒè¯•æ‰€æ¶‰åŠçš„æŠ€æœ¯åŸºç¡€ï¼Œæ¥ç€ä»‹ç»æˆ‘ä»¬åœ¨JavaåŠ¨æ€è°ƒè¯•é¢†åŸŸçš„æ€è€ƒåŠå®è·µï¼Œé€šè¿‡ç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯ï¼Œè®¾è®¡å¹¶å®ç°äº†ä¸€ç§å…·å¤‡åŠ¨æ€æ€§çš„æ–­ç‚¹è°ƒè¯•å·¥å…·Java-debug-toolï¼Œæ˜¾è‘—æé«˜äº†æ•…éšœæ’æŸ¥æ•ˆç‡ã€‚</p><p>JVMTI (JVM Tool Interface)æ˜¯Javaè™šæ‹Ÿæœºå¯¹å¤–æä¾›çš„Nativeç¼–ç¨‹æ¥å£ï¼Œé€šè¿‡JVMTIï¼Œå¤–éƒ¨è¿›ç¨‹å¯ä»¥è·å–åˆ°è¿è¡Œæ—¶JVMçš„è¯¸å¤šä¿¡æ¯ï¼Œæ¯”å¦‚çº¿ç¨‹ã€GCç­‰ã€‚Agentæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç›®æ ‡JVMçš„ç‰¹å®šç¨‹åºï¼Œå®ƒçš„èŒè´£æ˜¯è´Ÿè´£ä»ç›®æ ‡JVMä¸­è·å–æ•°æ®ï¼Œç„¶åå°†æ•°æ®ä¼ é€’ç»™å¤–éƒ¨è¿›ç¨‹ã€‚åŠ è½½Agentçš„æ—¶æœºå¯ä»¥æ˜¯ç›®æ ‡JVMå¯åŠ¨ä¹‹æ—¶ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ç›®æ ‡JVMè¿è¡Œæ—¶è¿›è¡ŒåŠ è½½ï¼Œè€Œåœ¨ç›®æ ‡JVMè¿è¡Œæ—¶è¿›è¡ŒAgentåŠ è½½å…·å¤‡åŠ¨æ€æ€§ï¼Œå¯¹äºæ—¶æœºæœªçŸ¥çš„Debugåœºæ™¯æ¥è¯´éå¸¸å®ç”¨ã€‚ä¸‹é¢å°†è¯¦ç»†åˆ†æJava AgentæŠ€æœ¯çš„å®ç°ç»†èŠ‚ã€‚</p><h2 id="agentçš„å®ç°æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#agentçš„å®ç°æ¨¡å¼"><span><a href="#agent%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%BC%8F">#</a> Agentçš„å®ç°æ¨¡å¼</span></a></h2><p>JVMTIæ˜¯ä¸€å¥—Nativeæ¥å£ï¼Œåœ¨Java SE 5ä¹‹å‰ï¼Œè¦å®ç°ä¸€ä¸ªAgentåªèƒ½é€šè¿‡ç¼–å†™Nativeä»£ç æ¥å®ç°ã€‚ä»Java SE 5å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨Javaçš„Instrumentationæ¥å£(java.lang.instrument)æ¥ç¼–å†™Agentã€‚æ— è®ºæ˜¯é€šè¿‡Nativeçš„æ–¹å¼è¿˜æ˜¯é€šè¿‡Java Instrumentationæ¥å£çš„æ–¹å¼æ¥ç¼–å†™Agentï¼Œå®ƒä»¬çš„å·¥ä½œéƒ½æ˜¯å€ŸåŠ©JVMTIæ¥è¿›è¡Œå®Œæˆï¼Œä¸‹é¢ä»‹ç»é€šè¿‡Java Instrumentationæ¥å£ç¼–å†™Agentçš„æ–¹æ³•ã€‚</p><h3 id="é€šè¿‡java-instrumentation-api" tabindex="-1"><a class="header-anchor" href="#é€šè¿‡java-instrumentation-api"><span><a href="#%E9%80%9A%E8%BF%87java-instrumentation-api">#</a> é€šè¿‡Java Instrumentation API</span></a></h3><ul><li>å®ç°Agentå¯åŠ¨æ–¹æ³•</li></ul><p>Java Agentæ”¯æŒç›®æ ‡JVMå¯åŠ¨æ—¶åŠ è½½ï¼Œä¹Ÿæ”¯æŒåœ¨ç›®æ ‡JVMè¿è¡Œæ—¶åŠ è½½ï¼Œè¿™ä¸¤ç§ä¸åŒçš„åŠ è½½æ¨¡å¼ä¼šä½¿ç”¨ä¸åŒçš„å…¥å£å‡½æ•°ï¼Œå¦‚æœéœ€è¦åœ¨ç›®æ ‡JVMå¯åŠ¨çš„åŒæ—¶åŠ è½½Agentï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;">[</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">] </span><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> premain</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> agentArgs</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Instrumentation</span><span style="color:#E06C75;"> inst)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">[</span><span style="color:#D19A66;">2</span><span style="color:#E06C75;">] </span><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> premain</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> agentArgs)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>JVMå°†é¦–å…ˆå¯»æ‰¾[1]ï¼Œå¦‚æœæ²¡æœ‰å‘ç°[1]ï¼Œå†å¯»æ‰¾[2]ã€‚å¦‚æœå¸Œæœ›åœ¨ç›®æ ‡JVMè¿è¡Œæ—¶åŠ è½½Agentï¼Œåˆ™éœ€è¦å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;">[</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">] </span><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> agentmain</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> agentArgs</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Instrumentation</span><span style="color:#E06C75;"> inst)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">[</span><span style="color:#D19A66;">2</span><span style="color:#E06C75;">] </span><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> agentmain</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> agentArgs)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸¤ç»„æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°AgentArgsæ˜¯éšåŒ â€œâ€“ javaagentâ€ä¸€èµ·ä¼ å…¥çš„ç¨‹åºå‚æ•°ï¼Œå¦‚æœè¿™ä¸ªå­—ç¬¦ä¸²ä»£è¡¨äº†å¤šä¸ªå‚æ•°ï¼Œå°±éœ€è¦è‡ªå·±è§£æè¿™äº›å‚æ•°ã€‚instæ˜¯Instrumentationç±»å‹çš„å¯¹è±¡ï¼Œæ˜¯JVMè‡ªåŠ¨ä¼ å…¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿è¿™ä¸ªå‚æ•°è¿›è¡Œç±»å¢å¼ºç­‰æ“ä½œã€‚</p><ul><li>æŒ‡å®šMain-Class</li></ul><p>Agentéœ€è¦æ‰“åŒ…æˆä¸€ä¸ªjaråŒ…ï¼Œåœ¨ManiFestå±æ€§ä¸­æŒ‡å®šâ€œPremain-Classâ€æˆ–è€…â€œAgent-Classâ€ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;">Premain</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">Class</span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> class</span></span>
<span class="line"><span style="color:#E06C75;">Agent</span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;">Class</span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> class</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æŒ‚è½½åˆ°ç›®æ ‡JVM</li></ul><p>å°†ç¼–å†™çš„Agentæ‰“æˆjaråŒ…åï¼Œå°±å¯ä»¥æŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šå»äº†ã€‚å¦‚æœé€‰æ‹©åœ¨ç›®æ ‡JVMå¯åŠ¨æ—¶åŠ è½½Agentï¼Œåˆ™å¯ä»¥ä½¿ç”¨ â€œ-javaagent:[=]â€œï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥ä½¿ç”¨â€œJava -Helpâ€æ¥æŸ¥çœ‹ã€‚å¦‚æœæƒ³è¦åœ¨è¿è¡Œæ—¶æŒ‚è½½Agentåˆ°ç›®æ ‡JVMï¼Œå°±éœ€è¦åšä¸€äº›é¢å¤–çš„å¼€å‘äº†ã€‚</p><p>com.sun.tools.attach.VirtualMachine è¿™ä¸ªç±»ä»£è¡¨ä¸€ä¸ªJVMæŠ½è±¡ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªç±»æ‰¾åˆ°ç›®æ ‡JVMï¼Œå¹¶ä¸”å°†AgentæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šã€‚ä¸‹é¢æ˜¯ä½¿ç”¨com.sun.tools.attach.VirtualMachineè¿›è¡ŒåŠ¨æ€æŒ‚è½½Agentçš„ä¸€èˆ¬å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">    private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> attachAgentToTargetJVM</span><span style="color:#E06C75;">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B;">        List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">VirtualMachineDescriptor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> virtualMachineDescriptors </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> VirtualMachine</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        VirtualMachineDescriptor</span><span style="color:#E06C75;"> targetVM </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">VirtualMachineDescriptor</span><span style="color:#E06C75;"> descriptor </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> virtualMachineDescriptors) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">descriptor</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">id</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">configure</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getPid</span><span style="color:#ABB2BF;">())</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">                targetVM </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> descriptor</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (targetVM </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalArgumentException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;could not find the target jvm by process id:&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> configure</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getPid</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E5C07B;">        VirtualMachine</span><span style="color:#E06C75;"> virtualMachine </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E06C75;">            virtualMachine </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> VirtualMachine</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">attach</span><span style="color:#ABB2BF;">(targetVM);</span></span>
<span class="line"><span style="color:#E5C07B;">            virtualMachine</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">loadAgent</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{agent}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;{params}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Exception</span><span style="color:#E06C75;font-style:italic;"> e</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (virtualMachine </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                virtualMachine</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">detach</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆé€šè¿‡æŒ‡å®šçš„è¿›ç¨‹IDæ‰¾åˆ°ç›®æ ‡JVMï¼Œç„¶åé€šè¿‡AttachæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šï¼Œæ‰§è¡ŒåŠ è½½Agentæ“ä½œã€‚VirtualMachineçš„Attachæ–¹æ³•å°±æ˜¯ç”¨æ¥å°†AgentæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šå»çš„ï¼Œè€ŒDetachåˆ™æ˜¯å°†Agentä»ç›®æ ‡JVMå¸è½½ã€‚å…³äºAgentæ˜¯å¦‚ä½•æŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šçš„å…·ä½“æŠ€æœ¯ç»†èŠ‚ï¼Œå°†åœ¨ä¸‹æ–‡ä¸­è¿›è¡Œåˆ†æã€‚</p><h2 id="å¯åŠ¨æ—¶åŠ è½½agent" tabindex="-1"><a class="header-anchor" href="#å¯åŠ¨æ—¶åŠ è½½agent"><span><a href="#%E5%90%AF%E5%8A%A8%E6%97%B6%E5%8A%A0%E8%BD%BDagent">#</a> å¯åŠ¨æ—¶åŠ è½½Agent</span></a></h2><h3 id="å‚æ•°è§£æ" tabindex="-1"><a class="header-anchor" href="#å‚æ•°è§£æ"><span><a href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90">#</a> å‚æ•°è§£æ</span></a></h3><p>åˆ›å»ºJVMæ—¶ï¼ŒJVMä¼šè¿›è¡Œå‚æ•°è§£æï¼Œå³è§£æé‚£äº›ç”¨æ¥é…ç½®JVMå¯åŠ¨çš„å‚æ•°ï¼Œæ¯”å¦‚å †å¤§å°ã€GCç­‰ï¼›æœ¬æ–‡ä¸»è¦å…³æ³¨è§£æçš„å‚æ•°ä¸º-agentlibã€ -agentpathã€ -javaagentï¼Œè¿™å‡ ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šAgentï¼ŒJVMä¼šæ ¹æ®è¿™å‡ ä¸ªå‚æ•°åŠ è½½Agentã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹JVMæ˜¯å¦‚ä½•è§£æè¿™å‡ ä¸ªå‚æ•°çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // -agentlib and -agentpath</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">match_option</span><span style="color:#E06C75;">(option</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;-agentlib:&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">tail) </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#E06C75;">          (is_absolute_path </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> match_option</span><span style="color:#E06C75;">(option</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;-agentpath:&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">tail))) {</span></span>
<span class="line"><span style="color:#C678DD;">      if</span><span style="color:#E06C75;">(tail </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> NULL) {</span></span>
<span class="line"><span style="color:#C678DD;">        const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> pos </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> strchr</span><span style="color:#E06C75;">(tail</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &#39;=&#39;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        size_t len </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (pos </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> NULL) </span><span style="color:#C678DD;">?</span><span style="color:#61AFEF;"> strlen</span><span style="color:#E06C75;">(tail) </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> pos </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> tail</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> name </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> strncpy</span><span style="color:#E06C75;">(</span><span style="color:#61AFEF;">NEW_C_HEAP_ARRAY</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">char</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> len </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> mtArguments)</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> tail</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> len)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        name[len] </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &#39;</span><span style="color:#56B6C2;">\0</span><span style="color:#98C379;">&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        char</span><span style="color:#56B6C2;"> *</span><span style="color:#E06C75;">options </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> NULL</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;">(pos </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> NULL) {</span></span>
<span class="line"><span style="color:#E06C75;">          options </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">strdup_check_oom</span><span style="color:#E06C75;">(pos </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> mtArguments)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">#</span><span style="color:#C678DD;">if</span><span style="color:#56B6C2;"> !</span><span style="color:#E5C07B;">INCLUDE_JVMTI</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">valid_jdwp_agent</span><span style="color:#E06C75;">(name</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> is_absolute_path)) {</span></span>
<span class="line"><span style="color:#61AFEF;">          jio_fprintf</span><span style="color:#E06C75;">(defaultStream</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">error_stream</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;">            &quot;Debugging agents are not supported in this VM</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">          return</span><span style="color:#E06C75;"> JNI_ERR</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">#endif </span><span style="color:#7F848E;font-style:italic;">// !INCLUDE_JVMTI</span></span>
<span class="line"><span style="color:#61AFEF;">        add_init_agent</span><span style="color:#E06C75;">(name</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> options</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> is_absolute_path)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">      }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // -javaagent</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">match_option</span><span style="color:#E06C75;">(option</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;-javaagent:&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">tail)) {</span></span>
<span class="line"><span style="color:#E06C75;">#</span><span style="color:#C678DD;">if</span><span style="color:#56B6C2;"> !</span><span style="color:#E5C07B;">INCLUDE_JVMTI</span></span>
<span class="line"><span style="color:#61AFEF;">      jio_fprintf</span><span style="color:#E06C75;">(defaultStream</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">error_stream</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;">        &quot;Instrumentation agents are not supported in this VM</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">      return</span><span style="color:#E06C75;"> JNI_ERR</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">#</span><span style="color:#C678DD;">else</span></span>
<span class="line"><span style="color:#C678DD;">      if</span><span style="color:#E06C75;"> (tail </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> NULL) {</span></span>
<span class="line"><span style="color:#E06C75;">        size_t length </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> strlen</span><span style="color:#E06C75;">(tail) </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        char</span><span style="color:#56B6C2;"> *</span><span style="color:#E06C75;">options </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> NEW_C_HEAP_ARRAY</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">char</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> length</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> mtArguments)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        jio_snprintf</span><span style="color:#E06C75;">(options</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> length</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;%s&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> tail)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        add_init_agent</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;instrument&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> options</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // java agents need module java.instrument</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">create_numbered_property</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;jdk.module.addmods&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;java.instrument&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> addmods_count</span><span style="color:#ABB2BF;">++</span><span style="color:#E06C75;">)) {</span></span>
<span class="line"><span style="color:#C678DD;">          return</span><span style="color:#E06C75;"> JNI_ENOMEM</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">      }</span></span>
<span class="line"><span style="color:#E06C75;">#endif </span><span style="color:#7F848E;font-style:italic;">// !INCLUDE_JVMTI</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ç‰‡æ®µæˆªå–è‡ªhotspot/src/share/vm/runtime/arguments.cppä¸­çš„ Arguments::parse_each_vm_init_arg(const JavaVMInitArgs* args, bool* patch_mod_javabase, Flag::Flags origin) å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨æ¥è§£æä¸€ä¸ªå…·ä½“çš„JVMå‚æ•°ã€‚è¿™æ®µä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯è§£æå‡ºéœ€è¦åŠ è½½çš„Agentè·¯å¾„ï¼Œç„¶åè°ƒç”¨add_init_agentå‡½æ•°è¿›è¡Œè§£æç»“æœçš„å­˜å‚¨ã€‚ä¸‹é¢å…ˆçœ‹ä¸€ä¸‹add_init_agentå‡½æ•°çš„å…·ä½“å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // -agentlib and -agentpath arguments</span></span>
<span class="line"><span style="color:#C678DD;">  static</span><span style="color:#E5C07B;"> AgentLibraryList</span><span style="color:#E06C75;"> _agentList</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> add_init_agent</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> name</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> options</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> bool absolute_path)</span></span>
<span class="line"><span style="color:#E06C75;">    { </span><span style="color:#E5C07B;">_agentList</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> AgentLibrary</span><span style="color:#ABB2BF;">(name, options, absolute_path, NULL));</span><span style="color:#E06C75;"> }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AgentLibraryListæ˜¯ä¸€ä¸ªç®€å•çš„é“¾è¡¨ç»“æ„ï¼Œadd_init_agentå‡½æ•°å°†è§£æå¥½çš„ã€éœ€è¦åŠ è½½çš„Agentæ·»åŠ åˆ°è¿™ä¸ªé“¾è¡¨ä¸­ï¼Œç­‰å¾…åç»­çš„å¤„ç†ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œè§£æ-javaagentå‚æ•°æœ‰ä¸€äº›ç‰¹åˆ«ä¹‹å¤„ï¼Œè¿™ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šä¸€ä¸ªæˆ‘ä»¬é€šè¿‡Java Instrumentation APIæ¥ç¼–å†™çš„Agentï¼ŒJava Instrumentation APIåº•å±‚ä¾èµ–çš„æ˜¯JVMTIï¼Œå¯¹-JavaAgentçš„å¤„ç†ä¹Ÿè¯´æ˜äº†è¿™ä¸€ç‚¹ï¼Œåœ¨è°ƒç”¨add_init_agentå‡½æ•°æ—¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯â€œinstrumentâ€ï¼Œå…³äºåŠ è½½Agentè¿™ä¸ªé—®é¢˜åœ¨ä¸‹ä¸€å°èŠ‚è¿›è¡Œå±•å¼€ã€‚åˆ°æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å¯åŠ¨JVMæ—¶æŒ‡å®šçš„Agentå·²ç»è¢«JVMè§£æå®Œå­˜æ”¾åœ¨äº†ä¸€ä¸ªé“¾è¡¨ç»“æ„ä¸­ã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹JVMæ˜¯å¦‚ä½•åŠ è½½è¿™äº›Agentçš„ã€‚</p><h3 id="æ‰§è¡ŒåŠ è½½æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡ŒåŠ è½½æ“ä½œ"><span><a href="#%E6%89%A7%E8%A1%8C%E5%8A%A0%E8%BD%BD%E6%93%8D%E4%BD%9C">#</a> æ‰§è¡ŒåŠ è½½æ“ä½œ</span></a></h3><p>åœ¨åˆ›å»ºJVMè¿›ç¨‹çš„å‡½æ•°ä¸­ï¼Œè§£æå®ŒJVMå‚æ•°ä¹‹åï¼Œä¸‹é¢çš„è¿™æ®µä»£ç å’ŒåŠ è½½Agentç›¸å…³ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // Launch -agentlib/-agentpath and converted -Xrun agents</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (Arguments</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">init_agents_at_startup</span><span style="color:#E06C75;">()) {</span></span>
<span class="line"><span style="color:#61AFEF;">    create_vm_init_agents</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#C678DD;">  static</span><span style="color:#E06C75;"> bool </span><span style="color:#61AFEF;">init_agents_at_startup</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#56B6C2;"> !</span><span style="color:#E5C07B;">_agentList</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_empty</span><span style="color:#ABB2BF;">();</span><span style="color:#E06C75;"> </span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“JVMåˆ¤æ–­å‡ºä¸Šä¸€å°èŠ‚ä¸­è§£æå‡ºæ¥çš„Agentä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œå°±è¦å»è°ƒç”¨å‡½æ•°create_vm_init_agentsæ¥åŠ è½½Agentï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹create_vm_init_agentså‡½æ•°æ˜¯å¦‚ä½•åŠ è½½Agentçš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#E06C75;"> Threads</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">create_vm_init_agents</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E06C75;">  AgentLibrary</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> agent</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  for</span><span style="color:#E06C75;"> (agent </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> Arguments</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">agents</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> agent </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> NULL</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> agent </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> agent</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">next</span><span style="color:#E06C75;">()) {</span></span>
<span class="line"><span style="color:#E5C07B;">    OnLoadEntry_t</span><span style="color:#E06C75;">  on_load_entry </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> lookup_agent_on_load</span><span style="color:#E06C75;">(agent)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (on_load_entry </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> NULL) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">      // Invoke the Agent_OnLoad function</span></span>
<span class="line"><span style="color:#E06C75;">      jint err </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">on_load_entry)(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">main_vm</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> agent</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">options</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> NULL)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>create_vm_init_agentsè¿™ä¸ªå‡½æ•°é€šè¿‡éå†Agenté“¾è¡¨æ¥é€ä¸ªåŠ è½½Agentã€‚é€šè¿‡è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆé€šè¿‡lookup_agent_on_loadæ¥åŠ è½½Agentå¹¶ä¸”æ‰¾åˆ°Agent_OnLoadå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯Agentçš„å…¥å£å‡½æ•°ã€‚å¦‚æœæ²¡æ‰¾åˆ°è¿™ä¸ªå‡½æ•°ï¼Œåˆ™è®¤ä¸ºæ˜¯åŠ è½½äº†ä¸€ä¸ªä¸åˆæ³•çš„Agentï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™æ ·Agentçš„ä»£ç å°±å¼€å§‹æ‰§è¡Œèµ·æ¥äº†ã€‚å¯¹äºä½¿ç”¨Java Instrumentation APIæ¥ç¼–å†™Agentçš„æ–¹å¼æ¥è¯´ï¼Œåœ¨è§£æé˜¶æ®µè§‚å¯Ÿåˆ°åœ¨add_init_agentå‡½æ•°é‡Œé¢ä¼ é€’è¿›å»çš„æ˜¯ä¸€ä¸ªå«åšâ€instrumentâ€çš„å­—ç¬¦ä¸²ï¼Œå…¶å®è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ã€‚åœ¨Linuxé‡Œé¢ï¼Œ<a href="http://xn--libinstrument-2h1us8wmmp987bfm3n.so" target="_blank" rel="noopener noreferrer">è¿™ä¸ªåº“å«åšlibinstrument.so<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œåœ¨BSDç³»ç»Ÿä¸­å«åšlibinstrument.dylibï¼Œè¯¥åŠ¨æ€é“¾æ¥åº“åœ¨{JAVA_HOME}/jre/lib/ç›®å½•ä¸‹ã€‚</p><h3 id="instrumentåŠ¨æ€é“¾æ¥åº“" tabindex="-1"><a class="header-anchor" href="#instrumentåŠ¨æ€é“¾æ¥åº“"><span><a href="#instrument%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93">#</a> instrumentåŠ¨æ€é“¾æ¥åº“</span></a></h3><p>libinstrumentç”¨æ¥æ”¯æŒä½¿ç”¨Java Instrumentation APIæ¥ç¼–å†™Agentï¼Œåœ¨libinstrumentä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç±»ç§°ä¸ºï¼šJPLISAgent(Java Programming Language Instrumentation Services Agent)ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆå§‹åŒ–æ‰€æœ‰é€šè¿‡Java Instrumentation APIç¼–å†™çš„Agentï¼Œå¹¶ä¸”ä¹Ÿæ‰¿æ‹…ç€é€šè¿‡JVMTIå®ç°Java Instrumentationä¸­æš´éœ²APIçš„è´£ä»»ã€‚</p><p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨JVMå¯åŠ¨çš„æ—¶å€™ï¼ŒJVMä¼šé€šè¿‡-javaagentå‚æ•°åŠ è½½Agentã€‚æœ€å¼€å§‹åŠ è½½çš„æ˜¯libinstrumentåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶ååœ¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢æ‰¾åˆ°JVMTIçš„å…¥å£æ–¹æ³•ï¼šAgent_OnLoadã€‚ä¸‹é¢å°±æ¥åˆ†æä¸€ä¸‹åœ¨libinstrumentåŠ¨æ€é“¾æ¥åº“ä¸­ï¼ŒAgent_OnLoadå‡½æ•°æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">JNIEXPORT</span><span style="color:#E06C75;"> jint </span><span style="color:#E5C07B;">JNICALL</span></span>
<span class="line"><span style="color:#61AFEF;">DEF_Agent_OnLoad</span><span style="color:#E06C75;">(JavaVM </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">vm</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;"> *</span><span style="color:#E06C75;">tail</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> void</span><span style="color:#56B6C2;"> *</span><span style="color:#E06C75;"> reserved) {</span></span>
<span class="line"><span style="color:#E06C75;">    initerror </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> createNewJPLISAgent</span><span style="color:#E06C75;">(vm</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">agent)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ( initerror </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> JPLIS_INIT_ERROR_NONE ) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">parseArgumentTail</span><span style="color:#E06C75;">(tail</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">jarfile</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">options) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">            fprintf</span><span style="color:#E06C75;">(stderr</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;-javaagent: memory allocation failure.</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#E06C75;"> JNI_ERR</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">        attributes </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> readAttributes</span><span style="color:#E06C75;">(jarfile)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        premainClass </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getAttribute</span><span style="color:#E06C75;">(attributes</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;Premain-Class&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        /* Save the jarfile name */</span></span>
<span class="line"><span style="color:#E06C75;">        agent</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">mJarfile </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> jarfile</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        /*</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">         * Convert JAR attributes into agent capabilities</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">         */</span></span>
<span class="line"><span style="color:#61AFEF;">        convertCapabilityAttributes</span><span style="color:#E06C75;">(attributes</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> agent)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        /*</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">         * Track (record) the agent class name and options data</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">         */</span></span>
<span class="line"><span style="color:#E06C75;">        initerror </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> recordCommandLineData</span><span style="color:#E06C75;">(agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> premainClass</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> options)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> result</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ç‰‡æ®µæ˜¯ç»è¿‡ç²¾ç®€çš„libinstrumentä¸­Agent_OnLoadå®ç°çš„ï¼Œå¤§æ¦‚çš„æµç¨‹å°±æ˜¯ï¼šå…ˆåˆ›å»ºä¸€ä¸ªJPLISAgentï¼Œç„¶åå°†ManiFestä¸­è®¾å®šçš„ä¸€äº›å‚æ•°è§£æå‡ºæ¥ï¼Œ æ¯”å¦‚(Premain-Class)ç­‰ã€‚åˆ›å»ºäº†JPLISAgentä¹‹åï¼Œè°ƒç”¨initializeJPLISAgentå¯¹è¿™ä¸ªAgentè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚è·Ÿè¿›initializeJPLISAgentçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">JPLISInitializationError</span><span style="color:#61AFEF;"> initializeJPLISAgent</span><span style="color:#E06C75;">(JPLISAgent </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> JavaVM </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">vm</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> jvmtiEnv </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jvmtienv) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    /* check what capabilities are available */</span></span>
<span class="line"><span style="color:#61AFEF;">    checkCapabilities</span><span style="color:#E06C75;">(agent)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    /* check phase - if live phase then we don&#39;t need the VMInit event */</span></span>
<span class="line"><span style="color:#E06C75;">    jvmtierror </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jvmtienv)</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">GetPhase</span><span style="color:#E06C75;">(jvmtienv</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">phase)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    /* now turn on the VMInit event */</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ( jvmtierror </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> JVMTI_ERROR_NONE ) {</span></span>
<span class="line"><span style="color:#E06C75;">        jvmtiEventCallbacks callbacks</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        memset</span><span style="color:#E06C75;">(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">callbacks</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">,</span><span style="color:#61AFEF;"> sizeof</span><span style="color:#E06C75;">(callbacks))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">        callbacks</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">VMInit</span><span style="color:#56B6C2;"> =</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">eventHandlerVMInit</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        jvmtierror </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jvmtienv)</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">SetEventCallbacks</span><span style="color:#E06C75;">(jvmtienv</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">callbacks</span><span style="color:#ABB2BF;">,</span><span style="color:#61AFEF;">sizeof</span><span style="color:#E06C75;">(callbacks))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ( jvmtierror </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> JVMTI_ERROR_NONE ) {</span></span>
<span class="line"><span style="color:#E06C75;">        jvmtierror </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jvmtienv)</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">SetEventNotificationMode</span><span style="color:#E06C75;">(jvmtienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">JVMTI_ENABLE</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">JVMTI_EVENT_VM_INIT</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">NULL)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> (jvmtierror </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> JVMTI_ERROR_NONE)</span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> JPLIS_INIT_ERROR_NONE </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> JPLIS_INIT_ERROR_FAILURE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œæˆ‘ä»¬å…³æ³¨callbacks.VMInit = &amp;eventHandlerVMInit;è¿™è¡Œä»£ç ï¼Œè¿™é‡Œè®¾ç½®äº†ä¸€ä¸ªVMInitäº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œè¡¨ç¤ºåœ¨JVMåˆå§‹åŒ–çš„æ—¶å€™ä¼šå›è°ƒeventHandlerVMInitå‡½æ•°ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°ç»†èŠ‚ï¼ŒçŒœæµ‹å°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨äº†Premainæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#E5C07B;"> JNICALL</span><span style="color:#61AFEF;">  eventHandlerVMInit</span><span style="color:#E06C75;">( jvmtiEnv </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jvmtienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">JNIEnv </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jnienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">jthread thread) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">   // ...</span></span>
<span class="line"><span style="color:#E06C75;">   success </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> processJavaStart</span><span style="color:#E06C75;">( environment</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">mAgent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> jnienv)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // ...</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#E06C75;">jboolean  </span><span style="color:#61AFEF;">processJavaStart</span><span style="color:#E06C75;">(JPLISAgent </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">JNIEnv </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jnienv) {</span></span>
<span class="line"><span style="color:#E06C75;">    result </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> createInstrumentationImpl</span><span style="color:#E06C75;">(jnienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> agent)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    /*</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">     *  Load the Java agent, and call the premain.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ( result ) {</span></span>
<span class="line"><span style="color:#E06C75;">        result </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> startJavaAgent</span><span style="color:#E06C75;">(agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> jnienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> agent</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">mAgentClassName</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> agent</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">mOptionsString</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> agent</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">mPremainCaller)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> result</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#E06C75;">jboolean </span><span style="color:#61AFEF;">startJavaAgent</span><span style="color:#E06C75;">( JPLISAgent </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">JNIEnv </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">jnienv</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;"> *</span><span style="color:#E06C75;">classname</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;"> *</span><span style="color:#E06C75;">optionsString</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">jmethodID agentMainMethod) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // ...  </span></span>
<span class="line"><span style="color:#61AFEF;">  invokeJavaAgentMainMethod</span><span style="color:#E06C75;">(jnienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">agent</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">mInstrumentationImpl</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">agentMainMethod</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> classNameObject</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">optionsStringObject)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // ...</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹åˆ°è¿™é‡Œï¼ŒInstrumentå·²ç»å®ä¾‹åŒ–ï¼ŒinvokeJavaAgentMainMethodè¿™ä¸ªæ–¹æ³•å°†æˆ‘ä»¬çš„premainæ–¹æ³•æ‰§è¡Œèµ·æ¥äº†ã€‚æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®Instrumentå®ä¾‹æ¥åšæˆ‘ä»¬æƒ³è¦åšçš„äº‹æƒ…äº†ã€‚</p><h2 id="è¿è¡Œæ—¶åŠ è½½agent" tabindex="-1"><a class="header-anchor" href="#è¿è¡Œæ—¶åŠ è½½agent"><span><a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A0%E8%BD%BDagent">#</a> è¿è¡Œæ—¶åŠ è½½Agent</span></a></h2><p>æ¯”èµ·JVMå¯åŠ¨æ—¶åŠ è½½Agentï¼Œè¿è¡Œæ—¶åŠ è½½Agentå°±æ¯”è¾ƒæœ‰è¯±æƒ‘åŠ›äº†ï¼Œå› ä¸ºè¿è¡Œæ—¶åŠ è½½Agentçš„èƒ½åŠ›ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¼ºçš„åŠ¨æ€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™åŠ è½½Agentæ¥è¿›è¡Œä¸€äº›å·¥ä½œã€‚å› ä¸ºæ˜¯åŠ¨æ€çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§éœ€æ±‚æ¥åŠ è½½æ‰€éœ€è¦çš„Agentï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹åŠ¨æ€åŠ è½½Agentçš„ç›¸å…³æŠ€æœ¯ç»†èŠ‚ã€‚</p><h3 id="attachlistener" tabindex="-1"><a class="header-anchor" href="#attachlistener"><span><a href="#attachlistener">#</a> AttachListener</span></a></h3><p>Attachæœºåˆ¶é€šè¿‡Attach Listenerçº¿ç¨‹æ¥è¿›è¡Œç›¸å…³äº‹åŠ¡çš„å¤„ç†ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹Attach Listenerçº¿ç¨‹æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// Starts the Attach Listener thread</span></span>
<span class="line"><span style="color:#C678DD;">void</span><span style="color:#E06C75;"> AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">init</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // åˆ›å»ºçº¿ç¨‹ç›¸å…³éƒ¨åˆ†ä»£ç è¢«å»æ‰äº†</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#C678DD;"> char</span><span style="color:#E06C75;"> thread_name[] </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;Attach Listener&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">  Handle</span><span style="color:#E06C75;"> string </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> java_lang_String</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">create_from_str</span><span style="color:#E06C75;">(thread_name</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> THREAD)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#E5C07B;">MutexLocker</span><span style="color:#61AFEF;"> mu</span><span style="color:#E06C75;">(Threads_lock)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    JavaThread</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> listener_thread </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> JavaThread</span><span style="color:#E06C75;">(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">attach_listener_thread_entry)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ...</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªçº¿ç¨‹å¯åŠ¨ä¹‹åéƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªå…¥å£æ¥æ‰§è¡Œä»£ç ï¼ŒAttach Listenerçº¿ç¨‹çš„å…¥å£æ˜¯attach_listener_thread_entryï¼Œä¸‹é¢çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> attach_listener_thread_entry</span><span style="color:#E06C75;">(JavaThread</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> thread</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> TRAPS) {</span></span>
<span class="line"><span style="color:#E06C75;">  AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">set_initialized</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  for</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">;;</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">      AttachOperation</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> op </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">dequeue</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">      // find the function to dispatch too</span></span>
<span class="line"><span style="color:#E06C75;">      AttachOperationFunctionInfo</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> info </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> NULL</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">      for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> i</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> funcs[i]</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">name</span><span style="color:#56B6C2;"> !=</span><span style="color:#E06C75;"> NULL</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">++</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> name </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> funcs[i]</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">name</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">strcmp</span><span style="color:#E06C75;">(op</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">name</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> name) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">          info </span><span style="color:#56B6C2;">=</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">(funcs[i])</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">       // dispatch to the function that implements this operation</span></span>
<span class="line"><span style="color:#E06C75;">        res </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (info</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">func)(op</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">st)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">      //...</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•´ä¸ªå‡½æ•°æ‰§è¡Œé€»è¾‘ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>æ‹‰å–ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼šAttachListener::dequeueã€‚</li><li>æŸ¥è¯¢åŒ¹é…çš„å‘½ä»¤å¤„ç†å‡½æ•°ã€‚</li><li>æ‰§è¡ŒåŒ¹é…åˆ°çš„å‘½ä»¤æ‰§è¡Œå‡½æ•°ã€‚</li></ul><p>å…¶ä¸­ç¬¬äºŒæ­¥é‡Œé¢å­˜åœ¨ä¸€ä¸ªå‘½ä»¤å‡½æ•°è¡¨ï¼Œæ•´ä¸ªè¡¨å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#E5C07B;"> AttachOperationFunctionInfo</span><span style="color:#E06C75;"> funcs[] </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;agentProperties&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">  get_agent_properties }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;datadump&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">         data_dump }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;dumpheap&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">         dump_heap }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;load&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">             load_agent }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;properties&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">       get_system_properties }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;threaddump&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">       thread_dump }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;inspectheap&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">      heap_inspection }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;setflag&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">          set_flag }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;printflag&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">        print_flag }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { </span><span style="color:#98C379;">&quot;jcmd&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">             jcmd }</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">  { NULL</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">               NULL }</span></span>
<span class="line"><span style="color:#E06C75;">}</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºåŠ è½½Agentæ¥è¯´ï¼Œå‘½ä»¤å°±æ˜¯â€œloadâ€ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†Attach Listenerå¤§æ¦‚çš„å·¥ä½œæ¨¡å¼ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤ªæ¸…æ¥šä»»åŠ¡ä»å“ªæ¥ï¼Œè¿™ä¸ªç§˜å¯†å°±è—åœ¨AttachListener::dequeueè¿™è¡Œä»£ç é‡Œé¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹dequeueè¿™ä¸ªå‡½æ•°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;">LinuxAttachOperation</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> LinuxAttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">dequeue</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  for</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">;;</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // wait for client to connect</span></span>
<span class="line"><span style="color:#E06C75;">    struct sockaddr addr</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    socklen_t len </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> sizeof</span><span style="color:#E06C75;">(addr)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    RESTARTABLE</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">accept</span><span style="color:#E06C75;">(</span><span style="color:#61AFEF;">listener</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">len)</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> s)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // get the credentials of the peer and check the effective uid/guid</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // - check with jeff on this.</span></span>
<span class="line"><span style="color:#E06C75;">    struct ucred cred_info</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    socklen_t optlen </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> sizeof</span><span style="color:#E06C75;">(cred_info)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">getsockopt</span><span style="color:#E06C75;">(s</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> SOL_SOCKET</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> SO_PEERCRED</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">void</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">)</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">cred_info</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">optlen) </span><span style="color:#56B6C2;">==</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">      ::</span><span style="color:#61AFEF;">close</span><span style="color:#E06C75;">(s)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">      continue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // peer credential look okay so we read the request</span></span>
<span class="line"><span style="color:#E06C75;">    LinuxAttachOperation</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> op </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> read_request</span><span style="color:#E06C75;">(s)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> op</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯Linuxä¸Šçš„å®ç°ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿå®ç°æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚ä¸Šé¢çš„ä»£ç è¡¨é¢ï¼ŒAttach Listeneråœ¨æŸä¸ªç«¯å£ç›‘å¬ç€ï¼Œé€šè¿‡acceptæ¥æ¥æ”¶ä¸€ä¸ªè¿æ¥ï¼Œç„¶åä»è¿™ä¸ªè¿æ¥é‡Œé¢å°†è¯·æ±‚è¯»å–å‡ºæ¥ï¼Œç„¶åå°†è¯·æ±‚åŒ…è£…æˆä¸€ä¸ªAttachOperationç±»å‹çš„å¯¹è±¡ï¼Œä¹‹åå°±ä¼šä»è¡¨é‡ŒæŸ¥è¯¢å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚</p><p>Attach Listenerä½¿ç”¨ä¸€ç§è¢«ç§°ä¸ºâ€œæ‡’åŠ è½½â€çš„ç­–ç•¥è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒJVMå¯åŠ¨çš„æ—¶å€™Attach Listenerå¹¶ä¸ä¸€å®šä¼šå¯åŠ¨èµ·æ¥ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ç§â€œæ‡’åŠ è½½â€ç­–ç•¥çš„å…·ä½“å®ç°æ–¹æ¡ˆã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // Start Attach Listener if +StartAttachListener or it can&#39;t be started lazily</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">DisableAttachMechanism) {</span></span>
<span class="line"><span style="color:#E06C75;">    AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">vm_start</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (StartAttachListener </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">init_at_startup</span><span style="color:#E06C75;">()) {</span></span>
<span class="line"><span style="color:#E06C75;">      AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">init</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Attach Listener is started lazily except in the case when</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// +ReduseSignalUsage is used</span></span>
<span class="line"><span style="color:#E06C75;">bool AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">init_at_startup</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (ReduceSignalUsage) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  } </span><span style="color:#C678DD;">else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç æˆªå–è‡ªcreate_vmå‡½æ•°ï¼ŒDisableAttachMechanismã€StartAttachListenerå’ŒReduceSignalUsageè¿™ä¸‰ä¸ªå˜é‡é»˜è®¤éƒ½æ˜¯falseï¼Œæ‰€ä»¥AttachListener::init();è¿™è¡Œä»£ç ä¸ä¼šåœ¨create_vmçš„æ—¶å€™æ‰§è¡Œï¼Œè€Œvm_startä¼šæ‰§è¡Œã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°ç»†èŠ‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#E06C75;"> AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">vm_start</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  char</span><span style="color:#E06C75;"> fn[UNIX_PATH_MAX]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  struct stat64 st</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  int</span><span style="color:#E06C75;"> ret</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  int</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> snprintf</span><span style="color:#E06C75;">(fn</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> UNIX_PATH_MAX</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;%s/.java_pid%d&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">           os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">get_temp_directory</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">current_process_id</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">  assert</span><span style="color:#E06C75;">(n </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">)UNIX_PATH_MAX</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;java_pid file name buffer overflow&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">  RESTARTABLE</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">stat64</span><span style="color:#E06C75;">(fn</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">st)</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ret)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (ret </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">    ret </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> ::</span><span style="color:#61AFEF;">unlink</span><span style="color:#E06C75;">(fn)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (ret </span><span style="color:#56B6C2;">==</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">      log_debug</span><span style="color:#E06C75;">(attach)(</span><span style="color:#98C379;">&quot;Failed to remove stale attach pid file at %s&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> fn)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯åœ¨Linuxä¸Šçš„å®ç°ï¼Œæ˜¯å°†/tmp/ç›®å½•ä¸‹çš„.java_pid{pid}æ–‡ä»¶åˆ é™¤ï¼Œåé¢åœ¨åˆ›å»ºAttach Listenerçº¿ç¨‹çš„æ—¶å€™ä¼šåˆ›å»ºå‡ºæ¥è¿™ä¸ªæ–‡ä»¶ã€‚ä¸Šé¢è¯´åˆ°ï¼ŒAttachListener::init()è¿™è¡Œä»£ç ä¸ä¼šåœ¨create_vmçš„æ—¶å€™æ‰§è¡Œï¼Œè¿™è¡Œä»£ç çš„å®ç°å·²ç»åœ¨ä¸Šæ–‡ä¸­åˆ†æäº†ï¼Œå°±æ˜¯åˆ›å»ºAttach Listenerçº¿ç¨‹ï¼Œå¹¶ç›‘å¬å…¶ä»–JVMçš„å‘½ä»¤è¯·æ±‚ã€‚ç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿™è¡Œä»£ç æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯â€œæ‡’åŠ è½½â€åˆ°åº•æ˜¯æ€ä¹ˆåŠ è½½èµ·æ¥çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // Signal Dispatcher needs to be started before VMInit event is posted</span></span>
<span class="line"><span style="color:#E06C75;">  os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">signal_init</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯create_vmä¸­çš„ä¸€æ®µä»£ç ï¼Œçœ‹èµ·æ¥è·Ÿä¿¡å·ç›¸å…³ï¼Œå…¶å®Attachæœºåˆ¶å°±æ˜¯ä½¿ç”¨ä¿¡å·æ¥å®ç°â€œæ‡’åŠ è½½â€œçš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä»”ç»†åœ°åˆ†æä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#E06C75;"> os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">signal_init</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">ReduceSignalUsage) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Setup JavaThread for processing signals</span></span>
<span class="line"><span style="color:#E06C75;">    EXCEPTION_MARK</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    Klass</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> SystemDictionary</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">resolve_or_fail</span><span style="color:#E06C75;">(vmSymbols</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">java_lang_Thread</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> CHECK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    instanceKlassHandle </span><span style="color:#61AFEF;">klass</span><span style="color:#E06C75;"> (THREAD</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> k)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    instanceHandle thread_oop </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> klass</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">allocate_instance_handle</span><span style="color:#E06C75;">(CHECK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    const</span><span style="color:#C678DD;"> char</span><span style="color:#E06C75;"> thread_name[] </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;Signal Dispatcher&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Handle</span><span style="color:#E06C75;"> string </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> java_lang_String</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">create_from_str</span><span style="color:#E06C75;">(thread_name</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> CHECK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Initialize thread_oop to put it into the system threadGroup</span></span>
<span class="line"><span style="color:#E5C07B;">    Handle</span><span style="color:#61AFEF;"> thread_group</span><span style="color:#E06C75;"> (THREAD</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> Universe</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">system_thread_group</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    JavaValue</span><span style="color:#61AFEF;"> result</span><span style="color:#E06C75;">(T_VOID)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    JavaCalls</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">call_special</span><span style="color:#E06C75;">(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> thread_oop</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">klass</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">vmSymbols</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">object_initializer_name</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">vmSymbols</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">threadgroup_string_void_signature</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">                           thread_group</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">string</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">CHECK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    KlassHandle</span><span style="color:#61AFEF;"> group</span><span style="color:#E06C75;">(THREAD</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> SystemDictionary</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">ThreadGroup_klass</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    JavaCalls</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">call_special</span><span style="color:#E06C75;">(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">thread_group</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">group</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">vmSymbols</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">add_method_name</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">vmSymbols</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">thread_void_signature</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">thread_oop</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">CHECK)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">signal_init_pd</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    { </span><span style="color:#E5C07B;">MutexLocker</span><span style="color:#61AFEF;"> mu</span><span style="color:#E06C75;">(Threads_lock)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">      JavaThread</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> signal_thread </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> JavaThread</span><span style="color:#E06C75;">(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">signal_thread_entry)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">     // ...</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Handle ^BREAK</span></span>
<span class="line"><span style="color:#E06C75;">    os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">signal</span><span style="color:#E06C75;">(SIGBREAK</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">user_handler</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JVMåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å®ç°ä¿¡å·å¤„ç†ï¼Œè¿™ä¸ªçº¿ç¨‹å«â€œSignal Dispatcherâ€ï¼Œä¸€ä¸ªçº¿ç¨‹åˆ›å»ºä¹‹åéœ€è¦æœ‰ä¸€ä¸ªå…¥å£ï¼Œâ€œSignal Dispatcherâ€çš„å…¥å£æ˜¯signal_thread_entryï¼š</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-1.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>è¿™æ®µä»£ç æˆªå–è‡ªsignal_thread_entryå‡½æ•°ï¼Œæˆªå–ä¸­çš„å†…å®¹æ˜¯å’ŒAttachæœºåˆ¶ä¿¡å·å¤„ç†ç›¸å…³çš„ä»£ç ã€‚è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œå½“æ¥æ”¶åˆ°â€œSIGBREAKâ€ä¿¡å·ï¼Œå°±æ‰§è¡Œæ¥ä¸‹æ¥çš„ä»£ç ï¼Œè¿™ä¸ªä¿¡å·æ˜¯éœ€è¦Attachåˆ°JVMä¸Šçš„ä¿¡å·å‘å‡ºæ¥ï¼Œè¿™ä¸ªåé¢ä¼šå†åˆ†æã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¥å…³é”®çš„ä»£ç ï¼šAttachListener::is_init_trigger()ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;">bool AttachListener</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">is_init_trigger</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">init_at_startup</span><span style="color:#E06C75;">() </span><span style="color:#56B6C2;">||</span><span style="color:#61AFEF;"> is_initialized</span><span style="color:#E06C75;">()) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">               // initialized at startup or already initialized</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#C678DD;">  char</span><span style="color:#E06C75;"> fn[PATH_MAX</span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">  sprintf</span><span style="color:#E06C75;">(fn</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;.attach_pid%d&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">current_process_id</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  int</span><span style="color:#E06C75;"> ret</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  struct stat64 st</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">  RESTARTABLE</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">stat64</span><span style="color:#E06C75;">(fn</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">st)</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ret)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (ret </span><span style="color:#56B6C2;">==</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">    log_trace</span><span style="color:#E06C75;">(attach)(</span><span style="color:#98C379;">&quot;Failed to find attach file: %s, trying alternate&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> fn)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    snprintf</span><span style="color:#E06C75;">(fn</span><span style="color:#ABB2BF;">,</span><span style="color:#61AFEF;"> sizeof</span><span style="color:#E06C75;">(fn)</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;%s/.attach_pid%d&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">get_temp_directory</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> os</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">current_process_id</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    RESTARTABLE</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">stat64</span><span style="color:#E06C75;">(fn</span><span style="color:#ABB2BF;">,</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;">st)</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ret)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (ret </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // simple check to avoid starting the attach mechanism when</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // a bogus user creates the file</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">st</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">st_uid</span><span style="color:#56B6C2;"> ==</span><span style="color:#61AFEF;"> geteuid</span><span style="color:#E06C75;">()) {</span></span>
<span class="line"><span style="color:#61AFEF;">      init</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">      return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆæ£€æŸ¥äº†ä¸€ä¸‹æ˜¯å¦åœ¨JVMå¯åŠ¨æ—¶å¯åŠ¨äº†Attach Listenerï¼Œæˆ–è€…æ˜¯å¦å·²ç»å¯åŠ¨è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ‰ç»§ç»­æ‰§è¡Œï¼Œåœ¨/tmpç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå«åš.attach_pid%dçš„æ–‡ä»¶ï¼Œç„¶åæ‰§è¡ŒAttachListenerçš„initå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥åˆ›å»ºAttach Listenerçº¿ç¨‹çš„å‡½æ•°ï¼Œä¸Šé¢å·²ç»æåˆ°å¤šæ¬¡å¹¶è¿›è¡Œäº†åˆ†æã€‚åˆ°æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“Attachæœºåˆ¶çš„å¥¥ç§˜æ‰€åœ¨ï¼Œä¹Ÿå°±æ˜¯Attach Listenerçº¿ç¨‹çš„åˆ›å»ºä¾é Signal Dispatcherçº¿ç¨‹ï¼ŒSignal Dispatcheræ˜¯ç”¨æ¥å¤„ç†ä¿¡å·çš„çº¿ç¨‹ï¼Œå½“Signal Dispatcherçº¿ç¨‹æ¥æ”¶åˆ°â€œSIGBREAKâ€ä¿¡å·ä¹‹åï¼Œå°±ä¼šæ‰§è¡Œåˆå§‹åŒ–Attach Listenerçš„å·¥ä½œã€‚</p><h3 id="è¿è¡Œæ—¶åŠ è½½agentçš„å®ç°" tabindex="-1"><a class="header-anchor" href="#è¿è¡Œæ—¶åŠ è½½agentçš„å®ç°"><span><a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A0%E8%BD%BDagent%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a> è¿è¡Œæ—¶åŠ è½½Agentçš„å®ç°</span></a></h3><p>æˆ‘ä»¬ç»§ç»­åˆ†æï¼Œåˆ°åº•æ˜¯å¦‚ä½•å°†ä¸€ä¸ªAgentæŒ‚è½½åˆ°è¿è¡Œç€çš„ç›®æ ‡JVMä¸Šï¼Œåœ¨ä¸Šæ–‡ä¸­æåˆ°äº†ä¸€æ®µä»£ç ï¼Œç”¨æ¥è¿›è¡Œè¿è¡Œæ—¶æŒ‚è½½Agentï¼Œå¯ä»¥å‚è€ƒä¸Šæ–‡ä¸­å±•ç¤ºçš„å…³äºâ€œattachAgentToTargetJvmâ€æ–¹æ³•çš„ä»£ç ã€‚è¿™ä¸ªæ–¹æ³•é‡Œé¢çš„å…³é”®æ˜¯è°ƒç”¨VirtualMachineçš„attachæ–¹æ³•è¿›è¡ŒAgentæŒ‚è½½çš„åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹VirtualMachineçš„attachæ–¹æ³•å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> VirtualMachine</span><span style="color:#61AFEF;"> attach</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> var0) throws AttachNotSupportedException</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> IOException {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (var0 </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> NullPointerException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;id cannot be null&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        List</span><span style="color:#E06C75;"> var1 </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> AttachProvider</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">providers</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">var1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">size</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> AttachNotSupportedException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;no providers installed&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">            AttachNotSupportedException</span><span style="color:#E06C75;"> var2 </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            Iterator</span><span style="color:#E06C75;"> var3 </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> var1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">iterator</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">            while</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">var3</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">hasNext</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                AttachProvider</span><span style="color:#E06C75;"> var4 </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (AttachProvider)</span><span style="color:#E5C07B;">var3</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">                try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#E5C07B;"> var4</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">attachVirtualMachine</span><span style="color:#ABB2BF;">(var0);</span></span>
<span class="line"><span style="color:#E06C75;">                } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">AttachNotSupportedException</span><span style="color:#E06C75;font-style:italic;"> var6</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">                    var2 </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> var6</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#C678DD;">            throw</span><span style="color:#E06C75;"> var2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•é€šè¿‡attachVirtualMachineæ–¹æ³•è¿›è¡Œattachæ“ä½œï¼Œåœ¨MacOSç³»ç»Ÿä¸­ï¼ŒAttachProviderçš„å®ç°ç±»æ˜¯BsdAttachProviderã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹BsdAttachProviderçš„attachVirtualMachineæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#E5C07B;"> VirtualMachine</span><span style="color:#61AFEF;"> attachVirtualMachine</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> var1) throws AttachNotSupportedException</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> IOException {</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">checkAttachPermission</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">testAttachable</span><span style="color:#ABB2BF;">(var1);</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> BsdVirtualMachine</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> var1)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#61AFEF;">BsdVirtualMachine</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">AttachProvider</span><span style="color:#E06C75;"> var1</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> var2) throws AttachNotSupportedException</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> IOException {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> var3 </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Integer</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">parseInt</span><span style="color:#ABB2BF;">(var2);</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">path</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">findSocketFile</span><span style="color:#ABB2BF;">(var3);</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">path</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        File</span><span style="color:#E06C75;"> var4 </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> File</span><span style="color:#E06C75;">(tmpdir</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;.attach_pid&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E06C75;"> var3)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        createAttachFile</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">var4</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getPath</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">            sendQuitTo</span><span style="color:#E06C75;">(var3)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> var5 </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            long</span><span style="color:#E06C75;"> var6 </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 200L</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> var8 </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">)(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">attachTimeout</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> /</span><span style="color:#E06C75;"> var6)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            do</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">                try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">                    Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">sleep</span><span style="color:#ABB2BF;">(var6);</span></span>
<span class="line"><span style="color:#E06C75;">                } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">InterruptedException</span><span style="color:#E06C75;font-style:italic;"> var21</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">                    ;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E5C07B;">                this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">path</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">findSocketFile</span><span style="color:#ABB2BF;">(var3);</span></span>
<span class="line"><span style="color:#ABB2BF;">                ++</span><span style="color:#E06C75;">var5</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            } </span><span style="color:#C678DD;">while</span><span style="color:#E06C75;">(var5 </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#E06C75;"> var8 </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">path</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">            var4</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">delete</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> var24 </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> socket</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    connect</span><span style="color:#E06C75;">(var24</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">path</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> String</span><span style="color:#61AFEF;"> findSocketFile</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> var1) {</span></span>
<span class="line"><span style="color:#E5C07B;">    String</span><span style="color:#E06C75;"> var2 </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;.java_pid&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E06C75;"> var1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    File</span><span style="color:#E06C75;"> var3 </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> File</span><span style="color:#E06C75;">(tmpdir</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> var2)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> var3</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">exists</span><span style="color:#ABB2BF;">()</span><span style="color:#C678DD;"> ?</span><span style="color:#E5C07B;"> var3</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getPath</span><span style="color:#ABB2BF;">()</span><span style="color:#C678DD;"> :</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>findSocketFileæ–¹æ³•ç”¨æ¥æŸ¥è¯¢ç›®æ ‡JVMä¸Šæ˜¯å¦å·²ç»å¯åŠ¨äº†Attach Listenerï¼Œå®ƒé€šè¿‡æ£€æŸ¥â€tmp/â€œç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨java_pid{pid}æ¥è¿›è¡Œå®ç°ã€‚å¦‚æœå·²ç»å­˜åœ¨äº†ï¼Œåˆ™è¯´æ˜Attachæœºåˆ¶å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„å‘½ä»¤äº†ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡connectè¿æ¥åˆ°ç›®æ ‡JVMè¿›è¡Œå‘½ä»¤çš„å‘é€ï¼Œæ¯”å¦‚å¯ä»¥å‘é€â€œloadâ€å‘½ä»¤æ¥åŠ è½½Agentã€‚å¦‚æœjava_pid{pid}æ–‡ä»¶è¿˜ä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦é€šè¿‡sendQuitToæ–¹æ³•å‘ç›®æ ‡JVMå‘é€ä¸€ä¸ªâ€œSIGBREAKâ€ä¿¡å·ï¼Œè®©å®ƒåˆå§‹åŒ–Attach Listenerçº¿ç¨‹å¹¶å‡†å¤‡æ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå‘é€äº†ä¿¡å·ä¹‹åå®¢æˆ·ç«¯ä¼šå¾ªç¯ç­‰å¾…java_pid{pid}è¿™ä¸ªæ–‡ä»¶ï¼Œä¹‹åå†é€šè¿‡connectè¿æ¥åˆ°ç›®æ ‡JVMä¸Šã€‚</p><h3 id="loadå‘½ä»¤çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#loadå‘½ä»¤çš„å®ç°"><span><a href="#load%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a> loadå‘½ä»¤çš„å®ç°</span></a></h3><p>ä¸‹é¢æ¥åˆ†æä¸€ä¸‹ï¼Œâ€œloadâ€å‘½ä»¤åœ¨JVMå±‚é¢çš„å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#E06C75;"> jint </span><span style="color:#61AFEF;">load_agent</span><span style="color:#E06C75;">(AttachOperation</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> op</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> outputStream</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> out) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // get agent name and options</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> agent </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> op</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">arg</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">0</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> absParam </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> op</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">arg</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">1</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  const</span><span style="color:#C678DD;"> char</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> options </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> op</span><span style="color:#C678DD;">-&gt;</span><span style="color:#61AFEF;">arg</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">2</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // If loading a java agent then need to ensure that the java.instrument module is loaded</span></span>
<span class="line"><span style="color:#C678DD;">  if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">strcmp</span><span style="color:#E06C75;">(agent</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;instrument&quot;</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">    Thread</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> THREAD </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> Thread</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">current</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    ResourceMark</span><span style="color:#61AFEF;"> rm</span><span style="color:#E06C75;">(THREAD)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    HandleMark</span><span style="color:#61AFEF;"> hm</span><span style="color:#E06C75;">(THREAD)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    JavaValue</span><span style="color:#61AFEF;"> result</span><span style="color:#E06C75;">(T_OBJECT)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Handle</span><span style="color:#E06C75;"> h_module_name </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> java_lang_String</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">create_from_str</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;java.instrument&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> THREAD)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    JavaCalls</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">call_static</span><span style="color:#E06C75;">(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">SystemDictionary</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">module_Modules_klass</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">vmSymbols</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">loadModule_name</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">                           vmSymbols</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">loadModule_signature</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">h_module_name</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">THREAD)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  }</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#E06C75;"> JvmtiExport</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">load_agent_library</span><span style="color:#E06C75;">(agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> absParam</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> options</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> out)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°å…ˆç¡®ä¿åŠ è½½äº†java.instrumentæ¨¡å—ï¼Œä¹‹åçœŸæ­£æ‰§è¡ŒAgentåŠ è½½çš„å‡½æ•°æ˜¯ load_agent_library ,è¿™ä¸ªå‡½æ•°çš„å¥—è·¯å°±æ˜¯åŠ è½½AgentåŠ¨æ€é“¾æ¥åº“ï¼Œå¦‚æœæ˜¯é€šè¿‡Java instrument APIå®ç°çš„Agentï¼Œåˆ™åŠ è½½çš„æ˜¯libinstrumentåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶åé€šè¿‡libinstrumenté‡Œé¢çš„ä»£ç å®ç°è¿è¡Œagentmainæ–¹æ³•çš„é€»è¾‘ï¼Œè¿™ä¸€éƒ¨åˆ†å†…å®¹å’Œlibinstrumentå®ç°premainæ–¹æ³•è¿è¡Œçš„é€»è¾‘å…¶å®å·®ä¸å¤šï¼Œè¿™é‡Œä¸å†åšåˆ†æã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å¯¹Java AgentæŠ€æœ¯å·²ç»æœ‰äº†ä¸€ä¸ªå…¨é¢è€Œç»†è‡´çš„äº†è§£ã€‚</p><h2 id="åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶" tabindex="-1"><a class="header-anchor" href="#åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶"><span><a href="#%E5%8A%A8%E6%80%81%E5%AD%97%E8%8A%82%E7%A0%81%E4%BF%AE%E6%94%B9%E7%9A%84%E9%99%90%E5%88%B6">#</a> åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶</span></a></h2><p>ä¸Šæ–‡ä¸­å·²ç»è¯¦ç»†åˆ†æäº†AgentæŠ€æœ¯çš„å®ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨Java Instrumentation APIæ¥å®ŒæˆåŠ¨æ€ç±»ä¿®æ”¹çš„åŠŸèƒ½ï¼Œåœ¨Instrumentationæ¥å£ä¸­ï¼Œé€šè¿‡addTransformeræ–¹æ³•æ¥å¢åŠ ä¸€ä¸ªç±»è½¬æ¢å™¨ï¼Œç±»è½¬æ¢å™¨ç”±ç±»ClassFileTransformeræ¥å£å®ç°ã€‚ClassFileTransformeræ¥å£ä¸­å”¯ä¸€çš„æ–¹æ³•transformç”¨äºå®ç°ç±»è½¬æ¢ï¼Œå½“ç±»è¢«åŠ è½½çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨transformæ–¹æ³•ï¼Œè¿›è¡Œç±»è½¬æ¢ã€‚åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Instrumentationçš„redefineClassesæ–¹æ³•è¿›è¡Œç±»é‡å®šä¹‰ï¼Œåœ¨æ–¹æ³•ä¸Šæœ‰ä¸€æ®µæ³¨é‡Šéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#56B6C2;">     *</span><span style="color:#E5C07B;"> The</span><span style="color:#E06C75;"> redefinition may change method bodies</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> the constant pool and attributes</span><span style="color:#ABB2BF;">.</span></span>
<span class="line"><span style="color:#56B6C2;">     *</span><span style="color:#E5C07B;"> The</span><span style="color:#E06C75;"> redefinition must not add</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> remove or rename fields or methods</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> change the</span></span>
<span class="line"><span style="color:#56B6C2;">     *</span><span style="color:#E06C75;"> signatures of methods</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> or change </span><span style="color:#E5C07B;">inheritance</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">  These</span><span style="color:#E06C75;"> restrictions maybe be</span></span>
<span class="line"><span style="color:#56B6C2;">     *</span><span style="color:#E06C75;"> lifted in future </span><span style="color:#E5C07B;">versions</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">  The</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> file</span><span style="color:#E06C75;"> bytes are not checked, verified and installed</span></span>
<span class="line"><span style="color:#E06C75;">     * until after the transformations have been applied, if the resultant bytes are in</span></span>
<span class="line"><span style="color:#E06C75;">     * error this method will throw an exception.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œé¢æåˆ°ï¼Œæˆ‘ä»¬ä¸å¯ä»¥å¢åŠ ã€åˆ é™¤æˆ–è€…é‡å‘½åå­—æ®µå’Œæ–¹æ³•ï¼Œæ”¹å˜æ–¹æ³•çš„ç­¾åæˆ–è€…ç±»çš„ç»§æ‰¿å…³ç³»ã€‚è®¤è¯†åˆ°è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå½“æˆ‘ä»¬é€šè¿‡ASMè·å–åˆ°å¢å¼ºçš„å­—èŠ‚ç ä¹‹åï¼Œå¦‚æœå¢å¼ºåçš„å­—èŠ‚ç æ²¡æœ‰éµå®ˆè¿™äº›è§„åˆ™ï¼Œé‚£ä¹ˆè°ƒç”¨redefineClassesæ–¹æ³•æ¥è¿›è¡Œç±»çš„é‡å®šä¹‰å°±ä¼šå¤±è´¥ã€‚é‚£redefineClassesæ–¹æ³•å…·ä½“æ˜¯æ€ä¹ˆå®ç°ç±»çš„é‡å®šä¹‰çš„å‘¢? å®ƒå¯¹è¿è¡Œæ—¶çš„JVMä¼šé€ æˆä»€ä¹ˆæ ·çš„å½±å“å‘¢? ä¸‹é¢æ¥åˆ†æredefineClassesçš„å®ç°ç»†èŠ‚ã€‚</p><h2 id="é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚"><span><a href="#%E9%87%8D%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82">#</a> é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚</span></a></h2><p>ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°ï¼ŒlibinstrumentåŠ¨æ€é“¾æ¥åº“ä¸­ï¼ŒJPLISAgentä¸ä»…å®ç°äº†Agentå…¥å£ä»£ç æ‰§è¡Œçš„è·¯ç”±ï¼Œè€Œä¸”è¿˜æ˜¯Javaä»£ç ä¸JVMTIä¹‹é—´çš„ä¸€é“æ¡¥æ¢ã€‚æˆ‘ä»¬åœ¨Javaä»£ç ä¸­è°ƒç”¨Java Instrumentation APIçš„redefineClassesï¼Œå…¶å®ä¼šè°ƒç”¨libinstrumentä¸­çš„ç›¸å…³ä»£ç ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™æ¡è·¯å¾„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> redefineClasses</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ClassDefinition</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> var1</span><span style="color:#E06C75;">) throws ClassNotFoundException {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isRedefineClassesSupported</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> UnsupportedOperationException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;redefineClasses is not supported in this environment&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (var1 </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> NullPointerException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;null passed as &#39;definitions&#39; in redefineClasses&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> var2 </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> var2 </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E5C07B;"> var1</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#ABB2BF;">;</span><span style="color:#ABB2BF;"> ++</span><span style="color:#E06C75;">var2) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (var1[var2] </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> NullPointerException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;element of &#39;definitions&#39; is null in redefineClasses&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">var1</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            this</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">redefineClasses0</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">mNativeAgent</span><span style="color:#ABB2BF;">, var1);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> native</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> redefineClasses0</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">long</span><span style="color:#E06C75;"> var1</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> ClassDefinition</span><span style="color:#E06C75;">[] var3) throws ClassNotFoundException</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯InstrumentationImplä¸­çš„redefineClasseså®ç°ï¼Œè¯¥æ–¹æ³•çš„å…·ä½“å®ç°ä¾èµ–ä¸€ä¸ªNativeæ–¹æ³•redefineClasses()ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨libinstrumentä¸­æ‰¾åˆ°è¿™ä¸ªNativeæ–¹æ³•çš„å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">JNIEXPORT</span><span style="color:#C678DD;"> void</span><span style="color:#E5C07B;"> JNICALL</span><span style="color:#E5C07B;"> Java_sun_instrument_InstrumentationImpl_redefineClasses0</span></span>
<span class="line"><span style="color:#E06C75;">  (JNIEnv </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> jnienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> jobject implThis</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> jlong agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> jobjectArray classDefinitions) {</span></span>
<span class="line"><span style="color:#61AFEF;">    redefineClasses</span><span style="color:#E06C75;">(jnienv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> (JPLISAgent</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;">)(intptr_t)agent</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> classDefinitions)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>redefineClassesè¿™ä¸ªå‡½æ•°çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œä»£ç å¾ˆé•¿ã€‚ä¸‹é¢æ˜¯ä¸€æ®µå…³é”®çš„ä»£ç ç‰‡æ®µï¼š</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-2.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æ˜¯è°ƒç”¨äº†JVMTIçš„RetransformClasseså‡½æ•°æ¥å®Œæˆç±»çš„é‡å®šä¹‰ç»†èŠ‚ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// class_count - pre-checked to be greater than or equal to 0</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// class_definitions - pre-checked for NULL</span></span>
<span class="line"><span style="color:#E06C75;">jvmtiError JvmtiEnv</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">RedefineClasses</span><span style="color:#E06C75;">(jint class_count</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> const</span><span style="color:#E06C75;"> jvmtiClassDefinition</span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> class_definitions) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">//TODO: add locking</span></span>
<span class="line"><span style="color:#E5C07B;">  VM_RedefineClasses</span><span style="color:#61AFEF;"> op</span><span style="color:#E06C75;">(class_count</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> class_definitions</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> jvmti_class_load_kind_redefine)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">  VMThread</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">execute</span><span style="color:#E06C75;">(</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;">op)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">  return</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">op</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">check_error</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">} </span><span style="color:#7F848E;font-style:italic;">/* end RedefineClasses */</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‡å®šä¹‰ç±»çš„è¯·æ±‚ä¼šè¢«JVMåŒ…è£…æˆä¸€ä¸ªVM_RedefineClassesç±»å‹çš„VM_Operationï¼ŒVM_Operationæ˜¯JVMå†…éƒ¨çš„ä¸€äº›æ“ä½œçš„åŸºç±»ï¼ŒåŒ…æ‹¬GCæ“ä½œç­‰ã€‚VM_Operationç”±VMThreadæ¥æ‰§è¡Œï¼Œæ–°çš„VM_Operationæ“ä½œä¼šè¢«æ·»åŠ åˆ°VMThreadçš„è¿è¡Œé˜Ÿåˆ—ä¸­å»ï¼ŒVMThreadä¼šä¸æ–­ä»é˜Ÿåˆ—é‡Œé¢æ‹‰å–VM_Operationå¹¶è°ƒç”¨å…¶doitç­‰å‡½æ•°æ‰§è¡Œå…·ä½“çš„æ“ä½œã€‚VM_RedefineClasseså‡½æ•°çš„æµç¨‹è¾ƒä¸ºå¤æ‚ï¼Œä¸‹é¢æ˜¯VM_RedefineClassesçš„å¤§è‡´æµç¨‹ï¼š</p><ul><li>åŠ è½½æ–°çš„å­—èŠ‚ç ï¼Œåˆå¹¶å¸¸é‡æ± ï¼Œå¹¶ä¸”å¯¹æ–°çš„å­—èŠ‚ç è¿›è¡Œæ ¡éªŒå·¥ä½œ</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // Load the caller&#39;s new class definition(s) into _scratch_classes.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // Constant pool merging work is done here as needed. Also calls</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // compare_and_normalize_class_versions() to verify the class</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">  // definition(s).</span></span>
<span class="line"><span style="color:#E06C75;">  jvmtiError </span><span style="color:#61AFEF;">load_new_class_versions</span><span style="color:#E06C75;">(TRAPS)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ¸…é™¤æ–¹æ³•ä¸Šçš„æ–­ç‚¹</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // Remove all breakpoints in methods of this class</span></span>
<span class="line"><span style="color:#E06C75;">  JvmtiBreakpoints</span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> jvmti_breakpoints </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> JvmtiCurrentBreakpoints</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">get_jvmti_breakpoints</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">  jvmti_breakpoints</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clearall_in_class_at_safepoint</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">the_class</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>JITé€†ä¼˜åŒ–</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">  // Deoptimize all compiled code that depends on this class</span></span>
<span class="line"><span style="color:#61AFEF;">  flush_dependent_code</span><span style="color:#E06C75;">(the_class</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> THREAD)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿›è¡Œå­—èŠ‚ç æ›¿æ¢å·¥ä½œï¼Œéœ€è¦è¿›è¡Œæ›´æ–°ç±»itable/vtableç­‰æ“ä½œ</li><li>è¿›è¡Œç±»é‡å®šä¹‰é€šçŸ¥</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;">  SystemDictionary</span><span style="color:#C678DD;">::</span><span style="color:#61AFEF;">notice_modification</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>VM_RedefineClasseså®ç°æ¯”è¾ƒå¤æ‚çš„ï¼Œè¯¦ç»†å®ç°å¯ä»¥å‚è€ƒ <a href="https://github.com/pandening/openjdk/blob/0301fc792ffd3c7b506ef78887af250e0e3ae09e/src/hotspot/share/prims/jvmtiEnv.cpp#L456" target="_blank" rel="noopener noreferrer">RedefineClassesåœ¨æ–°çª—å£æ‰“å¼€<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>çš„å®ç°ã€‚</p><h2 id="java-debug-tool" tabindex="-1"><a class="header-anchor" href="#java-debug-tool"><span><a href="#java-debug-tool">#</a> Java-debug-tool</span></a></h2><p>Java-debug-toolæ˜¯ä¸€ä¸ªä½¿ç”¨Java Instrument APIæ¥å®ç°çš„åŠ¨æ€è°ƒè¯•å·¥å…·ï¼Œå®ƒé€šè¿‡åœ¨ç›®æ ‡JVMä¸Šå¯åŠ¨ä¸€ä¸ªTcpServeræ¥å’Œè°ƒè¯•å®¢æˆ·ç«¯é€šä¿¡ã€‚è°ƒè¯•å®¢æˆ·ç«¯é€šè¿‡å‘½ä»¤è¡Œæ¥å‘é€è°ƒè¯•å‘½ä»¤ç»™TcpServerï¼ŒTcpServerä¸­æœ‰ä¸“é—¨ç”¨æ¥å¤„ç†å‘½ä»¤çš„handlerï¼Œhandlerå¤„ç†å®Œå‘½ä»¤ä¹‹åä¼šå°†ç»“æœå‘é€å›å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡å¤„ç†å°†è°ƒè¯•ç»“æœå±•ç¤ºå‡ºæ¥ã€‚ä¸‹é¢å°†è¯¦ç»†ä»‹ç»Java-debug-toolçš„æ•´ä½“è®¾è®¡å’Œå®ç°ã€‚</p><h3 id="java-debug-toolæ•´ä½“æ¶æ„" tabindex="-1"><a class="header-anchor" href="#java-debug-toolæ•´ä½“æ¶æ„"><span><a href="#java-debug-tool%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84">#</a> Java-debug-toolæ•´ä½“æ¶æ„</span></a></h3><p>Java-debug-toolåŒ…æ‹¬ä¸€ä¸ªJava Agentå’Œä¸€ä¸ªç”¨äºå¤„ç†è°ƒè¯•å‘½ä»¤çš„æ ¸å¿ƒAPIï¼Œæ ¸å¿ƒAPIé€šè¿‡ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½è¿›æ¥ï¼Œä»¥ä¿è¯ç›®æ ‡JVMçš„ç±»ä¸ä¼šè¢«æ±¡æŸ“ã€‚æ•´ä½“ä¸ŠJava-debug-toolçš„è®¾è®¡æ˜¯ä¸€ä¸ªClient-Serverçš„æ¶æ„ï¼Œå‘½ä»¤å®¢æˆ·ç«¯éœ€è¦å®Œæ•´çš„å®Œæˆä¸€ä¸ªå‘½ä»¤ä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªè°ƒè¯•å‘½ä»¤ã€‚Java-debug-toolæ”¯æŒå¤šäººåŒæ—¶è¿›è¡Œè°ƒè¯•ï¼Œä¸‹é¢æ˜¯æ•´ä½“æ¶æ„å›¾ï¼š</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-3.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ä¸‹é¢å¯¹æ¯ä¸€å±‚åšç®€å•ä»‹ç»ï¼š</p><ul><li>äº¤äº’å±‚ï¼šè´Ÿè´£å°†ç¨‹åºå‘˜çš„è¾“å…¥è½¬æ¢æˆè°ƒè¯•äº¤äº’åè®®ï¼Œå¹¶ä¸”å°†è°ƒè¯•ä¿¡æ¯å‘ˆç°å‡ºæ¥ã€‚</li><li>è¿æ¥ç®¡ç†å±‚ï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œä»è¿æ¥ä¸­è¯»è°ƒè¯•åè®®æ•°æ®å¹¶è§£ç ï¼Œå¯¹è°ƒè¯•ç»“æœç¼–ç å¹¶å°†å…¶å†™åˆ°è¿æ¥ä¸­å»ï¼›åŒæ—¶å°†é‚£äº›è¶…æ—¶æœªæ´»åŠ¨çš„è¿æ¥å…³é—­ã€‚</li><li>ä¸šåŠ¡é€»è¾‘å±‚ï¼šå®ç°è°ƒè¯•å‘½ä»¤å¤„ç†ï¼ŒåŒ…æ‹¬å‘½ä»¤åˆ†å‘ã€æ•°æ®æ”¶é›†ã€æ•°æ®å¤„ç†ç­‰è¿‡ç¨‹ã€‚</li><li>åŸºç¡€å®ç°å±‚ï¼šJava-debug-toolå®ç°çš„åº•å±‚ä¾èµ–ï¼Œé€šè¿‡Java Instrumentationæä¾›çš„APIè¿›è¡Œç±»æŸ¥æ‰¾ã€ç±»é‡å®šä¹‰ç­‰èƒ½åŠ›ï¼ŒJava Instrumentationåº•å±‚ä¾èµ–JVMTIæ¥å®Œæˆå…·ä½“çš„åŠŸèƒ½ã€‚</li></ul><p>åœ¨Agentè¢«æŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šä¹‹åï¼ŒJava-debug-toolä¼šå®‰æ’ä¸€ä¸ªSpyåœ¨ç›®æ ‡JVMå†…æ´»åŠ¨ï¼Œè¿™ä¸ªSpyè´Ÿè´£å°†ç›®æ ‡JVMå†…éƒ¨çš„ç›¸å…³è°ƒè¯•æ•°æ®è½¬ç§»åˆ°å‘½ä»¤å¤„ç†æ¨¡å—ï¼Œå‘½ä»¤å¤„ç†æ¨¡å—ä¼šå¤„ç†è¿™äº›æ•°æ®ï¼Œç„¶åç»™å®¢æˆ·ç«¯è¿”å›è°ƒè¯•ç»“æœã€‚å‘½ä»¤å¤„ç†æ¨¡å—ä¼šå¢å¼ºç›®æ ‡ç±»çš„å­—èŠ‚ç æ¥è¾¾åˆ°æ•°æ®è·å–çš„ç›®çš„ï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥å…±äº«ä¸€ä»½å¢å¼ºè¿‡çš„å­—èŠ‚ç ï¼Œæ— éœ€é‡å¤å¢å¼ºã€‚ä¸‹é¢ä»Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆã€å‘½ä»¤è®¾è®¡ä¸å®ç°ç­‰è§’åº¦è¯¦ç»†è¯´æ˜ã€‚</p><h3 id="java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ"><span><a href="#java-debug-tool%E7%9A%84%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA%E6%96%B9%E6%A1%88">#</a> Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ</span></a></h3><p>Java-debug-toolä½¿ç”¨å­—èŠ‚ç å¢å¼ºæ¥è·å–åˆ°æ–¹æ³•è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ–¹æ³•å…¥å‚ã€å‡ºå‚ç­‰ï¼Œå¯ä»¥åœ¨ä¸åŒçš„å­—èŠ‚ç ä½ç½®è¿›è¡Œå¢å¼ºï¼Œè¿™ç§è¡Œä¸ºå¯ä»¥ç§°ä¸ºâ€œæ’æ¡©â€ï¼Œæ¯ä¸ªâ€œæ¡©â€ç”¨äºè·å–æ•°æ®å¹¶å°†ä»–è½¬å‚¨å‡ºå»ã€‚Java-debug-toolå…·å¤‡å¼ºå¤§çš„æ’æ¡©èƒ½åŠ›ï¼Œä¸åŒçš„æ¡©è´Ÿè´£è·å–ä¸åŒç±»åˆ«çš„æ•°æ®ï¼Œä¸‹é¢æ˜¯Java-debug-toolç›®å‰æ‰€æ”¯æŒçš„â€œæ¡©â€ï¼š</p><ul><li>æ–¹æ³•è¿›å…¥ç‚¹ï¼šç”¨äºè·å–æ–¹æ³•å…¥å‚ä¿¡æ¯ã€‚</li><li>Fieldsè·å–ç‚¹1ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰è·å–åˆ°å¯¹è±¡çš„å­—æ®µä¿¡æ¯ã€‚</li><li>å˜é‡å­˜å‚¨ç‚¹ï¼šè·å–å±€éƒ¨å˜é‡ä¿¡æ¯ã€‚</li><li>Fieldsè·å–ç‚¹2ï¼šåœ¨æ–¹æ³•é€€å‡ºå‰è·å–åˆ°å¯¹è±¡çš„å­—æ®µä¿¡æ¯ã€‚</li><li>æ–¹æ³•é€€å‡ºç‚¹ï¼šç”¨äºè·å–æ–¹æ³•è¿”å›å€¼ã€‚</li><li>æŠ›å‡ºå¼‚å¸¸ç‚¹ï¼šç”¨äºè·å–æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ã€‚</li><li>é€šè¿‡ä¸Šé¢è¿™äº›ä»£ç æ¡©ï¼ŒJava-debug-toolå¯ä»¥æ”¶é›†åˆ°ä¸°å¯Œçš„æ–¹æ³•æ‰§è¡Œä¿¡æ¯ï¼Œç»è¿‡å¤„ç†å¯ä»¥è¿”å›æ›´åŠ å¯è§†åŒ–çš„è°ƒè¯•ç»“æœã€‚</li></ul><h4 id="å­—èŠ‚ç å¢å¼º" tabindex="-1"><a class="header-anchor" href="#å­—èŠ‚ç å¢å¼º"><span><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA">#</a> å­—èŠ‚ç å¢å¼º</span></a></h4><p>Java-debug-toolåœ¨å®ç°ä¸Šä½¿ç”¨äº†ASMå·¥å…·æ¥è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œå¹¶ä¸”æ¯ä¸ªæ’æ¡©ç‚¹éƒ½å¯ä»¥è¿›è¡Œé…ç½®ï¼Œå¦‚æœä¸æƒ³è¦ä»€ä¹ˆä¿¡æ¯ï¼Œåˆ™æ²¡å¿…è¦è¿›è¡Œå¯¹åº”çš„æ’æ¡©æ“ä½œã€‚è¿™ç§å¯é…ç½®çš„è®¾è®¡æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œå› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬ä»…ä»…æ˜¯æƒ³è¦çŸ¥é“æ–¹æ³•çš„å…¥å‚å’Œå‡ºå‚ï¼Œä½†Java-debug-toolå´ç»™æˆ‘ä»¬è¿”å›äº†æ‰€æœ‰çš„è°ƒè¯•ä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åœ¨ä¼—å¤šçš„è¾“å‡ºä¸­æ‰¾åˆ°æˆ‘ä»¬æ‰€å…³æ³¨çš„å†…å®¹ã€‚å¦‚æœå¯ä»¥è¿›è¡Œé…ç½®ï¼Œåˆ™é™¤äº†å…¥å‚ç‚¹å’Œå‡ºå‚ç‚¹å¤–å…¶ä»–çš„æ¡©éƒ½ä¸æ’ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¿«é€Ÿçœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„è°ƒè¯•æ•°æ®ï¼Œè¿™ç§è®¾è®¡çš„æœ¬è´¨æ˜¯ä¸ºäº†è®©è°ƒè¯•è€…æ›´åŠ ä¸“æ³¨ã€‚ä¸‹é¢æ˜¯Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºå·¥ä½œæ–¹å¼ï¼š</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-4.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“è°ƒè¯•è€…å‘å‡ºè°ƒè¯•å‘½ä»¤ä¹‹åï¼ŒJava-debug-toolä¼šè¯†åˆ«å‘½ä»¤å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œå¦‚æœå‘½ä»¤éœ€è¦å¢å¼ºå­—èŠ‚ç ï¼Œåˆ™åˆ¤æ–­å½“å‰ç±»+å½“å‰æ–¹æ³•æ˜¯å¦å·²ç»è¢«å¢å¼ºè¿‡ã€‚ä¸Šæ–‡å·²ç»æåˆ°ï¼Œå­—èŠ‚ç æ›¿æ¢æ˜¯æœ‰ä¸€å®šæŸè€—çš„ï¼Œè¿™ç§å…·æœ‰æŸè€—çš„æ“ä½œå‘ç”Ÿçš„æ¬¡æ•°è¶Šå°‘è¶Šå¥½ï¼Œæ‰€ä»¥å­—èŠ‚ç æ›¿æ¢æ“ä½œä¼šè¢«è®°å½•èµ·æ¥ï¼Œåç»­å‘½ä»¤ç›´æ¥ä½¿ç”¨å³å¯ï¼Œä¸éœ€è¦é‡å¤è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œå­—èŠ‚ç å¢å¼ºè¿˜æ¶‰åŠå¤šä¸ªè°ƒè¯•å®¢æˆ·ç«¯çš„ååŒå·¥ä½œé—®é¢˜ï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯å¢å¼ºäº†ä¸€ä¸ªç±»çš„å­—èŠ‚ç ä¹‹åï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å°±é”å®šäº†è¯¥å­—èŠ‚ç ï¼Œå…¶ä»–å®¢æˆ·ç«¯å˜æˆåªè¯»ï¼Œæ— æ³•å¯¹è¯¥ç±»è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œåªæœ‰å½“æŒæœ‰é”çš„å®¢æˆ·ç«¯ä¸»åŠ¨é‡Šæ”¾é”æˆ–è€…æ–­å¼€è¿æ¥ä¹‹åï¼Œå…¶ä»–å®¢æˆ·ç«¯æ‰èƒ½ç»§ç»­å¢å¼ºè¯¥ç±»çš„å­—èŠ‚ç ã€‚</p><p>å­—èŠ‚ç å¢å¼ºæ¨¡å—æ”¶åˆ°å­—èŠ‚ç å¢å¼ºè¯·æ±‚ä¹‹åï¼Œä¼šåˆ¤æ–­æ¯ä¸ªå¢å¼ºç‚¹æ˜¯å¦éœ€è¦æ’æ¡©ï¼Œè¿™ä¸ªåˆ¤æ–­çš„æ ¹æ®å°±æ˜¯ä¸Šæ–‡æåˆ°çš„æ’æ¡©é…ç½®ï¼Œä¹‹åå­—èŠ‚ç å¢å¼ºæ¨¡å—ä¼šç”Ÿæˆæ–°çš„å­—èŠ‚ç ï¼ŒJava-debug-toolå°†æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢æ“ä½œï¼Œä¹‹åå°±å¯ä»¥è¿›è¡Œè°ƒè¯•æ•°æ®æ”¶é›†äº†ã€‚</p><p>ç»è¿‡å­—èŠ‚ç å¢å¼ºä¹‹åï¼ŒåŸæ¥çš„æ–¹æ³•ä¸­ä¼šæ’å…¥æ”¶é›†è¿è¡Œæ—¶æ•°æ®çš„ä»£ç ï¼Œè¿™äº›ä»£ç åœ¨æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™æ‰§è¡Œï¼Œè·å–åˆ°è¯¸å¦‚æ–¹æ³•å…¥å‚ã€å±€éƒ¨å˜é‡ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å°†ä¼ é€’ç»™æ•°æ®æ”¶é›†è£…ç½®è¿›è¡Œå¤„ç†ã€‚æ•°æ®æ”¶é›†çš„å·¥ä½œé€šè¿‡Adviceå®Œæˆï¼Œæ¯ä¸ªå®¢æˆ·ç«¯åŒä¸€æ—¶é—´åªèƒ½æ³¨å†Œä¸€ä¸ªAdviceåˆ°Java-debug-toolè°ƒè¯•æ¨¡å—ä¸Šï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶æ³¨å†Œè‡ªå·±çš„Adviceåˆ°è°ƒè¯•æ¨¡å—ä¸Šã€‚Adviceè´Ÿè´£æ”¶é›†æ•°æ®å¹¶è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°æ®ç¬¦åˆè°ƒè¯•å‘½ä»¤çš„è¦æ±‚ï¼ŒJava-debug-toolå°±ä¼šå¸è½½è¿™ä¸ªAdviceï¼ŒAdviceçš„æ•°æ®å°±ä¼šè¢«è½¬ç§»åˆ°Java-debug-toolçš„å‘½ä»¤ç»“æœå¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†ç»“æœå‘é€åˆ°å®¢æˆ·ç«¯ã€‚</p><h4 id="adviceçš„å·¥ä½œæ–¹å¼" tabindex="-1"><a class="header-anchor" href="#adviceçš„å·¥ä½œæ–¹å¼"><span><a href="#advice%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F">#</a> Adviceçš„å·¥ä½œæ–¹å¼</span></a></h4><p>Adviceæ˜¯è°ƒè¯•æ•°æ®æ”¶é›†å™¨ï¼Œä¸åŒçš„è°ƒè¯•ç­–ç•¥ä¼šå¯¹åº”ä¸åŒçš„Adviceã€‚Adviceæ˜¯å·¥ä½œåœ¨ç›®æ ‡JVMçš„çº¿ç¨‹å†…éƒ¨çš„ï¼Œå®ƒéœ€è¦è½»é‡çº§å’Œé«˜æ•ˆï¼Œæ„å‘³ç€Adviceä¸èƒ½åšå¤ªè¿‡äºå¤æ‚çš„äº‹æƒ…ï¼Œå®ƒçš„æ ¸å¿ƒæ¥å£â€œmatchâ€ç”¨æ¥åˆ¤æ–­æœ¬æ¬¡æ”¶é›†åˆ°çš„è°ƒè¯•æ•°æ®æ˜¯å¦æ»¡è¶³è°ƒè¯•éœ€æ±‚ã€‚å¦‚æœæ»¡è¶³ï¼Œé‚£ä¹ˆJava-debug-toolå°±ä¼šå°†å…¶å¸è½½ï¼Œå¦åˆ™ä¼šç»§ç»­è®©ä»–æ”¶é›†è°ƒè¯•æ•°æ®ï¼Œè¿™ç§â€œåŠ è½½Adviceâ€ -&gt; â€œå¸è½½Adviceâ€çš„å·¥ä½œæ¨¡å¼å…·å¤‡å¾ˆå¥½çš„çµæ´»æ€§ã€‚</p><p>å…³äºAdviceï¼Œéœ€è¦è¯´æ˜çš„å¦å¤–ä¸€ç‚¹å°±æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºå®ƒåŠ è½½ä¹‹åä¼šè¿è¡Œåœ¨ç›®æ ‡JVMçš„çº¿ç¨‹ä¸­ï¼Œç›®æ ‡JVMçš„æ–¹æ³•ææœ‰å¯èƒ½æ˜¯å¤šçº¿ç¨‹è®¿é—®çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´ï¼ŒAdviceéœ€è¦æœ‰èƒ½åŠ›å¤„ç†å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ–¹æ³•çš„èƒ½åŠ›ï¼Œå¦‚æœAdviceå¤„ç†ä¸å½“ï¼Œåˆ™å¯èƒ½ä¼šæ”¶é›†åˆ°æ‚ä¹±æ— ç« çš„è°ƒè¯•æ•°æ®ã€‚ä¸‹é¢çš„å›¾ç‰‡å±•ç¤ºäº†Adviceå’ŒJava-debug-toolè°ƒè¯•åˆ†ææ¨¡å—ã€ç›®æ ‡æ–¹æ³•æ‰§è¡Œä»¥åŠè°ƒè¯•å®¢æˆ·ç«¯ç­‰æ¨¡å—çš„å…³ç³»ã€‚</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-5.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>Adviceçš„é¦–æ¬¡æŒ‚è½½ç”±Java-debug-toolçš„å‘½ä»¤å¤„ç†å™¨å®Œæˆï¼Œå½“ä¸€æ¬¡è°ƒè¯•æ•°æ®æ”¶é›†å®Œæˆä¹‹åï¼Œè°ƒè¯•æ•°æ®å¤„ç†æ¨¡å—ä¼šè‡ªåŠ¨å¸è½½Adviceï¼Œç„¶åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè°ƒè¯•æ•°æ®ç¬¦åˆAdviceçš„ç­–ç•¥ï¼Œåˆ™ç›´æ¥å°†æ•°æ®äº¤ç”±æ•°æ®å¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™ä¼šæ¸…ç©ºè°ƒè¯•æ•°æ®ï¼Œå¹¶å†æ¬¡å°†AdviceæŒ‚è½½åˆ°ç›®æ ‡æ–¹æ³•ä¸Šå»ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒè¯•æ•°æ®ã€‚éé¦–æ¬¡æŒ‚è½½ç”±è°ƒè¯•æ•°æ®å¤„ç†æ¨¡å—è¿›è¡Œï¼Œå®ƒå€ŸåŠ©AdviceæŒ‰éœ€å–æ•°æ®ï¼Œå¦‚æœä¸ç¬¦åˆéœ€æ±‚ï¼Œåˆ™ç»§ç»­æŒ‚è½½Adviceæ¥è·å–æ•°æ®ï¼Œå¦åˆ™å¯¹è°ƒè¯•æ•°æ®è¿›è¡Œå¤„ç†å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h3 id="java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°" tabindex="-1"><a class="header-anchor" href="#java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°"><span><a href="#java-debug-tool%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0">#</a> Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°</span></a></h3><h4 id="å‘½ä»¤æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤æ‰§è¡Œ"><span><a href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C">#</a> å‘½ä»¤æ‰§è¡Œ</span></a></h4><p>ä¸Šæ–‡å·²ç»å®Œæ•´çš„æè¿°äº†Java-debug-toolçš„è®¾è®¡ä»¥åŠæ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆï¼Œæœ¬å°èŠ‚å°†è¯¦ç»†ä»‹ç»Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°ã€‚é¦–å…ˆéœ€è¦å°†ä¸€ä¸ªè°ƒè¯•å‘½ä»¤çš„æ‰§è¡Œæµç¨‹æè¿°æ¸…æ¥šï¼Œä¸‹é¢æ˜¯ä¸€å¼ ç”¨æ¥è¡¨ç¤ºå‘½ä»¤è¯·æ±‚å¤„ç†æµç¨‹çš„å›¾ç‰‡ï¼š</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-6.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ä¸Šå›¾ç®€å•çš„æè¿°äº†Java-debug-toolçš„å‘½ä»¤å¤„ç†æ–¹å¼ï¼Œå®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯ä¹‹åï¼Œä¼šè¿›è¡Œä¸€äº›åè®®è§£æã€åè®®è®¤è¯ã€åè®®å¡«å……ç­‰å·¥ä½œï¼Œä¹‹åå°†è¿›è¡Œå‘½ä»¤åˆ†å‘ã€‚æœåŠ¡ç«¯å¦‚æœå‘ç°å®¢æˆ·ç«¯çš„å‘½ä»¤ä¸åˆæ³•ï¼Œåˆ™ä¼šç«‹å³è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦åˆ™å†è¿›è¡Œå‘½ä»¤å¤„ç†ã€‚å‘½ä»¤å¤„ç†å±äºå…¸å‹çš„ä¸‰æ®µå¼å¤„ç†ï¼Œå‰ç½®å‘½ä»¤å¤„ç†ã€å‘½ä»¤å¤„ç†ä»¥åŠåç½®å‘½ä»¤å¤„ç†ï¼ŒåŒæ—¶ä¼šå¯¹å‘½ä»¤å¤„ç†è¿‡ç¨‹ä¸­çš„å¼‚å¸¸ä¿¡æ¯è¿›è¡Œæ•è·å¤„ç†ï¼Œä¸‰æ®µå¼å¤„ç†çš„å¥½å¤„æ˜¯å‘½ä»¤å¤„ç†è¢«æ‹†æˆäº†å¤šä¸ªé˜¶æ®µï¼Œå¤šä¸ªé˜¶æ®µè´Ÿè´£ä¸åŒçš„èŒè´£ã€‚å‰ç½®å‘½ä»¤å¤„ç†ç”¨æ¥åšä¸€äº›å‘½ä»¤æƒé™æ§åˆ¶çš„å·¥ä½œï¼Œå¹¶å¡«å……ä¸€äº›ç±»ä¼¼å‘½ä»¤å¤„ç†å¼€å§‹æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå‘½ä»¤å¤„ç†å°±æ˜¯é€šè¿‡å­—èŠ‚ç å¢å¼ºï¼ŒæŒ‚è½½Adviceè¿›è¡Œæ•°æ®æ”¶é›†ï¼Œå†ç»è¿‡æ•°æ®å¤„ç†æ¥äº§ç”Ÿå‘½ä»¤ç»“æœçš„è¿‡ç¨‹ï¼Œåç½®å¤„ç†åˆ™ç”¨æ¥å¤„ç†ä¸€äº›è¿æ¥å…³é—­ã€å­—èŠ‚ç è§£é”ç­‰äº‹é¡¹ã€‚</p><p>Java-debug-toolå…è®¸å®¢æˆ·ç«¯è®¾ç½®ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´åˆ™è®¤ä¸ºå‘½ä»¤æ²¡æœ‰ç»“æœï¼Œå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰è®¾ç½®è‡ªå·±çš„è¶…æ—¶æ—¶é—´ï¼Œå°±ä½¿ç”¨é»˜è®¤çš„è¶…æ—¶æ—¶é—´è¿›è¡Œè¶…æ—¶æ§åˆ¶ã€‚Java-debug-toolé€šè¿‡è®¾è®¡äº†ä¸¤é˜¶æ®µçš„è¶…æ—¶æ£€æµ‹æœºåˆ¶æ¥å®ç°å‘½ä»¤æ‰§è¡Œè¶…æ—¶åŠŸèƒ½ï¼šé¦–å…ˆï¼Œç¬¬ä¸€é˜¶æ®µè¶…æ—¶è§¦å‘ï¼Œåˆ™Java-debug-toolä¼šå‹å¥½çš„è­¦å‘Šå‘½ä»¤å¤„ç†æ¨¡å—å¤„ç†æ—¶é—´å·²ç»è¶…æ—¶ï¼Œéœ€è¦ç«‹å³åœæ­¢å‘½ä»¤æ‰§è¡Œï¼Œè¿™å…è®¸å‘½ä»¤è‡ªå·±åšä¸€äº›ç°åœºæ¸…ç†å·¥ä½œï¼Œå½“ç„¶éœ€è¦å‘½ä»¤æ‰§è¡Œçº¿ç¨‹è‡ªå·±æ„ŸçŸ¥åˆ°è¿™ç§è¶…æ—¶è­¦å‘Šï¼›å½“ç¬¬äºŒé˜¶æ®µè¶…æ—¶è§¦å‘ï¼Œåˆ™Java-debug-toolè®¤ä¸ºå‘½ä»¤å¿…é¡»ç»“æŸæ‰§è¡Œï¼Œä¼šå¼ºè¡Œæ‰“æ–­å‘½ä»¤æ‰§è¡Œçº¿ç¨‹ã€‚è¶…æ—¶æœºåˆ¶çš„ç›®çš„æ˜¯ä¸ºäº†ä¸è®©å‘½ä»¤æ‰§è¡Œå¤ªé•¿æ—¶é—´ï¼Œå‘½ä»¤å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ”¶é›†åˆ°è°ƒè¯•æ•°æ®ï¼Œåˆ™åº”è¯¥åœæ­¢æ‰§è¡Œï¼Œå¹¶æ€è€ƒæ˜¯å¦è°ƒè¯•äº†ä¸€ä¸ªé”™è¯¯çš„æ–¹æ³•ã€‚å½“ç„¶ï¼Œè¶…æ—¶æœºåˆ¶è¿˜å¯ä»¥å®šæœŸæ¸…ç†é‚£äº›å› ä¸ºæœªçŸ¥åŸå› æ–­å¼€è¿æ¥çš„å®¢æˆ·ç«¯æŒæœ‰çš„è°ƒè¯•èµ„æºï¼Œæ¯”å¦‚å­—èŠ‚ç é”ã€‚</p><h4 id="è·å–æ–¹æ³•æ‰§è¡Œè§†å›¾" tabindex="-1"><a class="header-anchor" href="#è·å–æ–¹æ³•æ‰§è¡Œè§†å›¾"><span><a href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E8%A7%86%E5%9B%BE">#</a> è·å–æ–¹æ³•æ‰§è¡Œè§†å›¾</span></a></h4><p>Java-debug-toolé€šè¿‡ä¸‹é¢çš„ä¿¡æ¯æ¥å‘è°ƒè¯•è€…å‘ˆç°å‡ºä¸€æ¬¡æ–¹æ³•æ‰§è¡Œçš„è§†å›¾ï¼š</p><ul><li>æ­£åœ¨è°ƒè¯•çš„æ–¹æ³•ä¿¡æ¯ã€‚</li><li>æ–¹æ³•è°ƒç”¨å †æ ˆã€‚</li><li>è°ƒè¯•è€—æ—¶ï¼ŒåŒ…æ‹¬å¯¹ç›®æ ‡JVMé€ æˆçš„STWæ—¶é—´ã€‚</li><li>æ–¹æ³•å…¥å‚ï¼ŒåŒ…æ‹¬å…¥å‚çš„ç±»å‹åŠå‚æ•°å€¼ã€‚</li><li>æ–¹æ³•çš„æ‰§è¡Œè·¯å¾„ã€‚</li><li>ä»£ç æ‰§è¡Œè€—æ—¶ã€‚</li><li>å±€éƒ¨å˜é‡ä¿¡æ¯ã€‚</li><li>æ–¹æ³•è¿”å›ç»“æœã€‚</li><li>æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ã€‚</li><li>å¯¹è±¡å­—æ®µå€¼å¿«ç…§ã€‚</li></ul><p>ä¸‹å›¾å±•ç¤ºäº†Java-debug-toolè·å–åˆ°æ­£åœ¨è¿è¡Œçš„æ–¹æ³•çš„æ‰§è¡Œè§†å›¾çš„ä¿¡æ¯ã€‚</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-7.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ" tabindex="-1"><a class="header-anchor" href="#java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ"><span><a href="#java-debug-tool%E4%B8%8E%E5%90%8C%E7%B1%BB%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90">#</a> Java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ</span></a></h3><p>Java-debug-toolçš„åŒç±»äº§å“ä¸»è¦æ˜¯greysï¼Œå…¶ä»–ç±»ä¼¼çš„å·¥å…·å¤§éƒ¨åˆ†éƒ½æ˜¯åŸºäºgreysè¿›è¡Œçš„äºŒæ¬¡å¼€å‘ï¼Œæ‰€ä»¥ç›´æ¥é€‰æ‹©greysæ¥å’ŒJava-debug-toolè¿›è¡Œå¯¹æ¯”ã€‚</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-jvm-agent-8.jpg" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>æœ¬æ–‡è¯¦ç»†å‰–æäº†JavaåŠ¨æ€è°ƒè¯•å…³é”®æŠ€æœ¯çš„å®ç°ç»†èŠ‚ï¼Œå¹¶ä»‹ç»äº†æˆ‘ä»¬åŸºäºJavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯ç»“åˆå®é™…æ•…éšœæ’æŸ¥åœºæ™¯è¿›è¡Œçš„ä¸€ç‚¹æ¢ç´¢å®è·µï¼›åŠ¨æ€è°ƒè¯•æŠ€æœ¯ä¸ºç ”å‘äººå‘˜è¿›è¡Œçº¿ä¸Šé—®é¢˜æ’æŸ¥æä¾›äº†ä¸€ç§æ–°çš„æ€è·¯ï¼Œæˆ‘ä»¬åŸºäºåŠ¨æ€è°ƒè¯•æŠ€æœ¯è§£å†³äº†ä¼ ç»Ÿæ–­ç‚¹è°ƒè¯•å­˜åœ¨çš„é—®é¢˜ï¼Œä½¿å¾—å¯ä»¥å°†æ–­ç‚¹è°ƒè¯•è¿™ç§æŠ€æœ¯åº”ç”¨åœ¨çº¿ä¸Šï¼Œä»¥çº¿ä¸‹è°ƒè¯•çš„æ€ç»´æ¥è¿›è¡Œçº¿ä¸Šè°ƒè¯•ï¼Œæé«˜é—®é¢˜æ’æŸ¥æ•ˆç‡ã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒæ–‡çŒ®"><span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">#</a> å‚è€ƒæ–‡çŒ®</span></a></h2><ul><li><a href="https://asm.ow2.io/asm4-guide.pdf" target="_blank" rel="noopener noreferrer">ASM 4 guideåœ¨æ–°çª—å£æ‰“å¼€<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html" target="_blank" rel="noopener noreferrer">Java Virtual Machine Specificationåœ¨æ–°çª—å£æ‰“å¼€<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://docs.oracle.com/javase/8/docs/platform/jvmti/jvmti.html" target="_blank" rel="noopener noreferrer">JVM Tool Interfaceåœ¨æ–°çª—å£æ‰“å¼€<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://alibaba.github.io/arthas/" target="_blank" rel="noopener noreferrer">alibaba arthasåœ¨æ–°çª—å£æ‰“å¼€<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/pandening/openjdk" target="_blank" rel="noopener noreferrer">openjdk<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!--[--><div class="sponsor" data-v-3ae5c108><div id="drinks-box" data-v-3ae5c108><div id="drinks-box-s" class="drinks-button left-100" data-v-3ae5c108><div id="drinks-icons" class="left-100 tr3" data-v-3ae5c108><div id="coffee-donate" class="icon-donate" data-v-3ae5c108><span class="font-icon icon iconfont icon-hk-flutter" data-v-3ae5c108></span> èµåŠ© </div></div><div id="drinks-button-box" class="tr3 left-100" data-v-3ae5c108><div id="drinks-button-bg" class="left-100" data-v-3ae5c108></div><div id="github-box" data-v-3ae5c108><a href="https://github.com/lixuanfengs/Cactus" target="_blank" data-v-3ae5c108>Github</a></div><ul id="donate-buttons" class="list tr3" data-v-3ae5c108><li id="paypal_donate" data-v-3ae5c108><a href="https://www.paypal.me/oragekk" target="_blank" data-v-3ae5c108>Paypal</a></li><!-- <li id="btc_donate" class="donate-button">Bitcoin</li> --><li id="alipay_donate" class="donate-button" data-v-3ae5c108>AliPay</li><li id="wechat_donate" class="donate-button2" data-v-3ae5c108>WeChat</li></ul></div><div id="drinks-qrcodes" class="left-100 tr3" data-v-3ae5c108><div id="drinks-qrcode" data-v-3ae5c108></div></div></div></div></div><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/lixuanfengs/Cactus/edit/main/src/posts/Java/JVM/è°ƒè¯•æ’é”™ JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 1183895890@qq.com">lixuanfengs</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/posts/Java/JVM/%E8%B0%83%E8%AF%95%E6%8E%92%E9%94%99%20Java%20%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8B%E4%BD%BF%E7%94%A8IDEA%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E5%92%8C%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95.html" aria-label="è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->è°ƒè¯•æ’é”™ Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•</div></a><!----></nav><div id="vp-comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><div class="wl-reaction"><div class="wl-reaction-title">ä½ è®¤ä¸ºè¿™ç¯‡æ–‡ç« æ€ä¹ˆæ ·ï¼Ÿ</div><ul class="wl-reaction-list"><!--[--><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_agree.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_look_down.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sunglasses.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_pick_nose.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_awkward.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sleep.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><!--]--></ul></div><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">æ˜µç§°</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">é‚®ç®±(å¯é€‰)</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">ç½‘å€(å¯é€‰)</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="è¯·ç•™è¨€ã€‚(å¡«å†™é‚®ç®±å¯åœ¨è¢«å›å¤æ—¶æ”¶åˆ°é‚®ä»¶æé†’)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>é¢„è§ˆ:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="è¡¨æƒ…" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="è¡¨æƒ…åŒ…"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="ä¸Šä¼ å›¾ç‰‡"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="é¢„è§ˆ"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <span> Â /Â  <span class="">300</span></span> Â å­—</div><button type="button" class="wl-btn">ç™»å½•</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->æäº¤<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="æœç´¢è¡¨æƒ…åŒ…"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> è¯„è®º</div><ul class="wl-sort"><!--[--><li class="active">æŒ‰æ­£åº</li><li class="">æŒ‰å€’åº</li><li class="">æŒ‰çƒ­åº¦</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.1.3</div></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper" style="display:none;--a5550e7c:;"><div class="busuanzi"><span id="busuanzi_container_site_pv" style="display:none;"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span>æ¬¡ <span class="post-meta-divider">|</span></span><span id="busuanzi_container_site_uv" style="display:none;"> æ‚¨æ˜¯æœ¬ç«™ç¬¬ <span id="busuanzi_value_site_uv"></span>ä½è®¿é—®è€… </span></div><div class="footer-content"><div class="footer">é»˜è®¤é¡µè„š</div><div class="copyright">Copyright Â© 2018-2024 Cactus li</div></div><span id="runtime_span"></span><!--        <div class="footer-link">--><!--            <a href="https://www.foreverblog.cn/go.html" target="_blank">--><!--                <img--><!--                        :src="wormhole"--><!--                        alt=""--><!--                        style="width: auto; height: 32px"--><!--                        title="ç©¿æ¢­è™«æ´-éšæœºè®¿é—®åå¹´ä¹‹çº¦å‹é“¾åšå®¢"--><!--                /></a>--><!--            <a href="https://www.travellings.cn/go.html" target="_blank">--><!--                <img--><!--                        src="https://www.travellings.cn/assets/logo.gif"--><!--                        alt=""--><!--                        style="width: auto; height: 32px"--><!--                        title="å¼€å¾€-å‹é“¾æ¥åŠ›"--><!--                /></a>--><!--            &lt;!&ndash; <a href="https://www.foreverblog.cn/" target="_blank">--><!--              <img src="https://img.foreverblog.cn/logo_en_default.png" alt="" style="width: auto; height: 16px" />--><!--            </a> &ndash;&gt;--><!--        </div>--></footer></div><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Ntmq5oN3.js" defer></script>
  </body>
</html>
