<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.41" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://cactusli.net/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20ConcurrentHashMap%20%E8%AF%A6%E8%A7%A3.html"><meta property="og:site_name" content="Cactus's Blog"><meta property="og:title" content="JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£"><meta property="og:description" content="DK1.7ä¹‹å‰çš„ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”æœºåˆ¶å®ç°ï¼ŒJDK1.8åˆ™ä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘æ•°æ®ç»“æ„å’ŒCASåŸå­æ“ä½œå®ç°ConcurrentHashMapï¼›æœ¬æ–‡å°†åˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§æ–¹å¼çš„å®ç°æ–¹æ¡ˆåŠå…¶åŒºåˆ«ã€‚ JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ ä¸ºä»€ä¹ˆHashTableæ…¢ Concurrent..."><meta property="og:type" content="article"><meta property="og:image" content="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-concurrent-hashmap-1.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-08T03:51:56.000Z"><meta property="article:author" content="Cactus li"><meta property="article:tag" content="Java"><meta property="article:tag" content="Thread"><meta property="article:tag" content="concurrency"><meta property="article:published_time" content="2024-03-07T10:15:26.000Z"><meta property="article:modified_time" content="2024-03-08T03:51:56.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£","image":["https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-concurrent-hashmap-1.png","https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-concurrent-hashmap-2.png"],"datePublished":"2024-03-07T10:15:26.000Z","dateModified":"2024-03-08T03:51:56.000Z","author":[{"@type":"Person","name":"Cactus li","url":"https://cactusli.net"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><link rel="alternate" type="application/rss+xml" href="https://cactusli.net/rss.xml" title="Cactus's Blog RSS Feed"><title>JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£ | Cactus's Blog</title><meta name="description" content="DK1.7ä¹‹å‰çš„ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”æœºåˆ¶å®ç°ï¼ŒJDK1.8åˆ™ä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘æ•°æ®ç»“æ„å’ŒCASåŸå­æ“ä½œå®ç°ConcurrentHashMapï¼›æœ¬æ–‡å°†åˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§æ–¹å¼çš„å®ç°æ–¹æ¡ˆåŠå…¶åŒºåˆ«ã€‚ JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ ä¸ºä»€ä¹ˆHashTableæ…¢ Concurrent...">
    <link rel="preload" href="/assets/style-Dpvef-Js.css" as="style"><link rel="stylesheet" href="/assets/style-Dpvef-Js.css">
    <link rel="modulepreload" href="/assets/app-DiJfzvPX.js"><link rel="modulepreload" href="/assets/JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£.html-DIT-ahOA.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">Cactus&#39;s Blog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/" aria-label="ä¸»é¡µ"><span class="font-icon icon iconfont icon-zhuye" style=""></span>ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/demo/" aria-label="å¯¼èˆª"><span class="font-icon icon iconfont icon-daohang" style=""></span>å¯¼èˆª<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="çŸ¥è¯†ä½“ç³»"><!--[--><span class="font-icon icon iconfont icon-biji" style=""></span>çŸ¥è¯†ä½“ç³»<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">åç«¯</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link active vp-link" href="/posts/Java/" aria-label="Java"><span class="font-icon icon iconfont icon-java" style=""></span>Java<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link vp-link" href="/posts/Python/" aria-label="Python"><span class="font-icon icon iconfont icon-python" style=""></span>Python<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">å‰ç«¯</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link vp-link" href="/webs/ES6/" aria-label="ES6"><span class="font-icon icon iconfont icon-code" style=""></span>ES6<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link vp-link" href="/webs/TypeScript/" aria-label="TypeScript"><span class="font-icon icon iconfont icon-code" style=""></span>TypeScript<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">æœåŠ¡å™¨</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link vp-link" href="/linuxs/Linux/" aria-label="Linux"><span class="font-icon icon iconfont icon-linux" style=""></span>Linux<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">åšå®¢ç›¸å…³</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link vp-link" href="/blog/" aria-label="åšå®¢ç›¸å…³"><span class="font-icon icon iconfont icon-blog" style=""></span>åšå®¢ç›¸å…³<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/tutorial/" aria-label="å·¥å…·|è½¯ä»¶"><span class="font-icon icon iconfont icon-ruanjian" style=""></span>å·¥å…·|è½¯ä»¶<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/collect.html" aria-label="æ”¶è—"><span class="font-icon icon iconfont icon-shoucang1" style=""></span>æ”¶è—<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/visitorsbook.html" aria-label="ç•™è¨€æ¿"><span class="font-icon icon iconfont icon-liuyanpinglun" style=""></span>ç•™è¨€æ¿<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/friend.html" aria-label="å‹é“¾"><span class="font-icon icon iconfont icon-duankailianjie" style=""></span>å‹é“¾<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="å…³äº"><!--[--><span class="font-icon icon iconfont icon-guanyu" style=""></span>å…³äº<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link vp-link" href="/intro.html" aria-label="å…³äºæˆ‘"><span class="font-icon icon iconfont icon-people" style=""></span>å…³äºæˆ‘<!----></a></li><li class="vp-dropdown-item"><a class="route-link vp-link" href="/about.html" aria-label="å…³äºæœ¬ç«™"><span class="font-icon icon iconfont icon-info" style=""></span>å…³äºæœ¬ç«™<!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/lixuanfengs/Cactus" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/" aria-label="Java çŸ¥è¯†ä½“ç³»"><span class="font-icon icon iconfont icon-java" style=""></span>Java çŸ¥è¯†ä½“ç³»<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="vp-sidebar-title">Java åŸºç¡€</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-list" style=""></span><span class="vp-sidebar-title">Java é›†åˆæ¡†æ¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><span class="font-icon icon iconfont icon-proxy" style=""></span><span class="vp-sidebar-title">Java å¤šçº¿ç¨‹å’Œå¹¶å‘</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/Java%20%E5%B9%B6%E5%8F%91%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.html" aria-label="Java å¹¶å‘çŸ¥è¯†ä½“ç³»"><!---->Java å¹¶å‘çŸ¥è¯†ä½“ç³»<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/Java%20%E5%B9%B6%E5%8F%91%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86%E7%82%B9.html" aria-label="Java å¹¶å‘ä¹‹åŸºç¡€ç†è®ºçŸ¥è¯†ç‚¹"><!---->Java å¹¶å‘ä¹‹åŸºç¡€ç†è®ºçŸ¥è¯†ç‚¹<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/Java%20%E5%B9%B6%E5%8F%91%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html" aria-label="Java å¹¶å‘ä¹‹çº¿ç¨‹åŸºç¡€"><!---->Java å¹¶å‘ä¹‹çº¿ç¨‹åŸºç¡€<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/Java%20%E5%B9%B6%E5%8F%91%E4%B9%8BJava%E4%B8%AD%E7%9A%84%E9%94%81.html" aria-label="Java å¹¶å‘ä¹‹Javaä¸­çš„é”"><!---->Java å¹¶å‘ä¹‹Javaä¸­çš„é”<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/%E5%85%B3%E9%94%AE%E5%AD%97%20synchronized%20%E8%A7%A3%E6%9E%90.html" aria-label="å…³é”®å­— synchronized è§£æ"><!---->å…³é”®å­— synchronized è§£æ<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/%E5%85%B3%E9%94%AE%E5%AD%97%20volatile%20%E8%A7%A3%E6%9E%90.html" aria-label="å…³é”®å­— volatile è§£æ"><!---->å…³é”®å­— volatile è§£æ<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/%E5%85%B3%E9%94%AE%E5%AD%97%20final%20%E8%A7%A3%E6%9E%90.html" aria-label="å…³é”®å­— final è§£æ"><!---->å…³é”®å­— final è§£æ<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB%E6%8C%87%E5%8D%97.html" aria-label="JUC çŸ¥è¯†æ±‡æ€»æŒ‡å—"><!---->JUC çŸ¥è¯†æ±‡æ€»æŒ‡å—<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E4%B8%AD%E7%9A%84CAS_%20Unsafe%E5%92%8C%E5%8E%9F%E5%AD%90%E7%B1%BB%E8%A7%A3%E6%9E%90.html" aria-label="JUC ä¸­çš„CAS, Unsafeå’ŒåŸå­ç±»è§£æ"><!---->JUC ä¸­çš„CAS, Unsafeå’ŒåŸå­ç±»è§£æ<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E9%94%81%E4%B9%8B%20LockSupport%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é”ä¹‹ LockSupport è¯¦è§£"><!---->JUC é”ä¹‹ LockSupport è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E9%94%81%E4%B9%8B%E6%A0%B8%E5%BF%83%E7%B1%BB%20AQS%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é”ä¹‹æ ¸å¿ƒç±» AQS è¯¦è§£"><!---->JUC é”ä¹‹æ ¸å¿ƒç±» AQS è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E9%94%81%E4%B9%8B%20ReentrantLock%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é”ä¹‹ ReentrantLock è¯¦è§£"><!---->JUC é”ä¹‹ ReentrantLock è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E9%94%81%E4%B9%8B%20ReentrantReadWriteLock%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é”ä¹‹ ReentrantReadWriteLock è¯¦è§£"><!---->JUC é”ä¹‹ ReentrantReadWriteLock è¯¦è§£<!----></a></li><li><a class="route-link active vp-link vp-sidebar-link vp-sidebar-page active" href="/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20ConcurrentHashMap%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£"><!---->JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20CopyOnWriteArrayList%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é›†åˆä¹‹ CopyOnWriteArrayList è¯¦è§£"><!---->JUC é›†åˆä¹‹ CopyOnWriteArrayList è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20ConcurrentLinkedQueue%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é›†åˆä¹‹ ConcurrentLinkedQueue è¯¦è§£"><!---->JUC é›†åˆä¹‹ ConcurrentLinkedQueue è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20BlockingQueue%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é›†åˆä¹‹ BlockingQueue è¯¦è§£"><!---->JUC é›†åˆä¹‹ BlockingQueue è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8B%20FutureTask%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC çº¿ç¨‹æ± ä¹‹ FutureTask è¯¦è§£"><!---->JUC çº¿ç¨‹æ± ä¹‹ FutureTask è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8B%20ThreadPoolExecutor%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC çº¿ç¨‹æ± ä¹‹ ThreadPoolExecutor è¯¦è§£"><!---->JUC çº¿ç¨‹æ± ä¹‹ ThreadPoolExecutor è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8B%20ScheduledThreadPoolExecutor%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC çº¿ç¨‹æ± ä¹‹ ScheduledThreadPoolExecutor è¯¦è§£"><!---->JUC çº¿ç¨‹æ± ä¹‹ ScheduledThreadPoolExecutor è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8B%20Fork-Join%20%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3.html" aria-label="JUC çº¿ç¨‹æ± ä¹‹ Fork-Join æ¡†æ¶è¯¦è§£"><!---->JUC çº¿ç¨‹æ± ä¹‹ Fork-Join æ¡†æ¶è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8B%20CountDownLatch%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC å·¥å…·ç±»ä¹‹ CountDownLatch è¯¦è§£"><!---->JUC å·¥å…·ç±»ä¹‹ CountDownLatch è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8B%20CyclicBarrier%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC å·¥å…·ç±»ä¹‹ CyclicBarrier è¯¦è§£"><!---->JUC å·¥å…·ç±»ä¹‹ CyclicBarrier è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8B%20Semaphore%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC å·¥å…·ç±»ä¹‹ Semaphore è¯¦è§£"><!---->JUC å·¥å…·ç±»ä¹‹ Semaphore è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8B%20Phaser%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC å·¥å…·ç±»ä¹‹ Phaser è¯¦è§£"><!---->JUC å·¥å…·ç±»ä¹‹ Phaser è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/JUC%20%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8B%20Exchanger%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC å·¥å…·ç±»ä¹‹ Exchanger è¯¦è§£"><!---->JUC å·¥å…·ç±»ä¹‹ Exchanger è¯¦è§£<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/posts/Java/ThreadConcurrency/Java%20%E5%B9%B6%E5%8F%91%E4%B9%8B%20ThreadLocal%20%E8%AF%A6%E8%A7%A3.html" aria-label="Java å¹¶å‘ä¹‹ ThreadLocal è¯¦è§£"><!---->Java å¹¶å‘ä¹‹ ThreadLocal è¯¦è§£<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-IO" style=""></span><span class="vp-sidebar-title">Java IO/NIO/AIO</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="vp-sidebar-title">Java8 æ–°ç‰¹æ€§</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><span class="font-icon icon iconfont icon-java" style=""></span><span class="vp-sidebar-title">JVM æ ¸å¿ƒçŸ¥è¯†ç‚¹</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://cactusli.net" target="_blank" rel="noopener noreferrer">Cactus li</a></span><span property="author" content="Cactus li"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-07T10:15:26.000Z"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20ConcurrentHashMap%20%E8%AF%A6%E8%A7%A3.html" data-page-key="/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20ConcurrentHashMap%20%E8%AF%A6%E8%A7%A3.html">...</span></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 31 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT31M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category8 clickable" role="navigation">Java</span><!--]--><meta property="articleSection" content="Java"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag8 clickable" role="navigation">Java</span><span class="page-tag-item tag3 clickable" role="navigation">Thread</span><span class="page-tag-item tag5 clickable" role="navigation">concurrency</span><!--]--><meta property="keywords" content="Java,Thread,concurrency"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£"># å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ä¸ºä»€ä¹ˆhashtableæ…¢"># ä¸ºä»€ä¹ˆHashTableæ…¢</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#concurrenthashmap-jdk-1-7"># ConcurrentHashMap - JDK 1.7</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ•°æ®ç»“æ„"># æ•°æ®ç»“æ„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆå§‹åŒ–"># åˆå§‹åŒ–</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#put-è¿‡ç¨‹åˆ†æ"># put è¿‡ç¨‹åˆ†æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆå§‹åŒ–æ§½-ensuresegment"># åˆå§‹åŒ–æ§½: ensureSegment</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è·å–å†™å…¥é”-scanandlockforput"># è·å–å†™å…¥é”: scanAndLockForPut</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ‰©å®¹-rehash"># æ‰©å®¹: rehash</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#get-è¿‡ç¨‹åˆ†æ"># get è¿‡ç¨‹åˆ†æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¹¶å‘é—®é¢˜åˆ†æ"># å¹¶å‘é—®é¢˜åˆ†æ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#concurrenthashmap-jdk-1-8"># ConcurrentHashMap - JDK 1.8</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ•°æ®ç»“æ„-1"># æ•°æ®ç»“æ„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆå§‹åŒ–-1"># åˆå§‹åŒ–</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#put-è¿‡ç¨‹åˆ†æ-1"># put è¿‡ç¨‹åˆ†æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆå§‹åŒ–æ•°ç»„-inittable"># åˆå§‹åŒ–æ•°ç»„: initTable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifybin"># é“¾è¡¨è½¬çº¢é»‘æ ‘: treeifyBin</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ‰©å®¹-trypresize"># æ‰©å®¹: tryPresize</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ•°æ®è¿ç§»-transfer"># æ•°æ®è¿ç§»: transfer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#get-è¿‡ç¨‹åˆ†æ-1"># get è¿‡ç¨‹åˆ†æ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å¯¹æ¯”æ€»ç»“"># å¯¹æ¯”æ€»ç»“</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><blockquote><p>DK1.7ä¹‹å‰çš„ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”æœºåˆ¶å®ç°ï¼ŒJDK1.8åˆ™ä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘æ•°æ®ç»“æ„å’ŒCASåŸå­æ“ä½œå®ç°ConcurrentHashMapï¼›æœ¬æ–‡å°†åˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§æ–¹å¼çš„å®ç°æ–¹æ¡ˆåŠå…¶åŒºåˆ«ã€‚</p></blockquote><ul><li>JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£ <ul><li><a href="#%E5%B8%A6%E7%9D%80bat%E5%A4%A7%E5%8E%82%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8E%BB%E7%90%86%E8%A7%A3">å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£</a></li><li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88hashtable%E6%85%A2">ä¸ºä»€ä¹ˆHashTableæ…¢</a></li><li>ConcurrentHashMap - JDK 1.7 <ul><li><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">æ•°æ®ç»“æ„</a></li><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">åˆå§‹åŒ–</a></li><li><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">put è¿‡ç¨‹åˆ†æ</a></li><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A7%BD-ensuresegment">åˆå§‹åŒ–æ§½: ensureSegment</a></li><li><a href="#%E8%8E%B7%E5%8F%96%E5%86%99%E5%85%A5%E9%94%81-scanandlockforput">è·å–å†™å…¥é”: scanAndLockForPut</a></li><li><a href="#%E6%89%A9%E5%AE%B9-rehash">æ‰©å®¹: rehash</a></li><li><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">get è¿‡ç¨‹åˆ†æ</a></li><li><a href="#%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">å¹¶å‘é—®é¢˜åˆ†æ</a></li></ul></li><li>ConcurrentHashMap - JDK 1.8 <ul><li><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1">æ•°æ®ç»“æ„</a></li><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1">åˆå§‹åŒ–</a></li><li><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-1">put è¿‡ç¨‹åˆ†æ</a></li><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84-inittable">åˆå§‹åŒ–æ•°ç»„: initTable</a></li><li><a href="#%E9%93%BE%E8%A1%A8%E8%BD%AC%E7%BA%A2%E9%BB%91%E6%A0%91-treeifybin">é“¾è¡¨è½¬çº¢é»‘æ ‘: treeifyBin</a></li><li><a href="#%E6%89%A9%E5%AE%B9-trypresize">æ‰©å®¹: tryPresize</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB-transfer">æ•°æ®è¿ç§»: transfer</a></li><li><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-1">get è¿‡ç¨‹åˆ†æ</a></li></ul></li><li><a href="#%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93">å¯¹æ¯”æ€»ç»“</a></li><li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">å‚è€ƒæ–‡ç« </a></li></ul></li></ul><h2 id="å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£" tabindex="-1"><a class="header-anchor" href="#å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£"><span><a href="#%E5%B8%A6%E7%9D%80bat%E5%A4%A7%E5%8E%82%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8E%BB%E7%90%86%E8%A7%A3">#</a> å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£</span></a></h2><p>æç¤º</p><p>è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚@pdai</p><ul><li>ä¸ºä»€ä¹ˆHashTableæ…¢? å®ƒçš„å¹¶å‘åº¦æ˜¯ä»€ä¹ˆ? é‚£ä¹ˆConcurrentHashMapå¹¶å‘åº¦æ˜¯ä»€ä¹ˆ?</li><li>ConcurrentHashMapåœ¨JDK1.7å’ŒJDK1.8ä¸­å®ç°æœ‰ä»€ä¹ˆå·®åˆ«? JDK1.8è§£æ±ºäº†JDK1.7ä¸­ä»€ä¹ˆé—®é¢˜</li><li>ConcurrentHashMap JDK1.7å®ç°çš„åŸç†æ˜¯ä»€ä¹ˆ? åˆ†æ®µé”æœºåˆ¶</li><li>ConcurrentHashMap JDK1.8å®ç°çš„åŸç†æ˜¯ä»€ä¹ˆ? æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ï¼ŒCAS</li><li>ConcurrentHashMap JDK1.7ä¸­Segmentæ•°(concurrencyLevel)é»˜è®¤å€¼æ˜¯å¤šå°‘? ä¸ºä½•ä¸€æ—¦åˆå§‹åŒ–å°±ä¸å¯å†æ‰©å®¹?</li><li>ConcurrentHashMap JDK1.7è¯´è¯´å…¶putçš„æœºåˆ¶?</li><li>ConcurrentHashMap JDK1.7æ˜¯å¦‚ä½•æ‰©å®¹çš„? rehash(æ³¨ï¼šsegment æ•°ç»„ä¸èƒ½æ‰©å®¹ï¼Œæ‰©å®¹æ˜¯ segment æ•°ç»„æŸä¸ªä½ç½®å†…éƒ¨çš„æ•°ç»„ HashEntry&lt;K,V&gt;[] è¿›è¡Œæ‰©å®¹)</li><li>ConcurrentHashMap JDK1.8æ˜¯å¦‚ä½•æ‰©å®¹çš„? tryPresize</li><li>ConcurrentHashMap JDK1.8é“¾è¡¨è½¬çº¢é»‘æ ‘çš„æ—¶æœºæ˜¯ä»€ä¹ˆ? ä¸´ç•Œå€¼ä¸ºä»€ä¹ˆæ˜¯8?</li><li>ConcurrentHashMap JDK1.8æ˜¯å¦‚ä½•è¿›è¡Œæ•°æ®è¿ç§»çš„? transfer</li></ul><h2 id="ä¸ºä»€ä¹ˆhashtableæ…¢" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆhashtableæ…¢"><span><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88hashtable%E6%85%A2">#</a> ä¸ºä»€ä¹ˆHashTableæ…¢</span></a></h2><p>Hashtableä¹‹æ‰€ä»¥æ•ˆç‡ä½ä¸‹ä¸»è¦æ˜¯å› ä¸ºå…¶å®ç°ä½¿ç”¨äº†synchronizedå…³é”®å­—å¯¹putç­‰æ“ä½œè¿›è¡ŒåŠ é”ï¼Œè€Œsynchronizedå…³é”®å­—åŠ é”æ˜¯å¯¹æ•´ä¸ªå¯¹è±¡è¿›è¡ŒåŠ é”ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿›è¡Œputç­‰ä¿®æ”¹Hashè¡¨çš„æ“ä½œæ—¶ï¼Œé”ä½äº†æ•´ä¸ªHashè¡¨ï¼Œä»è€Œä½¿å¾—å…¶è¡¨ç°çš„æ•ˆç‡ä½ä¸‹ã€‚</p><h2 id="concurrenthashmap-jdk-1-7" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-jdk-1-7"><span><a href="#concurrenthashmap-jdk-1-7">#</a> ConcurrentHashMap - JDK 1.7</span></a></h2><p>åœ¨JDK1.5~1.7ç‰ˆæœ¬ï¼ŒJavaä½¿ç”¨äº†åˆ†æ®µé”æœºåˆ¶å®ç°ConcurrentHashMap.</p><p>ç®€è€Œè¨€ä¹‹ï¼ŒConcurrentHashMapåœ¨å¯¹è±¡ä¸­ä¿å­˜äº†ä¸€ä¸ªSegmentæ•°ç»„ï¼Œå³å°†æ•´ä¸ªHashè¡¨åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†æ®µï¼›è€Œæ¯ä¸ªSegmentå…ƒç´ ï¼Œå³æ¯ä¸ªåˆ†æ®µåˆ™ç±»ä¼¼äºä¸€ä¸ªHashtableï¼›è¿™æ ·ï¼Œåœ¨æ‰§è¡Œputæ“ä½œæ—¶é¦–å…ˆæ ¹æ®hashç®—æ³•å®šä½åˆ°å…ƒç´ å±äºå“ªä¸ªSegmentï¼Œç„¶åå¯¹è¯¥SegmentåŠ é”å³å¯ã€‚å› æ­¤ï¼ŒConcurrentHashMapåœ¨å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹ä¸­å¯æ˜¯å®ç°å¤šçº¿ç¨‹putæ“ä½œã€‚æ¥ä¸‹æ¥åˆ†æJDK1.7ç‰ˆæœ¬ä¸­ConcurrentHashMapçš„å®ç°åŸç†ã€‚</p><h3 id="æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„"><span><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a> æ•°æ®ç»“æ„</span></a></h3><p>æ•´ä¸ª ConcurrentHashMap ç”±ä¸€ä¸ªä¸ª Segment ç»„æˆï¼ŒSegment ä»£è¡¨â€éƒ¨åˆ†â€œæˆ–â€ä¸€æ®µâ€œçš„æ„æ€ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹éƒ½ä¼šå°†å…¶æè¿°ä¸ºåˆ†æ®µé”ã€‚æ³¨æ„ï¼Œè¡Œæ–‡ä¸­ï¼Œæˆ‘å¾ˆå¤šåœ°æ–¹ç”¨äº†â€œæ§½â€æ¥ä»£è¡¨ä¸€ä¸ª segmentã€‚</p><p>ç®€å•ç†è§£å°±æ˜¯ï¼ŒConcurrentHashMap æ˜¯ä¸€ä¸ª Segment æ•°ç»„ï¼ŒSegment é€šè¿‡ç»§æ‰¿ ReentrantLock æ¥è¿›è¡ŒåŠ é”ï¼Œæ‰€ä»¥æ¯æ¬¡éœ€è¦åŠ é”çš„æ“ä½œé”ä½çš„æ˜¯ä¸€ä¸ª segmentï¼Œè¿™æ ·åªè¦ä¿è¯æ¯ä¸ª Segment æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¹Ÿå°±å®ç°äº†å…¨å±€çš„çº¿ç¨‹å®‰å…¨ã€‚</p><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-concurrent-hashmap-1.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><code>concurrencyLevel</code>: å¹¶è¡Œçº§åˆ«ã€å¹¶å‘æ•°ã€Segment æ•°ï¼Œæ€ä¹ˆç¿»è¯‘ä¸é‡è¦ï¼Œç†è§£å®ƒã€‚é»˜è®¤æ˜¯ 16ï¼Œä¹Ÿå°±æ˜¯è¯´ ConcurrentHashMap æœ‰ 16 ä¸ª Segmentsï¼Œæ‰€ä»¥ç†è®ºä¸Šï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæœ€å¤šå¯ä»¥åŒæ—¶æ”¯æŒ 16 ä¸ªçº¿ç¨‹å¹¶å‘å†™ï¼Œåªè¦å®ƒä»¬çš„æ“ä½œåˆ†åˆ«åˆ†å¸ƒåœ¨ä¸åŒçš„ Segment ä¸Šã€‚è¿™ä¸ªå€¼å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®ä¸ºå…¶ä»–å€¼ï¼Œä½†æ˜¯ä¸€æ—¦åˆå§‹åŒ–ä»¥åï¼Œå®ƒæ˜¯ä¸å¯ä»¥æ‰©å®¹çš„ã€‚</p><p>å†å…·ä½“åˆ°æ¯ä¸ª Segment å†…éƒ¨ï¼Œå…¶å®æ¯ä¸ª Segment å¾ˆåƒä¹‹å‰ä»‹ç»çš„ HashMapï¼Œä¸è¿‡å®ƒè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥å¤„ç†èµ·æ¥è¦éº»çƒ¦äº›ã€‚</p><h3 id="åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–"><span><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">#</a> åˆå§‹åŒ–</span></a></h3><ul><li>initialCapacity: åˆå§‹å®¹é‡ï¼Œè¿™ä¸ªå€¼æŒ‡çš„æ˜¯æ•´ä¸ª ConcurrentHashMap çš„åˆå§‹å®¹é‡ï¼Œå®é™…æ“ä½œçš„æ—¶å€™éœ€è¦å¹³å‡åˆ†ç»™æ¯ä¸ª Segmentã€‚</li><li>loadFactor: è´Ÿè½½å› å­ï¼Œä¹‹å‰æˆ‘ä»¬è¯´äº†ï¼ŒSegment æ•°ç»„ä¸å¯ä»¥æ‰©å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªè´Ÿè½½å› å­æ˜¯ç»™æ¯ä¸ª Segment å†…éƒ¨ä½¿ç”¨çš„ã€‚</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#61AFEF;"> ConcurrentHashMap</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> initialCapacity</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#C678DD;">                         float</span><span style="color:#E06C75;"> loadFactor</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">(loadFactor </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> initialCapacity </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> concurrencyLevel </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalArgumentException</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (concurrencyLevel </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> MAX_SEGMENTS)</span></span>
<span class="line"><span style="color:#E06C75;">        concurrencyLevel </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> MAX_SEGMENTS</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Find power-of-two sizes best matching arguments</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> sshift </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> ssize </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // è®¡ç®—å¹¶è¡Œçº§åˆ« ssizeï¼Œå› ä¸ºè¦ä¿æŒå¹¶è¡Œçº§åˆ«æ˜¯ 2 çš„ n æ¬¡æ–¹</span></span>
<span class="line"><span style="color:#C678DD;">    while</span><span style="color:#E06C75;"> (ssize </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;"> concurrencyLevel) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        ++</span><span style="color:#E06C75;">sshift</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        ssize </span><span style="color:#56B6C2;">&lt;&lt;=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // æˆ‘ä»¬è¿™é‡Œå…ˆä¸è¦é‚£ä¹ˆçƒ§è„‘ï¼Œç”¨é»˜è®¤å€¼ï¼ŒconcurrencyLevel ä¸º 16ï¼Œsshift ä¸º 4</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // é‚£ä¹ˆè®¡ç®—å‡º segmentShift ä¸º 28ï¼ŒsegmentMask ä¸º 15ï¼Œåé¢ä¼šç”¨åˆ°è¿™ä¸¤ä¸ªå€¼</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">segmentShift</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 32</span><span style="color:#56B6C2;"> -</span><span style="color:#E06C75;"> sshift</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">segmentMask</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ssize </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (initialCapacity </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#E06C75;">        initialCapacity </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> MAXIMUM_CAPACITY</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // initialCapacity æ˜¯è®¾ç½®æ•´ä¸ª map åˆå§‹çš„å¤§å°ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // è¿™é‡Œæ ¹æ® initialCapacity è®¡ç®— Segment æ•°ç»„ä¸­æ¯ä¸ªä½ç½®å¯ä»¥åˆ†åˆ°çš„å¤§å°</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // å¦‚ initialCapacity ä¸º 64ï¼Œé‚£ä¹ˆæ¯ä¸ª Segment æˆ–ç§°ä¹‹ä¸º&quot;æ§½&quot;å¯ä»¥åˆ†åˆ° 4 ä¸ª</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> initialCapacity </span><span style="color:#56B6C2;">/</span><span style="color:#E06C75;"> ssize</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> ssize </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;"> initialCapacity)</span></span>
<span class="line"><span style="color:#ABB2BF;">        ++</span><span style="color:#E06C75;">c</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // é»˜è®¤ MIN_SEGMENT_TABLE_CAPACITY æ˜¯ 2ï¼Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯æœ‰è®²ç©¶çš„ï¼Œå› ä¸ºè¿™æ ·çš„è¯ï¼Œå¯¹äºå…·ä½“çš„æ§½ä¸Šï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // æ’å…¥ä¸€ä¸ªå…ƒç´ ä¸è‡³äºæ‰©å®¹ï¼Œæ’å…¥ç¬¬äºŒä¸ªçš„æ—¶å€™æ‰ä¼šæ‰©å®¹</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> cap </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> MIN_SEGMENT_TABLE_CAPACITY</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> </span></span>
<span class="line"><span style="color:#C678DD;">    while</span><span style="color:#E06C75;"> (cap </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;"> c)</span></span>
<span class="line"><span style="color:#E06C75;">        cap </span><span style="color:#56B6C2;">&lt;&lt;=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // åˆ›å»º Segment æ•°ç»„ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // å¹¶åˆ›å»ºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  segment[0]</span></span>
<span class="line"><span style="color:#E5C07B;">    Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> s0 </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#C678DD;">        new</span><span style="color:#E5C07B;"> Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(loadFactor</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">)(cap </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> loadFactor)</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">                         (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[])</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> HashEntry</span><span style="color:#E06C75;">[cap])</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] ss </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Segment</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[])</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> Segment</span><span style="color:#E06C75;">[ssize]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // å¾€æ•°ç»„å†™å…¥ segment[0]</span></span>
<span class="line"><span style="color:#E5C07B;">    UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putOrderedObject</span><span style="color:#ABB2BF;">(ss, SBASE, s0);</span><span style="color:#7F848E;font-style:italic;"> // ordered write of segments[0]</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">segments</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ss</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆå§‹åŒ–å®Œæˆï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª Segment æ•°ç»„ã€‚</p><p>æˆ‘ä»¬å°±å½“æ˜¯ç”¨ new ConcurrentHashMap() æ— å‚æ„é€ å‡½æ•°è¿›è¡Œåˆå§‹åŒ–çš„ï¼Œé‚£ä¹ˆåˆå§‹åŒ–å®Œæˆå:</p><ul><li>Segment æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¸å¯ä»¥æ‰©å®¹</li><li>Segment[i] çš„é»˜è®¤å¤§å°ä¸º 2ï¼Œè´Ÿè½½å› å­æ˜¯ 0.75ï¼Œå¾—å‡ºåˆå§‹é˜ˆå€¼ä¸º 1.5ï¼Œä¹Ÿå°±æ˜¯ä»¥åæ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ä¼šè§¦å‘æ‰©å®¹ï¼Œæ’å…¥ç¬¬äºŒä¸ªä¼šè¿›è¡Œç¬¬ä¸€æ¬¡æ‰©å®¹</li><li>è¿™é‡Œåˆå§‹åŒ–äº† segment[0]ï¼Œå…¶ä»–ä½ç½®è¿˜æ˜¯ nullï¼Œè‡³äºä¸ºä»€ä¹ˆè¦åˆå§‹åŒ– segment[0]ï¼Œåé¢çš„ä»£ç ä¼šä»‹ç»</li><li>å½“å‰ segmentShift çš„å€¼ä¸º 32 - 4 = 28ï¼ŒsegmentMask ä¸º 16 - 1 = 15ï¼Œå§‘ä¸”æŠŠå®ƒä»¬ç®€å•ç¿»è¯‘ä¸ºç§»ä½æ•°å’Œæ©ç ï¼Œè¿™ä¸¤ä¸ªå€¼é©¬ä¸Šå°±ä¼šç”¨åˆ°</li></ul><h3 id="put-è¿‡ç¨‹åˆ†æ" tabindex="-1"><a class="header-anchor" href="#put-è¿‡ç¨‹åˆ†æ"><span><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">#</a> put è¿‡ç¨‹åˆ†æ</span></a></h3><p>æˆ‘ä»¬å…ˆçœ‹ put çš„ä¸»æµç¨‹ï¼Œå¯¹äºå…¶ä¸­çš„ä¸€äº›å…³é”®ç»†èŠ‚æ“ä½œï¼Œåé¢ä¼šè¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> put</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">K</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> V</span><span style="color:#E06C75;"> value) {</span></span>
<span class="line"><span style="color:#E5C07B;">    Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (value </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> NullPointerException</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 1. è®¡ç®— key çš„ hash å€¼</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> hash </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> hash</span><span style="color:#E06C75;">(key)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 2. æ ¹æ® hash å€¼æ‰¾åˆ° Segment æ•°ç»„ä¸­çš„ä½ç½® j</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //    hash æ˜¯ 32 ä½ï¼Œæ— ç¬¦å·å³ç§» segmentShift(28) ä½ï¼Œå‰©ä¸‹é«˜ 4 ä½ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //    ç„¶åå’Œ segmentMask(15) åšä¸€æ¬¡ä¸æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ j æ˜¯ hash å€¼çš„é«˜ 4 ä½ï¼Œä¹Ÿå°±æ˜¯æ§½çš„æ•°ç»„ä¸‹æ ‡</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> j </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (hash </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#E06C75;"> segmentShift) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> segmentMask</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // åˆšåˆšè¯´äº†ï¼Œåˆå§‹åŒ–çš„æ—¶å€™åˆå§‹åŒ–äº† segment[0]ï¼Œä½†æ˜¯å…¶ä»–ä½ç½®è¿˜æ˜¯ nullï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ensureSegment(j) å¯¹ segment[j] è¿›è¡Œåˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Segment</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)</span><span style="color:#E5C07B;">UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">getObject</span><span style="color:#7F848E;font-style:italic;">          // nonvolatile; recheck</span></span>
<span class="line"><span style="color:#E06C75;">         (segments</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> (j </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> SSHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> SBASE)) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) </span><span style="color:#7F848E;font-style:italic;">//  in ensureSegment</span></span>
<span class="line"><span style="color:#E06C75;">        s </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> ensureSegment</span><span style="color:#E06C75;">(j)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 3. æ’å…¥æ–°å€¼åˆ° æ§½ s ä¸­</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> s</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">put</span><span style="color:#ABB2BF;">(key, hash, value, </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ä¸€å±‚çš®å¾ˆç®€å•ï¼Œæ ¹æ® hash å€¼å¾ˆå¿«å°±èƒ½æ‰¾åˆ°ç›¸åº”çš„ Segmentï¼Œä¹‹åå°±æ˜¯ Segment å†…éƒ¨çš„ put æ“ä½œäº†ã€‚</p><p>Segment å†…éƒ¨æ˜¯ç”± <code>æ•°ç»„+é“¾è¡¨</code> ç»„æˆçš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> put</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">K</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> V</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> boolean</span><span style="color:#E06C75;"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // åœ¨å¾€è¯¥ segment å†™å…¥å‰ï¼Œéœ€è¦å…ˆè·å–è¯¥ segment çš„ç‹¬å é”</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //    å…ˆçœ‹ä¸»æµç¨‹ï¼Œåé¢è¿˜ä¼šå…·ä½“ä»‹ç»è¿™éƒ¨åˆ†å†…å®¹</span></span>
<span class="line"><span style="color:#E5C07B;">    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> node </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> tryLock</span><span style="color:#E06C75;">() </span><span style="color:#C678DD;">?</span><span style="color:#D19A66;"> null</span><span style="color:#C678DD;"> :</span></span>
<span class="line"><span style="color:#61AFEF;">        scanAndLockForPut</span><span style="color:#E06C75;">(key</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> value)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    V</span><span style="color:#E06C75;"> oldValue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // è¿™ä¸ªæ˜¯ segment å†…éƒ¨çš„æ•°ç»„</span></span>
<span class="line"><span style="color:#E5C07B;">        HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> table</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // å†åˆ©ç”¨ hash å€¼ï¼Œæ±‚åº”è¯¥æ”¾ç½®çš„æ•°ç»„ä¸‹æ ‡</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> index </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> hash</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // first æ˜¯æ•°ç»„è¯¥ä½ç½®å¤„çš„é“¾è¡¨çš„è¡¨å¤´</span></span>
<span class="line"><span style="color:#E5C07B;">        HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> first </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> entryAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> index)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // ä¸‹é¢è¿™ä¸² for å¾ªç¯è™½ç„¶å¾ˆé•¿ï¼Œä¸è¿‡ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæƒ³æƒ³è¯¥ä½ç½®æ²¡æœ‰ä»»ä½•å…ƒç´ å’Œå·²ç»å­˜åœ¨ä¸€ä¸ªé“¾è¡¨è¿™ä¸¤ç§æƒ…å†µ</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> first</span><span style="color:#ABB2BF;">;;</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (e </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                K</span><span style="color:#E06C75;"> k</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((k </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> key </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#E06C75;">                    (</span><span style="color:#E5C07B;">e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> hash </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E5C07B;"> key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(k)</span><span style="color:#E06C75;">)) {</span></span>
<span class="line"><span style="color:#E06C75;">                    oldValue </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // è¦†ç›–æ—§å€¼</span></span>
<span class="line"><span style="color:#E5C07B;">                        e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">value</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                        ++</span><span style="color:#E06C75;">modCount</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // ç»§ç»­é¡ºç€é“¾è¡¨èµ°</span></span>
<span class="line"><span style="color:#E06C75;">                e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // node åˆ°åº•æ˜¯ä¸æ˜¯ nullï¼Œè¿™ä¸ªè¦çœ‹è·å–é”çš„è¿‡ç¨‹ï¼Œä¸è¿‡å’Œè¿™é‡Œéƒ½æ²¡æœ‰å…³ç³»ã€‚</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // å¦‚æœä¸ä¸º nullï¼Œé‚£å°±ç›´æ¥å°†å®ƒè®¾ç½®ä¸ºé“¾è¡¨è¡¨å¤´ï¼›å¦‚æœæ˜¯nullï¼Œåˆå§‹åŒ–å¹¶è®¾ç½®ä¸ºé“¾è¡¨è¡¨å¤´ã€‚</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (node </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                    node</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setNext</span><span style="color:#ABB2BF;">(first);</span></span>
<span class="line"><span style="color:#C678DD;">                else</span></span>
<span class="line"><span style="color:#E06C75;">                    node </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> first)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">                int</span><span style="color:#E06C75;"> c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> count </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // å¦‚æœè¶…è¿‡äº†è¯¥ segment çš„é˜ˆå€¼ï¼Œè¿™ä¸ª segment éœ€è¦æ‰©å®¹</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> threshold </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E06C75;"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#61AFEF;">                    rehash</span><span style="color:#E06C75;">(node)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // æ‰©å®¹åé¢ä¹Ÿä¼šå…·ä½“åˆ†æ</span></span>
<span class="line"><span style="color:#C678DD;">                else</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // æ²¡æœ‰è¾¾åˆ°é˜ˆå€¼ï¼Œå°† node æ”¾åˆ°æ•°ç»„ tab çš„ index ä½ç½®ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å…¶å®å°±æ˜¯å°†æ–°çš„èŠ‚ç‚¹è®¾ç½®æˆåŸé“¾è¡¨çš„è¡¨å¤´</span></span>
<span class="line"><span style="color:#61AFEF;">                    setEntryAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> index</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> node)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                ++</span><span style="color:#E06C75;">modCount</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                count </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                oldValue </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // è§£é”</span></span>
<span class="line"><span style="color:#61AFEF;">        unlock</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> oldValue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•´ä½“æµç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç”±äºæœ‰ç‹¬å é”çš„ä¿æŠ¤ï¼Œæ‰€ä»¥ segment å†…éƒ¨çš„æ“ä½œå¹¶ä¸å¤æ‚ã€‚è‡³äºè¿™é‡Œé¢çš„å¹¶å‘é—®é¢˜ï¼Œæˆ‘ä»¬ç¨åå†è¿›è¡Œä»‹ç»ã€‚</p><p>åˆ°è¿™é‡Œ put æ“ä½œå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¯´ä¸€è¯´å…¶ä¸­å‡ æ­¥å…³é”®çš„æ“ä½œã€‚</p><h3 id="åˆå§‹åŒ–æ§½-ensuresegment" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–æ§½-ensuresegment"><span><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A7%BD-ensuresegment">#</a> åˆå§‹åŒ–æ§½: ensureSegment</span></a></h3><p>ConcurrentHashMap åˆå§‹åŒ–çš„æ—¶å€™ä¼šåˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ§½ segment[0]ï¼Œå¯¹äºå…¶ä»–æ§½æ¥è¯´ï¼Œåœ¨æ’å…¥ç¬¬ä¸€ä¸ªå€¼çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>è¿™é‡Œéœ€è¦è€ƒè™‘å¹¶å‘ï¼Œå› ä¸ºå¾ˆå¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›æ¥åˆå§‹åŒ–åŒä¸€ä¸ªæ§½ segment[k]ï¼Œä¸è¿‡åªè¦æœ‰ä¸€ä¸ªæˆåŠŸäº†å°±å¯ä»¥ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> Segment</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> ensureSegment</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> k) {</span></span>
<span class="line"><span style="color:#C678DD;">    final</span><span style="color:#E5C07B;"> Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] ss </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">segments</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> u </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (k </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> SSHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> SBASE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // raw offset</span></span>
<span class="line"><span style="color:#E5C07B;">    Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> seg</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((seg </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Segment</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)</span><span style="color:#E5C07B;">UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObjectVolatile</span><span style="color:#ABB2BF;">(ss, u)</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // è¿™é‡Œçœ‹åˆ°ä¸ºä»€ä¹ˆä¹‹å‰è¦åˆå§‹åŒ– segment[0] äº†ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // ä½¿ç”¨å½“å‰ segment[0] å¤„çš„æ•°ç»„é•¿åº¦å’Œè´Ÿè½½å› å­æ¥åˆå§‹åŒ– segment[k]</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // ä¸ºä»€ä¹ˆè¦ç”¨â€œå½“å‰â€ï¼Œå› ä¸º segment[0] å¯èƒ½æ—©å°±æ‰©å®¹è¿‡äº†</span></span>
<span class="line"><span style="color:#E5C07B;">        Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> proto </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ss[</span><span style="color:#D19A66;">0</span><span style="color:#E06C75;">]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> cap </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> proto</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">table</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        float</span><span style="color:#E06C75;"> lf </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> proto</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">loadFactor</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        int</span><span style="color:#E06C75;"> threshold </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">)(cap </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> lf)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // åˆå§‹åŒ– segment[k] å†…éƒ¨çš„æ•°ç»„</span></span>
<span class="line"><span style="color:#E5C07B;">        HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[])</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> HashEntry</span><span style="color:#E06C75;">[cap]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((seg </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Segment</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)</span><span style="color:#E5C07B;">UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObjectVolatile</span><span style="color:#ABB2BF;">(ss, u)</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#56B6C2;">            ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) { </span><span style="color:#7F848E;font-style:italic;">// å†æ¬¡æ£€æŸ¥ä¸€éè¯¥æ§½æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–äº†ã€‚</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">            Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> s </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(lf</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> threshold</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> tab)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // ä½¿ç”¨ while å¾ªç¯ï¼Œå†…éƒ¨ç”¨ CASï¼Œå½“å‰çº¿ç¨‹æˆåŠŸè®¾å€¼æˆ–å…¶ä»–çº¿ç¨‹æˆåŠŸè®¾å€¼åï¼Œé€€å‡º</span></span>
<span class="line"><span style="color:#C678DD;">            while</span><span style="color:#E06C75;"> ((seg </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Segment</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)</span><span style="color:#E5C07B;">UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObjectVolatile</span><span style="color:#ABB2BF;">(ss, u)</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#56B6C2;">                   ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapObject</span><span style="color:#ABB2BF;">(ss, u, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">, seg </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> s)</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> seg</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»çš„æ¥è¯´ï¼ŒensureSegment(int k) æ¯”è¾ƒç®€å•ï¼Œå¯¹äºå¹¶å‘æ“ä½œä½¿ç”¨ CAS è¿›è¡Œæ§åˆ¶ã€‚</p><h3 id="è·å–å†™å…¥é”-scanandlockforput" tabindex="-1"><a class="header-anchor" href="#è·å–å†™å…¥é”-scanandlockforput"><span><a href="#%E8%8E%B7%E5%8F%96%E5%86%99%E5%85%A5%E9%94%81-scanandlockforput">#</a> è·å–å†™å…¥é”: scanAndLockForPut</span></a></h3><p>å‰é¢æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å¾€æŸä¸ª segment ä¸­ put çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨ node = tryLock() ? null : scanAndLockForPut(key, hash, value)ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆè¿›è¡Œä¸€æ¬¡ tryLock() å¿«é€Ÿè·å–è¯¥ segment çš„ç‹¬å é”ï¼Œå¦‚æœå¤±è´¥ï¼Œé‚£ä¹ˆè¿›å…¥åˆ° scanAndLockForPut è¿™ä¸ªæ–¹æ³•æ¥è·å–é”ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“åˆ†æè¿™ä¸ªæ–¹æ³•ä¸­æ˜¯æ€ä¹ˆæ§åˆ¶åŠ é”çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> HashEntry</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> scanAndLockForPut</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">K</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> V</span><span style="color:#E06C75;"> value) {</span></span>
<span class="line"><span style="color:#E5C07B;">    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> first </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> entryForHash</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hash)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> first</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> node </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> retries </span><span style="color:#56B6C2;">=</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // negative while locating node</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // å¾ªç¯è·å–é”</span></span>
<span class="line"><span style="color:#C678DD;">    while</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">tryLock</span><span style="color:#E06C75;">()) {</span></span>
<span class="line"><span style="color:#E5C07B;">        HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> f</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // to recheck first below</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (retries </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (e </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (node </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) </span><span style="color:#7F848E;font-style:italic;">// speculatively create node</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // è¿›åˆ°è¿™é‡Œè¯´æ˜æ•°ç»„è¯¥ä½ç½®çš„é“¾è¡¨æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰ä»»ä½•å…ƒç´ </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å½“ç„¶ï¼Œè¿›åˆ°è¿™é‡Œçš„å¦ä¸€ä¸ªåŸå› æ˜¯ tryLock() å¤±è´¥ï¼Œæ‰€ä»¥è¯¥æ§½å­˜åœ¨å¹¶å‘ï¼Œä¸ä¸€å®šæ˜¯è¯¥ä½ç½®</span></span>
<span class="line"><span style="color:#E06C75;">                    node </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                retries </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                retries </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            else</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // é¡ºç€é“¾è¡¨å¾€ä¸‹èµ°</span></span>
<span class="line"><span style="color:#E06C75;">                e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // é‡è¯•æ¬¡æ•°å¦‚æœè¶…è¿‡ MAX_SCAN_RETRIES(å•æ ¸1å¤šæ ¸64)ï¼Œé‚£ä¹ˆä¸æŠ¢äº†ï¼Œè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ç­‰å¾…é”</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //    lock() æ˜¯é˜»å¡æ–¹æ³•ï¼Œç›´åˆ°è·å–é”åè¿”å›</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">++</span><span style="color:#E06C75;">retries </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> MAX_SCAN_RETRIES) {</span></span>
<span class="line"><span style="color:#61AFEF;">            lock</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((retries </span><span style="color:#56B6C2;">&amp;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                 // è¿™ä¸ªæ—¶å€™æ˜¯æœ‰å¤§é—®é¢˜äº†ï¼Œé‚£å°±æ˜¯æœ‰æ–°çš„å…ƒç´ è¿›åˆ°äº†é“¾è¡¨ï¼Œæˆä¸ºäº†æ–°çš„è¡¨å¤´</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                 //     æ‰€ä»¥è¿™è¾¹çš„ç­–ç•¥æ˜¯ï¼Œç›¸å½“äºé‡æ–°èµ°ä¸€éè¿™ä¸ª scanAndLockForPut æ–¹æ³•</span></span>
<span class="line"><span style="color:#E06C75;">                 (f </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> entryForHash</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hash)) </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> first) {</span></span>
<span class="line"><span style="color:#E06C75;">            e </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> first </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> f</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // re-traverse if entry changed</span></span>
<span class="line"><span style="color:#E06C75;">            retries </span><span style="color:#56B6C2;">=</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> node</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªå‡ºå£ï¼Œä¸€ä¸ªæ˜¯ tryLock() æˆåŠŸäº†ï¼Œå¾ªç¯ç»ˆæ­¢ï¼Œå¦ä¸€ä¸ªå°±æ˜¯é‡è¯•æ¬¡æ•°è¶…è¿‡äº† MAX_SCAN_RETRIESï¼Œè¿›åˆ° lock() æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æˆåŠŸæ‹¿åˆ°ç‹¬å é”ã€‚</p><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯çœ‹ä¼¼å¤æ‚ï¼Œä½†æ˜¯å…¶å®å°±æ˜¯åšäº†ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯è·å–è¯¥ segment çš„ç‹¬å é”ï¼Œå¦‚æœéœ€è¦çš„è¯é¡ºä¾¿å®ä¾‹åŒ–äº†ä¸€ä¸‹ nodeã€‚</p><h3 id="æ‰©å®¹-rehash" tabindex="-1"><a class="header-anchor" href="#æ‰©å®¹-rehash"><span><a href="#%E6%89%A9%E5%AE%B9-rehash">#</a> æ‰©å®¹: rehash</span></a></h3><p>é‡å¤ä¸€ä¸‹ï¼Œsegment æ•°ç»„ä¸èƒ½æ‰©å®¹ï¼Œæ‰©å®¹æ˜¯ segment æ•°ç»„æŸä¸ªä½ç½®å†…éƒ¨çš„æ•°ç»„ HashEntry&lt;K,V&gt;[] è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹åï¼Œå®¹é‡ä¸ºåŸæ¥çš„ 2 å€ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å›é¡¾ä¸€ä¸‹è§¦å‘æ‰©å®¹çš„åœ°æ–¹ï¼Œput çš„æ—¶å€™ï¼Œå¦‚æœåˆ¤æ–­è¯¥å€¼çš„æ’å…¥ä¼šå¯¼è‡´è¯¥ segment çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡é˜ˆå€¼ï¼Œé‚£ä¹ˆå…ˆè¿›è¡Œæ‰©å®¹ï¼Œå†æ’å€¼ï¼Œè¯»è€…è¿™ä¸ªæ—¶å€™å¯ä»¥å›å» put æ–¹æ³•çœ‹ä¸€çœ¼ã€‚</p><p>è¯¥æ–¹æ³•ä¸éœ€è¦è€ƒè™‘å¹¶å‘ï¼Œå› ä¸ºåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ˜¯æŒæœ‰è¯¥ segment çš„ç‹¬å é”çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// æ–¹æ³•å‚æ•°ä¸Šçš„ node æ˜¯è¿™æ¬¡æ‰©å®¹åï¼Œéœ€è¦æ·»åŠ åˆ°æ–°çš„æ•°ç»„ä¸­çš„æ•°æ®ã€‚</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> rehash</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> node) {</span></span>
<span class="line"><span style="color:#E5C07B;">    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] oldTable </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> table</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> oldCapacity </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> oldTable</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 2 å€</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> newCapacity </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> oldCapacity </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    threshold </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;">)(newCapacity </span><span style="color:#56B6C2;">*</span><span style="color:#E06C75;"> loadFactor)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // åˆ›å»ºæ–°æ•°ç»„</span></span>
<span class="line"><span style="color:#E5C07B;">    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] newTable </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#E06C75;">        (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[]) </span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> HashEntry</span><span style="color:#E06C75;">[newCapacity]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // æ–°çš„æ©ç ï¼Œå¦‚ä» 16 æ‰©å®¹åˆ° 32ï¼Œé‚£ä¹ˆ sizeMask ä¸º 31ï¼Œå¯¹åº”äºŒè¿›åˆ¶ â€˜000...00011111â€™</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> sizeMask </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> newCapacity </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // éå†åŸæ•°ç»„ï¼Œè€å¥—è·¯ï¼Œå°†åŸæ•°ç»„ä½ç½® i å¤„çš„é“¾è¡¨æ‹†åˆ†åˆ° æ–°æ•°ç»„ä½ç½® i å’Œ i+oldCap ä¸¤ä¸ªä½ç½®</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;"> oldCapacity </span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">++</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // e æ˜¯é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span>
<span class="line"><span style="color:#E5C07B;">        HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> oldTable[i]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (e </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> next </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // è®¡ç®—åº”è¯¥æ”¾ç½®åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // å‡è®¾åŸæ•°ç»„é•¿åº¦ä¸º 16ï¼Œe åœ¨ oldTable[3] å¤„ï¼Œé‚£ä¹ˆ idx åªå¯èƒ½æ˜¯ 3 æˆ–è€…æ˜¯ 3 + 16 = 19</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> idx </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;"> sizeMask</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (next </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)   </span><span style="color:#7F848E;font-style:italic;">// è¯¥ä½ç½®å¤„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œé‚£æ¯”è¾ƒå¥½åŠ</span></span>
<span class="line"><span style="color:#E06C75;">                newTable[idx] </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> e</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#E06C75;"> { </span><span style="color:#7F848E;font-style:italic;">// Reuse consecutive sequence at same slot</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // e æ˜¯é“¾è¡¨è¡¨å¤´</span></span>
<span class="line"><span style="color:#E5C07B;">                HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> lastRun </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> e</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // idx æ˜¯å½“å‰é“¾è¡¨çš„å¤´èŠ‚ç‚¹ e çš„æ–°ä½ç½®</span></span>
<span class="line"><span style="color:#C678DD;">                int</span><span style="color:#E06C75;"> lastIdx </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> idx</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // ä¸‹é¢è¿™ä¸ª for å¾ªç¯ä¼šæ‰¾åˆ°ä¸€ä¸ª lastRun èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¹‹åçš„æ‰€æœ‰å…ƒç´ æ˜¯å°†è¦æ”¾åˆ°ä¸€èµ·çš„</span></span>
<span class="line"><span style="color:#C678DD;">                for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> last </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> next</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                     last </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                     last </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> last</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> last</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;"> sizeMask</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (k </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> lastIdx) {</span></span>
<span class="line"><span style="color:#E06C75;">                        lastIdx </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> k</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        lastRun </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> last</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // å°† lastRun åŠå…¶ä¹‹åçš„æ‰€æœ‰èŠ‚ç‚¹ç»„æˆçš„è¿™ä¸ªé“¾è¡¨æ”¾åˆ° lastIdx è¿™ä¸ªä½ç½®</span></span>
<span class="line"><span style="color:#E06C75;">                newTable[lastIdx] </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> lastRun</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // ä¸‹é¢çš„æ“ä½œæ˜¯å¤„ç† lastRun ä¹‹å‰çš„èŠ‚ç‚¹ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //    è¿™äº›èŠ‚ç‚¹å¯èƒ½åˆ†é…åœ¨å¦ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œä¹Ÿå¯èƒ½åˆ†é…åˆ°ä¸Šé¢çš„é‚£ä¸ªé“¾è¡¨ä¸­</span></span>
<span class="line"><span style="color:#C678DD;">                for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> e</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> lastRun</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                    V</span><span style="color:#E06C75;"> v </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> k </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> sizeMask</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> newTable[k]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    newTable[k] </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(h</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> n)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // å°†æ–°æ¥çš„ node æ”¾åˆ°æ–°æ•°ç»„ä¸­åˆšåˆšçš„ ä¸¤ä¸ªé“¾è¡¨ä¹‹ä¸€ çš„ å¤´éƒ¨</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> nodeIndex </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> node</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;"> sizeMask</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // add the new node</span></span>
<span class="line"><span style="color:#E5C07B;">    node</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setNext</span><span style="color:#ABB2BF;">(newTable[nodeIndex]);</span></span>
<span class="line"><span style="color:#E06C75;">    newTable[nodeIndex] </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> node</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    table </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> newTable</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œçš„æ‰©å®¹æ¯”ä¹‹å‰çš„ HashMap è¦å¤æ‚ä¸€äº›ï¼Œä»£ç éš¾æ‡‚ä¸€ç‚¹ã€‚ä¸Šé¢æœ‰ä¸¤ä¸ªæŒ¨ç€çš„ for å¾ªç¯ï¼Œç¬¬ä¸€ä¸ª for æœ‰ä»€ä¹ˆç”¨å‘¢?</p><p>ä»”ç»†ä¸€çœ‹å‘ç°ï¼Œå¦‚æœæ²¡æœ‰ç¬¬ä¸€ä¸ª for å¾ªç¯ï¼Œä¹Ÿæ˜¯å¯ä»¥å·¥ä½œçš„ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ª for å¾ªç¯ä¸‹æ¥ï¼Œå¦‚æœ lastRun çš„åé¢è¿˜æœ‰æ¯”è¾ƒå¤šçš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™æ¬¡å°±æ˜¯å€¼å¾—çš„ã€‚å› ä¸ºæˆ‘ä»¬åªéœ€è¦å…‹éš† lastRun å‰é¢çš„èŠ‚ç‚¹ï¼Œåé¢çš„ä¸€ä¸²èŠ‚ç‚¹è·Ÿç€ lastRun èµ°å°±æ˜¯äº†ï¼Œä¸éœ€è¦åšä»»ä½•æ“ä½œã€‚</p><p>æˆ‘è§‰å¾— Doug Lea çš„è¿™ä¸ªæƒ³æ³•ä¹Ÿæ˜¯æŒºæœ‰æ„æ€çš„ï¼Œä¸è¿‡æ¯”è¾ƒåçš„æƒ…å†µå°±æ˜¯æ¯æ¬¡ lastRun éƒ½æ˜¯é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ æˆ–è€…å¾ˆé åçš„å…ƒç´ ï¼Œé‚£ä¹ˆè¿™æ¬¡éå†å°±æœ‰ç‚¹æµªè´¹äº†ã€‚ä¸è¿‡ Doug Lea ä¹Ÿè¯´äº†ï¼Œæ ¹æ®ç»Ÿè®¡ï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„é˜ˆå€¼ï¼Œå¤§çº¦åªæœ‰ 1/6 çš„èŠ‚ç‚¹éœ€è¦å…‹éš†ã€‚</p><h3 id="get-è¿‡ç¨‹åˆ†æ" tabindex="-1"><a class="header-anchor" href="#get-è¿‡ç¨‹åˆ†æ"><span><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">#</a> get è¿‡ç¨‹åˆ†æ</span></a></h3><p>ç›¸å¯¹äº put æ¥è¯´ï¼Œget å°±å¾ˆç®€å•äº†ã€‚</p><ul><li>è®¡ç®— hash å€¼ï¼Œæ‰¾åˆ° segment æ•°ç»„ä¸­çš„å…·ä½“ä½ç½®ï¼Œæˆ–æˆ‘ä»¬å‰é¢ç”¨çš„â€œæ§½â€</li><li>æ§½ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ ¹æ® hash æ‰¾åˆ°æ•°ç»„ä¸­å…·ä½“çš„ä½ç½®</li><li>åˆ°è¿™é‡Œæ˜¯é“¾è¡¨äº†ï¼Œé¡ºç€é“¾è¡¨è¿›è¡ŒæŸ¥æ‰¾å³å¯</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> get</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Object</span><span style="color:#E06C75;"> key) {</span></span>
<span class="line"><span style="color:#E5C07B;">    Segment</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // manually integrate access methods to reduce overhead</span></span>
<span class="line"><span style="color:#E5C07B;">    HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] tab</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 1. hash å€¼</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> hash</span><span style="color:#E06C75;">(key)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> u </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (((h </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#E06C75;"> segmentShift) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> segmentMask) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> SSHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> SBASE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 2. æ ¹æ® hash æ‰¾åˆ°å¯¹åº”çš„ segment</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((s </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Segment</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)</span><span style="color:#E5C07B;">UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getObjectVolatile</span><span style="color:#ABB2BF;">(segments, u)</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">        (tab </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> s</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">table</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 3. æ‰¾åˆ°segment å†…éƒ¨æ•°ç»„ç›¸åº”ä½ç½®çš„é“¾è¡¨ï¼Œéå†</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">HashEntry</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">) </span><span style="color:#E5C07B;">UNSAFE</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">getObjectVolatile</span></span>
<span class="line"><span style="color:#E06C75;">                 (tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ((</span><span style="color:#C678DD;">long</span><span style="color:#E06C75;">)(((</span><span style="color:#E5C07B;">tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> h)) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> TSHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> TBASE)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">             e </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            K</span><span style="color:#E06C75;"> k</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((k </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> key </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#E5C07B;"> key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(k)</span><span style="color:#E06C75;">))</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¹¶å‘é—®é¢˜åˆ†æ" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘é—®é¢˜åˆ†æ"><span><a href="#%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">#</a> å¹¶å‘é—®é¢˜åˆ†æ</span></a></h3><p>ç°åœ¨æˆ‘ä»¬å·²ç»è¯´å®Œäº† put è¿‡ç¨‹å’Œ get è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° get è¿‡ç¨‹ä¸­æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œé‚£è‡ªç„¶æˆ‘ä»¬å°±éœ€è¦å»è€ƒè™‘å¹¶å‘é—®é¢˜ã€‚</p><p>æ·»åŠ èŠ‚ç‚¹çš„æ“ä½œ put å’Œåˆ é™¤èŠ‚ç‚¹çš„æ“ä½œ remove éƒ½æ˜¯è¦åŠ  segment ä¸Šçš„ç‹¬å é”çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¹‹é—´è‡ªç„¶ä¸ä¼šæœ‰é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é—®é¢˜å°±æ˜¯ get çš„æ—¶å€™åœ¨åŒä¸€ä¸ª segment ä¸­å‘ç”Ÿäº† put æˆ– remove æ“ä½œã€‚</p><ul><li>put æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚ <ul><li>åˆå§‹åŒ–æ§½ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰å°±è¯´è¿‡äº†ï¼Œä½¿ç”¨äº† CAS æ¥åˆå§‹åŒ– Segment ä¸­çš„æ•°ç»„ã€‚</li><li>æ·»åŠ èŠ‚ç‚¹åˆ°é“¾è¡¨çš„æ“ä½œæ˜¯æ’å…¥åˆ°è¡¨å¤´çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ get æ“ä½œåœ¨é“¾è¡¨éå†çš„è¿‡ç¨‹å·²ç»åˆ°äº†ä¸­é—´ï¼Œæ˜¯ä¸ä¼šå½±å“çš„ã€‚å½“ç„¶ï¼Œå¦ä¸€ä¸ªå¹¶å‘é—®é¢˜å°±æ˜¯ get æ“ä½œåœ¨ put ä¹‹åï¼Œéœ€è¦ä¿è¯åˆšåˆšæ’å…¥è¡¨å¤´çš„èŠ‚ç‚¹è¢«è¯»å–ï¼Œè¿™ä¸ªä¾èµ–äº setEntryAt æ–¹æ³•ä¸­ä½¿ç”¨çš„ UNSAFE.putOrderedObjectã€‚</li><li>æ‰©å®¹ã€‚æ‰©å®¹æ˜¯æ–°åˆ›å»ºäº†æ•°ç»„ï¼Œç„¶åè¿›è¡Œè¿ç§»æ•°æ®ï¼Œæœ€åé¢å°† newTable è®¾ç½®ç»™å±æ€§ tableã€‚æ‰€ä»¥ï¼Œå¦‚æœ get æ“ä½œæ­¤æ—¶ä¹Ÿåœ¨è¿›è¡Œï¼Œé‚£ä¹ˆä¹Ÿæ²¡å…³ç³»ï¼Œå¦‚æœ get å…ˆè¡Œï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨æ—§çš„ table ä¸ŠåšæŸ¥è¯¢æ“ä½œï¼›è€Œ put å…ˆè¡Œï¼Œé‚£ä¹ˆ put æ“ä½œçš„å¯è§æ€§ä¿è¯å°±æ˜¯ table ä½¿ç”¨äº† volatile å…³é”®å­—ã€‚</li></ul></li><li>remove æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚ <ul><li>remove æ“ä½œæˆ‘ä»¬æ²¡æœ‰åˆ†ææºç ï¼Œæ‰€ä»¥è¿™é‡Œè¯´çš„è¯»è€…æ„Ÿå…´è¶£çš„è¯è¿˜æ˜¯éœ€è¦åˆ°æºç ä¸­å»æ±‚å®ä¸€ä¸‹çš„ã€‚</li><li>get æ“ä½œéœ€è¦éå†é“¾è¡¨ï¼Œä½†æ˜¯ remove æ“ä½œä¼š&quot;ç ´å&quot;é“¾è¡¨ã€‚</li><li>å¦‚æœ remove ç ´åçš„èŠ‚ç‚¹ get æ“ä½œå·²ç»è¿‡å»äº†ï¼Œé‚£ä¹ˆè¿™é‡Œä¸å­˜åœ¨ä»»ä½•é—®é¢˜ã€‚</li><li>å¦‚æœ remove å…ˆç ´åäº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ†ä¸¤ç§æƒ…å†µè€ƒè™‘ã€‚ 1ã€å¦‚æœæ­¤èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œé‚£ä¹ˆéœ€è¦å°†å¤´èŠ‚ç‚¹çš„ next è®¾ç½®ä¸ºæ•°ç»„è¯¥ä½ç½®çš„å…ƒç´ ï¼Œtable è™½ç„¶ä½¿ç”¨äº† volatile ä¿®é¥°ï¼Œä½†æ˜¯ volatile å¹¶ä¸èƒ½æä¾›æ•°ç»„å†…éƒ¨æ“ä½œçš„å¯è§æ€§ä¿è¯ï¼Œæ‰€ä»¥æºç ä¸­ä½¿ç”¨äº† UNSAFE æ¥æ“ä½œæ•°ç»„ï¼Œè¯·çœ‹æ–¹æ³• setEntryAtã€‚2ã€å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œå®ƒä¼šå°†è¦åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ¥åˆ°å‰é©±èŠ‚ç‚¹ä¸­ï¼Œè¿™é‡Œçš„å¹¶å‘ä¿è¯å°±æ˜¯ next å±æ€§æ˜¯ volatile çš„ã€‚</li></ul></li></ul><h2 id="concurrenthashmap-jdk-1-8" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-jdk-1-8"><span><a href="#concurrenthashmap-jdk-1-8">#</a> ConcurrentHashMap - JDK 1.8</span></a></h2><p>åœ¨JDK1.7ä¹‹å‰ï¼ŒConcurrentHashMapæ˜¯é€šè¿‡åˆ†æ®µé”æœºåˆ¶æ¥å®ç°çš„ï¼Œæ‰€ä»¥å…¶æœ€å¤§å¹¶å‘åº¦å—Segmentçš„ä¸ªæ•°é™åˆ¶ã€‚å› æ­¤ï¼Œåœ¨JDK1.8ä¸­ï¼ŒConcurrentHashMapçš„å®ç°åŸç†æ‘’å¼ƒäº†è¿™ç§è®¾è®¡ï¼Œè€Œæ˜¯é€‰æ‹©äº†ä¸HashMapç±»ä¼¼çš„æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ–¹å¼å®ç°ï¼Œè€ŒåŠ é”åˆ™é‡‡ç”¨CASå’Œsynchronizedå®ç°ã€‚</p><h3 id="æ•°æ®ç»“æ„-1" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„-1"><span><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1">#</a> æ•°æ®ç»“æ„</span></a></h3><figure><img src="https://lixuanfengs.github.io/blog-images/vp/Java/java-thread-x-concurrent-hashmap-2.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ç»“æ„ä¸Šå’Œ Java8 çš„ HashMap åŸºæœ¬ä¸Šä¸€æ ·ï¼Œä¸è¿‡å®ƒè¦ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œæ‰€ä»¥åœ¨æºç ä¸Šç¡®å®è¦å¤æ‚ä¸€äº›ã€‚</p><h3 id="åˆå§‹åŒ–-1" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–-1"><span><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1">#</a> åˆå§‹åŒ–</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// è¿™æ„é€ å‡½æ•°é‡Œï¼Œä»€ä¹ˆéƒ½ä¸å¹²</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#61AFEF;"> ConcurrentHashMap</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#61AFEF;"> ConcurrentHashMap</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> initialCapacity) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (initialCapacity </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalArgumentException</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> cap </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((initialCapacity </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> (MAXIMUM_CAPACITY </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)) </span><span style="color:#C678DD;">?</span></span>
<span class="line"><span style="color:#E06C75;">               MAXIMUM_CAPACITY </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#61AFEF;">               tableSizeFor</span><span style="color:#E06C75;">(initialCapacity </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> (initialCapacity </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">sizeCtl</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> cap</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•æœ‰ç‚¹æ„æ€ï¼Œé€šè¿‡æä¾›åˆå§‹å®¹é‡ï¼Œè®¡ç®—äº† sizeCtlï¼ŒsizeCtl = ã€ (1.5 * initialCapacity + 1)ï¼Œç„¶åå‘ä¸Šå–æœ€è¿‘çš„ 2 çš„ n æ¬¡æ–¹ã€‘ã€‚å¦‚ initialCapacity ä¸º 10ï¼Œé‚£ä¹ˆå¾—åˆ° sizeCtl ä¸º 16ï¼Œå¦‚æœ initialCapacity ä¸º 11ï¼Œå¾—åˆ° sizeCtl ä¸º 32ã€‚</p><p>sizeCtl è¿™ä¸ªå±æ€§ä½¿ç”¨çš„åœºæ™¯å¾ˆå¤šï¼Œä¸è¿‡åªè¦è·Ÿç€æ–‡ç« çš„æ€è·¯æ¥ï¼Œå°±ä¸ä¼šè¢«å®ƒææ™•äº†ã€‚</p><h3 id="put-è¿‡ç¨‹åˆ†æ-1" tabindex="-1"><a class="header-anchor" href="#put-è¿‡ç¨‹åˆ†æ-1"><span><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-1">#</a> put è¿‡ç¨‹åˆ†æ</span></a></h3><p>ä»”ç»†åœ°ä¸€è¡Œä¸€è¡Œä»£ç çœ‹ä¸‹å»:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> put</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">K</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> V</span><span style="color:#E06C75;"> value) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#61AFEF;"> putVal</span><span style="color:#E06C75;">(key</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#C678DD;">final</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> putVal</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">K</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> V</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> boolean</span><span style="color:#E06C75;"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (key </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> value </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> NullPointerException</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // å¾—åˆ° hash å€¼</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> hash </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> spread</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">hashCode</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ç”¨äºè®°å½•ç›¸åº”é“¾è¡¨çš„é•¿åº¦</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> binCount </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> table</span><span style="color:#ABB2BF;">;;</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> f</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> fh</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // å¦‚æœæ•°ç»„&quot;ç©º&quot;ï¼Œè¿›è¡Œæ•°ç»„åˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (tab </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // åˆå§‹åŒ–æ•°ç»„ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»</span></span>
<span class="line"><span style="color:#E06C75;">            tab </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> initTable</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // æ‰¾è¯¥ hash å€¼å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¾—åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ f</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((f </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> tabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> hash)) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // å¦‚æœæ•°ç»„è¯¥ä½ç½®ä¸ºç©ºï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //    ç”¨ä¸€æ¬¡ CAS æ“ä½œå°†è¿™ä¸ªæ–°å€¼æ”¾å…¥å…¶ä¸­å³å¯ï¼Œè¿™ä¸ª put æ“ä½œå·®ä¸å¤šå°±ç»“æŸäº†ï¼Œå¯ä»¥æ‹‰åˆ°æœ€åé¢äº†</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //          å¦‚æœ CAS å¤±è´¥ï¼Œé‚£å°±æ˜¯æœ‰å¹¶å‘æ“ä½œï¼Œè¿›åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯å°±å¥½äº†</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">casTabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#C678DD;">                         new</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)))</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;">                   // no lock when adding to empty bin</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // hash å±…ç„¶å¯ä»¥ç­‰äº MOVEDï¼Œè¿™ä¸ªéœ€è¦åˆ°åé¢æ‰èƒ½çœ‹æ˜ç™½ï¼Œä¸è¿‡ä»åå­—ä¸Šä¹Ÿèƒ½çŒœåˆ°ï¼Œè‚¯å®šæ˜¯å› ä¸ºåœ¨æ‰©å®¹</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((fh </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> f</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> MOVED)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // å¸®åŠ©æ•°æ®è¿ç§»ï¼Œè¿™ä¸ªç­‰åˆ°çœ‹å®Œæ•°æ®è¿ç§»éƒ¨åˆ†çš„ä»‹ç»åï¼Œå†ç†è§£è¿™ä¸ªå°±å¾ˆç®€å•äº†</span></span>
<span class="line"><span style="color:#E06C75;">            tab </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> helpTransfer</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> f)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#E06C75;"> { </span><span style="color:#7F848E;font-style:italic;">// åˆ°è¿™é‡Œå°±æ˜¯è¯´ï¼Œf æ˜¯è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹ï¼Œè€Œä¸”ä¸ä¸ºç©º</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">            V</span><span style="color:#E06C75;"> oldVal </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // è·å–æ•°ç»„è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹çš„ç›‘è§†å™¨é”</span></span>
<span class="line"><span style="color:#C678DD;">            synchronized</span><span style="color:#E06C75;"> (f) {</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">tabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> f) {</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (fh </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) { </span><span style="color:#7F848E;font-style:italic;">// å¤´èŠ‚ç‚¹çš„ hash å€¼å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // ç”¨äºç´¯åŠ ï¼Œè®°å½•é“¾è¡¨çš„é•¿åº¦</span></span>
<span class="line"><span style="color:#E06C75;">                        binCount </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // éå†é“¾è¡¨</span></span>
<span class="line"><span style="color:#C678DD;">                        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> f</span><span style="color:#ABB2BF;">;;</span><span style="color:#ABB2BF;"> ++</span><span style="color:#E06C75;">binCount) {</span></span>
<span class="line"><span style="color:#E5C07B;">                            K</span><span style="color:#E06C75;"> ek</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                            // å¦‚æœå‘ç°äº†&quot;ç›¸ç­‰&quot;çš„ keyï¼Œåˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œå€¼è¦†ç›–ï¼Œç„¶åä¹Ÿå°±å¯ä»¥ break äº†</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> hash </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                                ((ek </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> key </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#E06C75;">                                 (ek </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(ek)</span><span style="color:#E06C75;">))) {</span></span>
<span class="line"><span style="color:#E06C75;">                                oldVal </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                                if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#E5C07B;">                                    e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                            // åˆ°äº†é“¾è¡¨çš„æœ€æœ«ç«¯ï¼Œå°†è¿™ä¸ªæ–°å€¼æ”¾åˆ°é“¾è¡¨çš„æœ€åé¢</span></span>
<span class="line"><span style="color:#E5C07B;">                            Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> pred </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> e</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> ((e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                                pred</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> key</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">                                                          value</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            }</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#C678DD;">                    else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (f </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> TreeBin) { </span><span style="color:#7F848E;font-style:italic;">// çº¢é»‘æ ‘</span></span>
<span class="line"><span style="color:#E5C07B;">                        Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        binCount </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // è°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•æ’å…¥æ–°èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> ((p </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">TreeBin</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)f)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putTreeVal</span><span style="color:#ABB2BF;">(hash, key,</span></span>
<span class="line"><span style="color:#ABB2BF;">                                                       value)</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">                            oldVal </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#E5C07B;">                                p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (binCount </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // åˆ¤æ–­æ˜¯å¦è¦å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œä¸´ç•Œå€¼å’Œ HashMap ä¸€æ ·ï¼Œä¹Ÿæ˜¯ 8</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (binCount </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> TREEIFY_THRESHOLD)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // è¿™ä¸ªæ–¹æ³•å’Œ HashMap ä¸­ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ä¸åŒï¼Œé‚£å°±æ˜¯å®ƒä¸æ˜¯ä¸€å®šä¼šè¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©è¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    //    å…·ä½“æºç æˆ‘ä»¬å°±ä¸çœ‹äº†ï¼Œæ‰©å®¹éƒ¨åˆ†åé¢è¯´</span></span>
<span class="line"><span style="color:#61AFEF;">                    treeifyBin</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (oldVal </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#E06C75;"> oldVal</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // </span></span>
<span class="line"><span style="color:#61AFEF;">    addCount</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">1L</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> binCount)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åˆå§‹åŒ–æ•°ç»„-inittable" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–æ•°ç»„-inittable"><span><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84-inittable">#</a> åˆå§‹åŒ–æ•°ç»„: initTable</span></a></h3><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ï¼Œç„¶åä¼šè®¾ç½® sizeCtlã€‚</p><p>åˆå§‹åŒ–æ–¹æ³•ä¸­çš„å¹¶å‘é—®é¢˜æ˜¯é€šè¿‡å¯¹ sizeCtl è¿›è¡Œä¸€ä¸ª CAS æ“ä½œæ¥æ§åˆ¶çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> Node</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[] </span><span style="color:#61AFEF;">initTable</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">    Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] tab</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> sc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    while</span><span style="color:#E06C75;"> ((tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> table) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // åˆå§‹åŒ–çš„&quot;åŠŸåŠ³&quot;è¢«å…¶ä»–çº¿ç¨‹&quot;æŠ¢å»&quot;äº†</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((sc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> sizeCtl) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">            Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">yield</span><span style="color:#ABB2BF;">();</span><span style="color:#7F848E;font-style:italic;"> // lost initialization race; just spin</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // CAS ä¸€ä¸‹ï¼Œå°† sizeCtl è®¾ç½®ä¸º -1ï¼Œä»£è¡¨æŠ¢åˆ°äº†é”</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, SIZECTL, sc, </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> table) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // DEFAULT_CAPACITY é»˜è®¤åˆå§‹å®¹é‡æ˜¯ 16</span></span>
<span class="line"><span style="color:#C678DD;">                    int</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (sc </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> sc </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> DEFAULT_CAPACITY</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // åˆå§‹åŒ–æ•°ç»„ï¼Œé•¿åº¦ä¸º 16 æˆ–åˆå§‹åŒ–æ—¶æä¾›çš„é•¿åº¦</span></span>
<span class="line"><span style="color:#E5C07B;">                    Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] nt </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[])</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[n]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å°†è¿™ä¸ªæ•°ç»„èµ‹å€¼ç»™ tableï¼Œtable æ˜¯ volatile çš„</span></span>
<span class="line"><span style="color:#E06C75;">                    table </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nt</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å¦‚æœ n ä¸º 16 çš„è¯ï¼Œé‚£ä¹ˆè¿™é‡Œ sc = 12</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å…¶å®å°±æ˜¯ 0.75 * n</span></span>
<span class="line"><span style="color:#E06C75;">                    sc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 2</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // è®¾ç½® sizeCtl ä¸º scï¼Œæˆ‘ä»¬å°±å½“æ˜¯ 12 å§</span></span>
<span class="line"><span style="color:#E06C75;">                sizeCtl </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> sc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> tab</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifybin" tabindex="-1"><a class="header-anchor" href="#é“¾è¡¨è½¬çº¢é»‘æ ‘-treeifybin"><span><a href="#%E9%93%BE%E8%A1%A8%E8%BD%AC%E7%BA%A2%E9%BB%91%E6%A0%91-treeifybin">#</a> é“¾è¡¨è½¬çº¢é»‘æ ‘: treeifyBin</span></a></h3><p>å‰é¢æˆ‘ä»¬åœ¨ put æºç åˆ†æä¹Ÿè¯´è¿‡ï¼ŒtreeifyBin ä¸ä¸€å®šå°±ä¼šè¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»…ä»…åšæ•°ç»„æ‰©å®¹ã€‚æˆ‘ä»¬è¿˜æ˜¯è¿›è¡Œæºç åˆ†æå§ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> treeifyBin</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Node</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[] tab</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> index) {</span></span>
<span class="line"><span style="color:#E5C07B;">    Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (tab </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // MIN_TREEIFY_CAPACITY ä¸º 64</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // æ‰€ä»¥ï¼Œå¦‚æœæ•°ç»„é•¿åº¦å°äº 64 çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ 32 æˆ–è€… 16 æˆ–è€…æ›´å°çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œæ•°ç»„æ‰©å®¹</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((n </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;"> MIN_TREEIFY_CAPACITY)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // åé¢æˆ‘ä»¬å†è¯¦ç»†åˆ†æè¿™ä¸ªæ–¹æ³•</span></span>
<span class="line"><span style="color:#61AFEF;">            tryPresize</span><span style="color:#E06C75;">(n </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // b æ˜¯å¤´èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((b </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> tabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> index)) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> b</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> &gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // åŠ é”</span></span>
<span class="line"><span style="color:#C678DD;">            synchronized</span><span style="color:#E06C75;"> (b) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">tabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> index) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> b) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // ä¸‹é¢å°±æ˜¯éå†é“¾è¡¨ï¼Œå»ºç«‹ä¸€é¢—çº¢é»‘æ ‘</span></span>
<span class="line"><span style="color:#E5C07B;">                    TreeNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> hd </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> tl </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                        TreeNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#C678DD;">                            new</span><span style="color:#E5C07B;"> TreeNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;">                                              null</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">prev</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> tl) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                            hd </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                        else</span></span>
<span class="line"><span style="color:#E5C07B;">                            tl</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        tl </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å°†çº¢é»‘æ ‘è®¾ç½®åˆ°æ•°ç»„ç›¸åº”ä½ç½®ä¸­</span></span>
<span class="line"><span style="color:#61AFEF;">                    setTabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> index</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> TreeBin</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(hd))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ‰©å®¹-trypresize" tabindex="-1"><a class="header-anchor" href="#æ‰©å®¹-trypresize"><span><a href="#%E6%89%A9%E5%AE%B9-trypresize">#</a> æ‰©å®¹: tryPresize</span></a></h3><p>å¦‚æœè¯´ Java8 ConcurrentHashMap çš„æºç ä¸ç®€å•ï¼Œé‚£ä¹ˆè¯´çš„å°±æ˜¯æ‰©å®¹æ“ä½œå’Œè¿ç§»æ“ä½œã€‚</p><p>è¿™ä¸ªæ–¹æ³•è¦å®Œå®Œå…¨å…¨çœ‹æ‡‚è¿˜éœ€è¦çœ‹ä¹‹åçš„ transfer æ–¹æ³•ï¼Œè¯»è€…åº”è¯¥æå‰çŸ¥é“è¿™ç‚¹ã€‚</p><p>è¿™é‡Œçš„æ‰©å®¹ä¹Ÿæ˜¯åšç¿»å€æ‰©å®¹çš„ï¼Œæ‰©å®¹åæ•°ç»„å®¹é‡ä¸ºåŸæ¥çš„ 2 å€ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// é¦–å…ˆè¦è¯´æ˜çš„æ˜¯ï¼Œæ–¹æ³•å‚æ•° size ä¼ è¿›æ¥çš„æ—¶å€™å°±å·²ç»ç¿»äº†å€äº†</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> tryPresize</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> size) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // c: size çš„ 1.5 å€ï¼Œå†åŠ  1ï¼Œå†å¾€ä¸Šå–æœ€è¿‘çš„ 2 çš„ n æ¬¡æ–¹ã€‚</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> c </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (size </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> (MAXIMUM_CAPACITY </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)) </span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> MAXIMUM_CAPACITY </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#61AFEF;">        tableSizeFor</span><span style="color:#E06C75;">(size </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> (size </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> sc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    while</span><span style="color:#E06C75;"> ((sc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> sizeCtl) </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> table</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // è¿™ä¸ª if åˆ†æ”¯å’Œä¹‹å‰è¯´çš„åˆå§‹åŒ–æ•°ç»„çš„ä»£ç åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨ç®¡è¿™å—ä»£ç </span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (tab </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">            n </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (sc </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> c) </span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> sc </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, SIZECTL, sc, </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (table </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> tab) {</span></span>
<span class="line"><span style="color:#ABB2BF;">                        @</span><span style="color:#E5C07B;">SuppressWarnings</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;unchecked&quot;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E5C07B;">                        Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] nt </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[])</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[n]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        table </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nt</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        sc </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 2</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 0.75 * n</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                } </span><span style="color:#C678DD;">finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E06C75;">                    sizeCtl </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> sc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (c </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#E06C75;"> sc </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (tab </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> table) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // æˆ‘æ²¡çœ‹æ‡‚ rs çš„çœŸæ­£å«ä¹‰æ˜¯ä»€ä¹ˆï¼Œä¸è¿‡ä¹Ÿå…³ç³»ä¸å¤§</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> resizeStamp</span><span style="color:#E06C75;">(n)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (sc </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] nt</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((sc </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#E06C75;"> RESIZE_STAMP_SHIFT) </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> sc </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> ||</span></span>
<span class="line"><span style="color:#E06C75;">                    sc </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> rs </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> MAX_RESIZERS </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> (nt </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nextTable) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> ||</span></span>
<span class="line"><span style="color:#E06C75;">                    transferIndex </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">                    break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 2. ç”¨ CAS å°† sizeCtl åŠ  1ï¼Œç„¶åæ‰§è¡Œ transfer æ–¹æ³•</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                //    æ­¤æ—¶ nextTab ä¸ä¸º null</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, SIZECTL, sc, sc </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#61AFEF;">                    transfer</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> nt)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 1. å°† sizeCtl è®¾ç½®ä¸º (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //     æˆ‘æ˜¯æ²¡çœ‹æ‡‚è¿™ä¸ªå€¼çœŸæ­£çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ? ä¸è¿‡å¯ä»¥è®¡ç®—å‡ºæ¥çš„æ˜¯ï¼Œç»“æœæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„è´Ÿæ•°</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            //  è°ƒç”¨ transfer æ–¹æ³•ï¼Œæ­¤æ—¶ nextTab å‚æ•°ä¸º null</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, SIZECTL, sc,</span></span>
<span class="line"><span style="color:#ABB2BF;">                                         (rs </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#ABB2BF;"> RESIZE_STAMP_SHIFT) </span><span style="color:#56B6C2;">+</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#61AFEF;">                transfer</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒåœ¨äº sizeCtl å€¼çš„æ“ä½œï¼Œé¦–å…ˆå°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼Œç„¶åæ‰§è¡Œ transfer(tab, null)ï¼Œå†ä¸‹ä¸€ä¸ªå¾ªç¯å°† sizeCtl åŠ  1ï¼Œå¹¶æ‰§è¡Œ transfer(tab, nt)ï¼Œä¹‹åå¯èƒ½æ˜¯ç»§ç»­ sizeCtl åŠ  1ï¼Œå¹¶æ‰§è¡Œ transfer(tab, nt)ã€‚</p><p>æ‰€ä»¥ï¼Œå¯èƒ½çš„æ“ä½œå°±æ˜¯æ‰§è¡Œ 1 æ¬¡ transfer(tab, null) + å¤šæ¬¡ transfer(tab, nt)ï¼Œè¿™é‡Œæ€ä¹ˆç»“æŸå¾ªç¯çš„éœ€è¦çœ‹å®Œ transfer æºç æ‰æ¸…æ¥šã€‚</p><h3 id="æ•°æ®è¿ç§»-transfer" tabindex="-1"><a class="header-anchor" href="#æ•°æ®è¿ç§»-transfer"><span><a href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB-transfer">#</a> æ•°æ®è¿ç§»: transfer</span></a></h3><p>ä¸‹é¢è¿™ä¸ªæ–¹æ³•æœ‰ç‚¹é•¿ï¼Œå°†åŸæ¥çš„ tab æ•°ç»„çš„å…ƒç´ è¿ç§»åˆ°æ–°çš„ nextTab æ•°ç»„ä¸­ã€‚</p><p>è™½ç„¶æˆ‘ä»¬ä¹‹å‰è¯´çš„ tryPresize æ–¹æ³•ä¸­å¤šæ¬¡è°ƒç”¨ transfer ä¸æ¶‰åŠå¤šçº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ª transfer æ–¹æ³•å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è¢«è°ƒç”¨ï¼Œå…¸å‹åœ°ï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨è¯´ put æ–¹æ³•çš„æ—¶å€™å°±è¯´è¿‡äº†ï¼Œè¯·å¾€ä¸Šçœ‹ put æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸ªåœ°æ–¹è°ƒç”¨äº† helpTransfer æ–¹æ³•ï¼ŒhelpTransfer æ–¹æ³•ä¼šè°ƒç”¨ transfer æ–¹æ³•çš„ã€‚</p><p>æ­¤æ–¹æ³•æ”¯æŒå¤šçº¿ç¨‹æ‰§è¡Œï¼Œå¤–å›´è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šä¿è¯ç¬¬ä¸€ä¸ªå‘èµ·æ•°æ®è¿ç§»çš„çº¿ç¨‹ï¼ŒnextTab å‚æ•°ä¸º nullï¼Œä¹‹åå†è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™ï¼ŒnextTab ä¸ä¼šä¸º nullã€‚</p><p>é˜…è¯»æºç ä¹‹å‰ï¼Œå…ˆè¦ç†è§£å¹¶å‘æ“ä½œçš„æœºåˆ¶ã€‚åŸæ•°ç»„é•¿åº¦ä¸º nï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ n ä¸ªè¿ç§»ä»»åŠ¡ï¼Œè®©æ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è´Ÿè´£ä¸€ä¸ªå°ä»»åŠ¡æ˜¯æœ€ç®€å•çš„ï¼Œæ¯åšå®Œä¸€ä¸ªä»»åŠ¡å†æ£€æµ‹æ˜¯å¦æœ‰å…¶ä»–æ²¡åšå®Œçš„ä»»åŠ¡ï¼Œå¸®åŠ©è¿ç§»å°±å¯ä»¥äº†ï¼Œè€Œ Doug Lea ä½¿ç”¨äº†ä¸€ä¸ª strideï¼Œç®€å•ç†è§£å°±æ˜¯æ­¥é•¿ï¼Œæ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è´Ÿè´£è¿ç§»å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æ¯æ¬¡è¿ç§» 16 ä¸ªå°ä»»åŠ¡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªå…¨å±€çš„è°ƒåº¦è€…æ¥å®‰æ’å“ªä¸ªçº¿ç¨‹æ‰§è¡Œå“ªå‡ ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªå°±æ˜¯å±æ€§ transferIndex çš„ä½œç”¨ã€‚</p><p>ç¬¬ä¸€ä¸ªå‘èµ·æ•°æ®è¿ç§»çš„çº¿ç¨‹ä¼šå°† transferIndex æŒ‡å‘åŸæ•°ç»„æœ€åçš„ä½ç½®ï¼Œç„¶åä»åå¾€å‰çš„ stride ä¸ªä»»åŠ¡å±äºç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åå°† transferIndex æŒ‡å‘æ–°çš„ä½ç½®ï¼Œå†å¾€å‰çš„ stride ä¸ªä»»åŠ¡å±äºç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œä¾æ­¤ç±»æ¨ã€‚å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ç¬¬äºŒä¸ªçº¿ç¨‹ä¸æ˜¯çœŸçš„ä¸€å®šæŒ‡ä»£äº†ç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªè¯»è€…åº”è¯¥èƒ½ç†è§£å§ã€‚å…¶å®å°±æ˜¯å°†ä¸€ä¸ªå¤§çš„è¿ç§»ä»»åŠ¡åˆ†ä¸ºäº†ä¸€ä¸ªä¸ªä»»åŠ¡åŒ…ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> transfer</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Node</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[] tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Node</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[] nextTab) {</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> stride</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // stride åœ¨å•æ ¸ä¸‹ç›´æ¥ç­‰äº nï¼Œå¤šæ ¸æ¨¡å¼ä¸‹ä¸º (n&gt;&gt;&gt;3)/NCPUï¼Œæœ€å°å€¼æ˜¯ 16</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // stride å¯ä»¥ç†è§£ä¸ºâ€æ­¥é•¿â€œï¼Œæœ‰ n ä¸ªä½ç½®æ˜¯éœ€è¦è¿›è¡Œè¿ç§»çš„ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //   å°†è¿™ n ä¸ªä»»åŠ¡åˆ†ä¸ºå¤šä¸ªä»»åŠ¡åŒ…ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…æœ‰ stride ä¸ªä»»åŠ¡</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((stride </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (NCPU </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 3</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">/</span><span style="color:#E06C75;"> NCPU </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> n) </span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;"> MIN_TRANSFER_STRIDE)</span></span>
<span class="line"><span style="color:#E06C75;">        stride </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> MIN_TRANSFER_STRIDE</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // subdivide range</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // å¦‚æœ nextTab ä¸º nullï¼Œå…ˆè¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //    å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œå¤–å›´ä¼šä¿è¯ç¬¬ä¸€ä¸ªå‘èµ·è¿ç§»çš„çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œå‚æ•° nextTab ä¸º null</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //       ä¹‹åå‚ä¸è¿ç§»çš„çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼ŒnextTab ä¸ä¼šä¸º null</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (nextTab </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // å®¹é‡ç¿»å€</span></span>
<span class="line"><span style="color:#E5C07B;">            Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] nt </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[])</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[n </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">]</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            nextTab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nt</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        } </span><span style="color:#C678DD;">catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {      </span><span style="color:#7F848E;font-style:italic;">// try to cope with OOME</span></span>
<span class="line"><span style="color:#E06C75;">            sizeCtl </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Integer</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">MAX_VALUE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // nextTable æ˜¯ ConcurrentHashMap ä¸­çš„å±æ€§</span></span>
<span class="line"><span style="color:#E06C75;">        nextTable </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nextTab</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // transferIndex ä¹Ÿæ˜¯ ConcurrentHashMap çš„å±æ€§ï¼Œç”¨äºæ§åˆ¶è¿ç§»çš„ä½ç½®</span></span>
<span class="line"><span style="color:#E06C75;">        transferIndex </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> nextn </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> nextTab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ForwardingNode ç¿»è¯‘è¿‡æ¥å°±æ˜¯æ­£åœ¨è¢«è¿ç§»çš„ Node</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // è¿™ä¸ªæ„é€ æ–¹æ³•ä¼šç”Ÿæˆä¸€ä¸ªNodeï¼Œkeyã€value å’Œ next éƒ½ä¸º nullï¼Œå…³é”®æ˜¯ hash ä¸º MOVED</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒåŸæ•°ç»„ä¸­ä½ç½® i å¤„çš„èŠ‚ç‚¹å®Œæˆè¿ç§»å·¥ä½œåï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //    å°±ä¼šå°†ä½ç½® i å¤„è®¾ç½®ä¸ºè¿™ä¸ª ForwardingNodeï¼Œç”¨æ¥å‘Šè¯‰å…¶ä»–çº¿ç¨‹è¯¥ä½ç½®å·²ç»å¤„ç†è¿‡äº†</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //    æ‰€ä»¥å®ƒå…¶å®ç›¸å½“äºæ˜¯ä¸€ä¸ªæ ‡å¿—ã€‚</span></span>
<span class="line"><span style="color:#E5C07B;">    ForwardingNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> fwd </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ForwardingNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(nextTab)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // advance æŒ‡çš„æ˜¯åšå®Œäº†ä¸€ä¸ªä½ç½®çš„è¿ç§»å·¥ä½œï¼Œå¯ä»¥å‡†å¤‡åšä¸‹ä¸€ä¸ªä½ç½®çš„äº†</span></span>
<span class="line"><span style="color:#C678DD;">    boolean</span><span style="color:#E06C75;"> advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    boolean</span><span style="color:#E06C75;"> finishing </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // to ensure sweep before committing nextTab</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    /*</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">     * ä¸‹é¢è¿™ä¸ª for å¾ªç¯ï¼Œæœ€éš¾ç†è§£çš„åœ¨å‰é¢ï¼Œè€Œè¦çœ‹æ‡‚å®ƒä»¬ï¼Œåº”è¯¥å…ˆçœ‹æ‡‚åé¢çš„ï¼Œç„¶åå†å€’å›æ¥çœ‹</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">     * </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // i æ˜¯ä½ç½®ç´¢å¼•ï¼Œbound æ˜¯è¾¹ç•Œï¼Œæ³¨æ„æ˜¯ä»åå¾€å‰</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> bound </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;;</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> f</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> fh</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // ä¸‹é¢è¿™ä¸ª while çœŸçš„æ˜¯ä¸å¥½ç†è§£</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // advance ä¸º true è¡¨ç¤ºå¯ä»¥è¿›è¡Œä¸‹ä¸€ä¸ªä½ç½®çš„è¿ç§»äº†</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        //   ç®€å•ç†è§£ç»“å±€: i æŒ‡å‘äº† transferIndexï¼Œbound æŒ‡å‘äº† transferIndex-stride</span></span>
<span class="line"><span style="color:#C678DD;">        while</span><span style="color:#E06C75;"> (advance) {</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> nextIndex</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> nextBound</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#ABB2BF;">--</span><span style="color:#E06C75;">i </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> bound </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> finishing)</span></span>
<span class="line"><span style="color:#E06C75;">                advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // å°† transferIndex å€¼èµ‹ç»™ nextIndex</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // è¿™é‡Œ transferIndex ä¸€æ—¦å°äºç­‰äº 0ï¼Œè¯´æ˜åŸæ•°ç»„çš„æ‰€æœ‰ä½ç½®éƒ½æœ‰ç›¸åº”çš„çº¿ç¨‹å»å¤„ç†äº†</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((nextIndex </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> transferIndex) </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">                i </span><span style="color:#56B6C2;">=</span><span style="color:#56B6C2;"> -</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">compareAndSwapInt</span></span>
<span class="line"><span style="color:#E06C75;">                     (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> TRANSFERINDEX</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> nextIndex</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">                      nextBound </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (nextIndex </span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> stride </span><span style="color:#C678DD;">?</span></span>
<span class="line"><span style="color:#E06C75;">                                   nextIndex </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> stride </span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">))) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // çœ‹æ‹¬å·ä¸­çš„ä»£ç ï¼ŒnextBound æ˜¯è¿™æ¬¡è¿ç§»ä»»åŠ¡çš„è¾¹ç•Œï¼Œæ³¨æ„ï¼Œæ˜¯ä»åå¾€å‰</span></span>
<span class="line"><span style="color:#E06C75;">                bound </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nextBound</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nextIndex </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (i </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> ||</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> n </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#E06C75;"> nextn) {</span></span>
<span class="line"><span style="color:#C678DD;">            int</span><span style="color:#E06C75;"> sc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (finishing) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // æ‰€æœ‰çš„è¿ç§»æ“ä½œå·²ç»å®Œæˆ</span></span>
<span class="line"><span style="color:#E06C75;">                nextTable </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // å°†æ–°çš„ nextTab èµ‹å€¼ç»™ table å±æ€§ï¼Œå®Œæˆè¿ç§»</span></span>
<span class="line"><span style="color:#E06C75;">                table </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> nextTab</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // é‡æ–°è®¡ç®— sizeCtl: n æ˜¯åŸæ•°ç»„é•¿åº¦ï¼Œæ‰€ä»¥ sizeCtl å¾—å‡ºçš„å€¼å°†æ˜¯æ–°æ•°ç»„é•¿åº¦çš„ 0.75 å€</span></span>
<span class="line"><span style="color:#E06C75;">                sizeCtl </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">-</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">&gt;&gt;&gt;</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒsizeCtl åœ¨è¿ç§»å‰ä¼šè®¾ç½®ä¸º (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // ç„¶åï¼Œæ¯æœ‰ä¸€ä¸ªçº¿ç¨‹å‚ä¸è¿ç§»å°±ä¼šå°† sizeCtl åŠ  1ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // è¿™é‡Œä½¿ç”¨ CAS æ“ä½œå¯¹ sizeCtl è¿›è¡Œå‡ 1ï¼Œä»£è¡¨åšå®Œäº†å±äºè‡ªå·±çš„ä»»åŠ¡</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">U</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSwapInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, SIZECTL, sc </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> sizeCtl, sc </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // ä»»åŠ¡ç»“æŸï¼Œæ–¹æ³•é€€å‡º</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> ((sc </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 2</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#61AFEF;"> resizeStamp</span><span style="color:#E06C75;">(n) </span><span style="color:#56B6C2;">&lt;&lt;</span><span style="color:#E06C75;"> RESIZE_STAMP_SHIFT)</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // åˆ°è¿™é‡Œï¼Œè¯´æ˜ (sc - 2) == resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFTï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„è¿ç§»ä»»åŠ¡éƒ½åšå®Œäº†ï¼Œä¹Ÿå°±ä¼šè¿›å…¥åˆ°ä¸Šé¢çš„ if(finishing){} åˆ†æ”¯äº†</span></span>
<span class="line"><span style="color:#E06C75;">                finishing </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                i </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // recheck before commit</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // å¦‚æœä½ç½® i å¤„æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰ä»»ä½•èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ”¾å…¥åˆšåˆšåˆå§‹åŒ–çš„ ForwardingNode â€ç©ºèŠ‚ç‚¹â€œ</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((f </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> tabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i)) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">            advance </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> casTabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> fwd)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // è¯¥ä½ç½®å¤„æ˜¯ä¸€ä¸ª ForwardingNodeï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»è¿‡äº†</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> ((fh </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> f</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> MOVED)</span></span>
<span class="line"><span style="color:#E06C75;">            advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // already processed</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // å¯¹æ•°ç»„è¯¥ä½ç½®å¤„çš„ç»“ç‚¹åŠ é”ï¼Œå¼€å§‹å¤„ç†æ•°ç»„è¯¥ä½ç½®å¤„çš„è¿ç§»å·¥ä½œ</span></span>
<span class="line"><span style="color:#C678DD;">            synchronized</span><span style="color:#E06C75;"> (f) {</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">tabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> f) {</span></span>
<span class="line"><span style="color:#E5C07B;">                    Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> ln</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hn</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // å¤´èŠ‚ç‚¹çš„ hash å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨çš„ Node èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#C678DD;">                    if</span><span style="color:#E06C75;"> (fh </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // ä¸‹é¢è¿™ä¸€å—å’Œ Java7 ä¸­çš„ ConcurrentHashMap è¿ç§»æ˜¯å·®ä¸å¤šçš„ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // éœ€è¦å°†é“¾è¡¨ä¸€åˆ†ä¸ºäºŒï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        //   æ‰¾åˆ°åŸé“¾è¡¨ä¸­çš„ lastRunï¼Œç„¶å lastRun åŠå…¶ä¹‹åçš„èŠ‚ç‚¹æ˜¯ä¸€èµ·è¿›è¡Œè¿ç§»çš„</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        //   lastRun ä¹‹å‰çš„èŠ‚ç‚¹éœ€è¦è¿›è¡Œå…‹éš†ï¼Œç„¶ååˆ†åˆ°ä¸¤ä¸ªé“¾è¡¨ä¸­</span></span>
<span class="line"><span style="color:#C678DD;">                        int</span><span style="color:#E06C75;"> runBit </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> fh </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                        Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> lastRun </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> f</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> f</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                            int</span><span style="color:#E06C75;"> b </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> &amp;</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> (b </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> runBit) {</span></span>
<span class="line"><span style="color:#E06C75;">                                runBit </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> b</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                                lastRun </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            }</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#C678DD;">                        if</span><span style="color:#E06C75;"> (runBit </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">                            ln </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> lastRun</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            hn </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#C678DD;">                        else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E06C75;">                            hn </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> lastRun</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            ln </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#C678DD;">                        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> f</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">!=</span><span style="color:#E06C75;"> lastRun</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                            int</span><span style="color:#E06C75;"> ph </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> K</span><span style="color:#E06C75;"> pk </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> V</span><span style="color:#E06C75;"> pv </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> ((ph </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> n) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                                ln </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(ph</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> pk</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> pv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ln)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                            else</span></span>
<span class="line"><span style="color:#E06C75;">                                hn </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(ph</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> pk</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> pv</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hn)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // å…¶ä¸­çš„ä¸€ä¸ªé“¾è¡¨æ”¾åœ¨æ–°æ•°ç»„çš„ä½ç½® i</span></span>
<span class="line"><span style="color:#61AFEF;">                        setTabAt</span><span style="color:#E06C75;">(nextTab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ln)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // å¦ä¸€ä¸ªé“¾è¡¨æ”¾åœ¨æ–°æ•°ç»„çš„ä½ç½® i+n</span></span>
<span class="line"><span style="color:#61AFEF;">                        setTabAt</span><span style="color:#E06C75;">(nextTab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hn)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // å°†åŸæ•°ç»„è¯¥ä½ç½®å¤„è®¾ç½®ä¸º fwdï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»å¤„ç†å®Œæ¯•ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        //    å…¶ä»–çº¿ç¨‹ä¸€æ—¦çœ‹åˆ°è¯¥ä½ç½®çš„ hash å€¼ä¸º MOVEDï¼Œå°±ä¸ä¼šè¿›è¡Œè¿ç§»äº†</span></span>
<span class="line"><span style="color:#61AFEF;">                        setTabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> fwd)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // advance è®¾ç½®ä¸º trueï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»å®Œæ¯•</span></span>
<span class="line"><span style="color:#E06C75;">                        advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#C678DD;">                    else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (f </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> TreeBin) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // çº¢é»‘æ ‘çš„è¿ç§»</span></span>
<span class="line"><span style="color:#E5C07B;">                        TreeBin</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> t </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">TreeBin</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;">V</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">)f</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                        TreeNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> lo </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> loTail </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                        TreeNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> hi </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hiTail </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                        int</span><span style="color:#E06C75;"> lc </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hc </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> t</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">first</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;"> e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                            int</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">                            TreeNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> p </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> TreeNode</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#E06C75;">                                (h</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                            if</span><span style="color:#E06C75;"> ((h </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> n) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                                if</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">prev</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> loTail) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                                    lo </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                                else</span></span>
<span class="line"><span style="color:#E5C07B;">                                    loTail</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                                loTail </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                                ++</span><span style="color:#E06C75;">lc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            }</span></span>
<span class="line"><span style="color:#C678DD;">                            else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#C678DD;">                                if</span><span style="color:#E06C75;"> ((</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">prev</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> hiTail) </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#E06C75;">                                    hi </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">                                else</span></span>
<span class="line"><span style="color:#E5C07B;">                                    hiTail</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                                hiTail </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                                ++</span><span style="color:#E06C75;">hc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                            }</span></span>
<span class="line"><span style="color:#E06C75;">                        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // å¦‚æœä¸€åˆ†ä¸ºäºŒåï¼ŒèŠ‚ç‚¹æ•°å°äºç­‰äº6ï¼Œé‚£ä¹ˆå°†çº¢é»‘æ ‘è½¬æ¢å›é“¾è¡¨</span></span>
<span class="line"><span style="color:#E06C75;">                        ln </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (lc </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#E06C75;"> UNTREEIFY_THRESHOLD) </span><span style="color:#C678DD;">?</span><span style="color:#61AFEF;"> untreeify</span><span style="color:#E06C75;">(lo) </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#E06C75;">                            (hc </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> TreeBin</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(lo) </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                        hn </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (hc </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#E06C75;"> UNTREEIFY_THRESHOLD) </span><span style="color:#C678DD;">?</span><span style="color:#61AFEF;"> untreeify</span><span style="color:#E06C75;">(hi) </span><span style="color:#C678DD;">:</span></span>
<span class="line"><span style="color:#E06C75;">                            (lc </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> TreeBin</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">(hi) </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> t</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // å°† ln æ”¾ç½®åœ¨æ–°æ•°ç»„çš„ä½ç½® i</span></span>
<span class="line"><span style="color:#61AFEF;">                        setTabAt</span><span style="color:#E06C75;">(nextTab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ln)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // å°† hn æ”¾ç½®åœ¨æ–°æ•°ç»„çš„ä½ç½® i+n</span></span>
<span class="line"><span style="color:#61AFEF;">                        setTabAt</span><span style="color:#E06C75;">(nextTab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i </span><span style="color:#56B6C2;">+</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> hn)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // å°†åŸæ•°ç»„è¯¥ä½ç½®å¤„è®¾ç½®ä¸º fwdï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»å¤„ç†å®Œæ¯•ï¼Œ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        //    å…¶ä»–çº¿ç¨‹ä¸€æ—¦çœ‹åˆ°è¯¥ä½ç½®çš„ hash å€¼ä¸º MOVEDï¼Œå°±ä¸ä¼šè¿›è¡Œè¿ç§»äº†</span></span>
<span class="line"><span style="color:#61AFEF;">                        setTabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> fwd)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // advance è®¾ç½®ä¸º trueï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»å®Œæ¯•</span></span>
<span class="line"><span style="color:#E06C75;">                        advance </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                    }</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´åˆ°åº•ï¼Œtransfer è¿™ä¸ªæ–¹æ³•å¹¶æ²¡æœ‰å®ç°æ‰€æœ‰çš„è¿ç§»ä»»åŠ¡ï¼Œæ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•åªå®ç°äº† transferIndex å¾€å‰ stride ä¸ªä½ç½®çš„è¿ç§»å·¥ä½œï¼Œå…¶ä»–çš„éœ€è¦ç”±å¤–å›´æ¥æ§åˆ¶ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œå†å›å»ä»”ç»†çœ‹ tryPresize æ–¹æ³•å¯èƒ½å°±ä¼šæ›´åŠ æ¸…æ™°ä¸€äº›äº†ã€‚</p><h3 id="get-è¿‡ç¨‹åˆ†æ-1" tabindex="-1"><a class="header-anchor" href="#get-è¿‡ç¨‹åˆ†æ-1"><span><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-1">#</a> get è¿‡ç¨‹åˆ†æ</span></a></h3><p>get æ–¹æ³•ä»æ¥éƒ½æ˜¯æœ€ç®€å•çš„ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–:</p><ul><li>è®¡ç®— hash å€¼</li><li>æ ¹æ® hash å€¼æ‰¾åˆ°æ•°ç»„å¯¹åº”ä½ç½®: (n - 1) &amp; h</li><li>æ ¹æ®è¯¥ä½ç½®å¤„ç»“ç‚¹æ€§è´¨è¿›è¡Œç›¸åº”æŸ¥æ‰¾ <ul><li>å¦‚æœè¯¥ä½ç½®ä¸º nullï¼Œé‚£ä¹ˆç›´æ¥è¿”å› null å°±å¯ä»¥äº†</li><li>å¦‚æœè¯¥ä½ç½®å¤„çš„èŠ‚ç‚¹åˆšå¥½å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œè¿”å›è¯¥èŠ‚ç‚¹çš„å€¼å³å¯</li><li>å¦‚æœè¯¥ä½ç½®èŠ‚ç‚¹çš„ hash å€¼å°äº 0ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹ï¼Œæˆ–è€…æ˜¯çº¢é»‘æ ‘ï¼Œåé¢æˆ‘ä»¬å†ä»‹ç» find æ–¹æ³•</li><li>å¦‚æœä»¥ä¸Š 3 æ¡éƒ½ä¸æ»¡è¶³ï¼Œé‚£å°±æ˜¯é“¾è¡¨ï¼Œè¿›è¡Œéå†æ¯”å¯¹å³å¯</li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#E5C07B;"> V</span><span style="color:#61AFEF;"> get</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Object</span><span style="color:#E06C75;"> key) {</span></span>
<span class="line"><span style="color:#E5C07B;">    Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] tab</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> Node</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">K</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">V</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> e</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> p</span><span style="color:#ABB2BF;">;</span><span style="color:#C678DD;"> int</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> eh</span><span style="color:#ABB2BF;">;</span><span style="color:#E5C07B;"> K</span><span style="color:#E06C75;"> ek</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> spread</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">hashCode</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> ((tab </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> table) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> tab</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">        (e </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> tabAt</span><span style="color:#E06C75;">(tab</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> (n </span><span style="color:#56B6C2;">-</span><span style="color:#D19A66;"> 1</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">&amp;</span><span style="color:#E06C75;"> h)) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // åˆ¤æ–­å¤´èŠ‚ç‚¹æ˜¯å¦å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> ((eh </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> h) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> ((ek </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> key </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> (ek </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(ek)</span><span style="color:#E06C75;">))</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // å¦‚æœå¤´èŠ‚ç‚¹çš„ hash å°äº 0ï¼Œè¯´æ˜ æ­£åœ¨æ‰©å®¹ï¼Œæˆ–è€…è¯¥ä½ç½®æ˜¯çº¢é»‘æ ‘</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (eh </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // å‚è€ƒ ForwardingNode.find(int h, Object k) å’Œ TreeBin.find(int h, Object k)</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#E06C75;"> (p </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">find</span><span style="color:#ABB2BF;">(h, key)</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#C678DD;"> ?</span><span style="color:#E5C07B;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#C678DD;"> :</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // éå†é“¾è¡¨</span></span>
<span class="line"><span style="color:#C678DD;">        while</span><span style="color:#E06C75;"> ((e </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">next</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">hash</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> h </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E06C75;">                ((ek </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">key</span><span style="color:#E06C75;">) </span><span style="color:#56B6C2;">==</span><span style="color:#E06C75;"> key </span><span style="color:#56B6C2;">||</span><span style="color:#E06C75;"> (ek </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> key</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(ek)</span><span style="color:#E06C75;">)))</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#E5C07B;"> e</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">val</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç®€å•è¯´ä¸€å¥ï¼Œæ­¤æ–¹æ³•çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½å¾ˆç®€å•ï¼Œåªæœ‰æ­£å¥½ç¢°åˆ°æ‰©å®¹çš„æƒ…å†µï¼ŒForwardingNode.find(int h, Object k) ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä¸è¿‡åœ¨äº†è§£äº†æ•°æ®è¿ç§»çš„è¿‡ç¨‹åï¼Œè¿™ä¸ªä¹Ÿå°±ä¸éš¾äº†ï¼Œæ‰€ä»¥é™äºç¯‡å¹…è¿™é‡Œä¹Ÿä¸å±•å¼€è¯´äº†ã€‚</p><h2 id="å¯¹æ¯”æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å¯¹æ¯”æ€»ç»“"><span><a href="#%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93">#</a> å¯¹æ¯”æ€»ç»“</span></a></h2><ul><li><code>HashTable</code> : ä½¿ç”¨äº†synchronizedå…³é”®å­—å¯¹putç­‰æ“ä½œè¿›è¡ŒåŠ é”;</li><li><code>ConcurrentHashMap JDK1.7</code>: ä½¿ç”¨åˆ†æ®µé”æœºåˆ¶å®ç°;</li><li><code>ConcurrentHashMap JDK1.8</code>: åˆ™ä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘æ•°æ®ç»“æ„å’ŒCASåŸå­æ“ä½œå®ç°;</li></ul></div><!--[--><div class="sponsor" data-v-3ae5c108><div id="drinks-box" data-v-3ae5c108><div id="drinks-box-s" class="drinks-button left-100" data-v-3ae5c108><div id="drinks-icons" class="left-100 tr3" data-v-3ae5c108><div id="coffee-donate" class="icon-donate" data-v-3ae5c108><span class="font-icon icon iconfont icon-hk-flutter" data-v-3ae5c108></span> èµåŠ© </div></div><div id="drinks-button-box" class="tr3 left-100" data-v-3ae5c108><div id="drinks-button-bg" class="left-100" data-v-3ae5c108></div><div id="github-box" data-v-3ae5c108><a href="https://github.com/lixuanfengs/Cactus" target="_blank" data-v-3ae5c108>Github</a></div><ul id="donate-buttons" class="list tr3" data-v-3ae5c108><li id="paypal_donate" data-v-3ae5c108><a href="https://www.paypal.me/oragekk" target="_blank" data-v-3ae5c108>Paypal</a></li><!-- <li id="btc_donate" class="donate-button">Bitcoin</li> --><li id="alipay_donate" class="donate-button" data-v-3ae5c108>AliPay</li><li id="wechat_donate" class="donate-button2" data-v-3ae5c108>WeChat</li></ul></div><div id="drinks-qrcodes" class="left-100 tr3" data-v-3ae5c108><div id="drinks-qrcode" data-v-3ae5c108></div></div></div></div></div><!--]--><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="vp-link vp-meta-label" href="https://github.com/lixuanfengs/Cactus/edit/main/src/posts/Java/ThreadConcurrency/JUC é›†åˆä¹‹ ConcurrentHashMap è¯¦è§£.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 1183895890@qq.com">lixuanfengs</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link vp-link prev" href="/posts/Java/ThreadConcurrency/JUC%20%E9%94%81%E4%B9%8B%20ReentrantReadWriteLock%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é”ä¹‹ ReentrantReadWriteLock è¯¦è§£"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->JUC é”ä¹‹ ReentrantReadWriteLock è¯¦è§£</div></a><a class="route-link vp-link next" href="/posts/Java/ThreadConcurrency/JUC%20%E9%9B%86%E5%90%88%E4%B9%8B%20CopyOnWriteArrayList%20%E8%AF%A6%E8%A7%A3.html" aria-label="JUC é›†åˆä¹‹ CopyOnWriteArrayList è¯¦è§£"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">JUC é›†åˆä¹‹ CopyOnWriteArrayList è¯¦è§£<!----></div></a></nav><div id="vp-comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><div class="wl-reaction"><div class="wl-reaction-title">ä½ è®¤ä¸ºè¿™ç¯‡æ–‡ç« æ€ä¹ˆæ ·ï¼Ÿ</div><ul class="wl-reaction-list"><!--[--><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_agree.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_look_down.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sunglasses.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_pick_nose.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_awkward.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sleep.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><!--]--></ul></div><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">æ˜µç§°</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">é‚®ç®±(å¯é€‰)</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">ç½‘å€(å¯é€‰)</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="è¯·ç•™è¨€ã€‚(å¡«å†™é‚®ç®±å¯åœ¨è¢«å›å¤æ—¶æ”¶åˆ°é‚®ä»¶æé†’)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>é¢„è§ˆ:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="è¡¨æƒ…" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="è¡¨æƒ…åŒ…"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="ä¸Šä¼ å›¾ç‰‡"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="é¢„è§ˆ"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <span> Â /Â  <span class="">300</span></span> Â å­—</div><button type="button" class="wl-btn">ç™»å½•</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->æäº¤<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="æœç´¢è¡¨æƒ…åŒ…"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> è¯„è®º</div><ul class="wl-sort"><!--[--><li class="active">æŒ‰æ­£åº</li><li class="">æŒ‰å€’åº</li><li class="">æŒ‰çƒ­åº¦</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.1.3</div></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper" style="display:none;--a5550e7c:;"><div class="busuanzi"><span id="busuanzi_container_site_pv" style="display:none;"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span>æ¬¡ <span class="post-meta-divider">|</span></span><span id="busuanzi_container_site_uv" style="display:none;"> æ‚¨æ˜¯æœ¬ç«™ç¬¬ <span id="busuanzi_value_site_uv"></span>ä½è®¿é—®è€… </span></div><div class="footer-content"><div class="footer">é»˜è®¤é¡µè„š</div><div class="copyright">Copyright Â© 2018-2024 Cactus li</div></div><span id="runtime_span"></span><!--        <div class="footer-link">--><!--            <a href="https://www.foreverblog.cn/go.html" target="_blank">--><!--                <img--><!--                        :src="wormhole"--><!--                        alt=""--><!--                        style="width: auto; height: 32px"--><!--                        title="ç©¿æ¢­è™«æ´-éšæœºè®¿é—®åå¹´ä¹‹çº¦å‹é“¾åšå®¢"--><!--                /></a>--><!--            <a href="https://www.travellings.cn/go.html" target="_blank">--><!--                <img--><!--                        src="https://www.travellings.cn/assets/logo.gif"--><!--                        alt=""--><!--                        style="width: auto; height: 32px"--><!--                        title="å¼€å¾€-å‹é“¾æ¥åŠ›"--><!--                /></a>--><!--            &lt;!&ndash; <a href="https://www.foreverblog.cn/" target="_blank">--><!--              <img src="https://img.foreverblog.cn/logo_en_default.png" alt="" style="width: auto; height: 16px" />--><!--            </a> &ndash;&gt;--><!--        </div>--></footer></div><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DiJfzvPX.js" defer></script>
  </body>
</html>
